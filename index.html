<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltiMed - Cockpit R2C</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="favicon-192x192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 950: '#050505', 900: '#0a0a0a', 800: '#121212', 700: '#1e1e1e' },
                        gold: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                        mono: ['Courier Prime', 'monospace']
                    },
                    animation: {
                        'float': 'float 10s ease-in-out infinite',
                        'pop-in-master': 'popInMaster 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-out': 'fadeOut 0.5s forwards 2.0s', 
                        'sparkle': 'sparkle 2s ease-out infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'dino-bounce': 'dinoBounce 0.4s ease-out infinite alternate',
                        'dino-sleep': 'dinoSleep 2s ease-in-out infinite alternate',
                        'gold-pulse': 'goldPulse 2s infinite',
                        
                        /* --- AJOUT ICI : L'animation violette --- */
                        'purple-pulse': 'purplePulse 2s infinite', 
                        /* --------------------------------------- */

                        'toast-slide': 'toastSlide 0.3s ease-out forwards',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'warp-speed': 'warpSpeed 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)',
                        'spin-slow': 'spin 3s linear infinite',
                        'check-pop': 'checkPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'fade-in-up': 'fadeInUp 0.8s ease-out forwards',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0) scale(1)' }, '50%': { transform: 'translateY(-20px) scale(1.05)' } },
                        popInMaster: {
                            '0%': { opacity: '0', transform: 'scale(0.8) translateY(20px)' },
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' }
                        },
                        fadeOut: { '0%': { opacity: '1' }, '100%': { opacity: '0', visibility: 'hidden' } },
                        sparkle: { '0%': { transform: 'scale(0)', opacity: '0' }, '50%': { transform: 'scale(1)', opacity: '1' }, '100%': { transform: 'scale(0)', opacity: '0' } },
                        dinoBounce: { '0%, 100%': { transform: 'translateY(0) rotate(0deg)' }, '50%': { transform: 'translateY(-8px) rotate(-3deg)' } },
                        dinoSleep: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(3px) scaleX(0.98)' } },
                        
                        goldPulse: { '0%': { boxShadow: '0 0 0 0 rgba(251, 191, 36, 0.4)' }, '70%': { boxShadow: '0 0 0 20px rgba(251, 191, 36, 0)' }, '100%': { boxShadow: '0 0 0 0 rgba(251, 191, 36, 0)' } },
                        
                        /* --- AJOUT ICI : Les keyframes violets --- */
                        purplePulse: { 
                            '0%': { boxShadow: '0 0 0 0 rgba(192, 38, 211, 0.6)' }, 
                            '70%': { boxShadow: '0 0 0 20px rgba(192, 38, 211, 0)' }, 
                            '100%': { boxShadow: '0 0 0 0 rgba(192, 38, 211, 0)' } 
                        },
                        /* --------------------------------------- */

                        toastSlide: { '0%': { transform: 'translateX(100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        shockwave: { '0%': { transform: 'scale(0.8)', opacity: '0.8', borderWidth: '20px' }, '100%': { transform: 'scale(2.5)', opacity: '0', borderWidth: '0' } },
                        screenFlash: { '0%': { opacity: '0.2' }, '100%': { opacity: '0' } },
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 5px rgba(251, 191, 36, 0.2), inset 0 0 5px rgba(251, 191, 36, 0.1)' },
                            '50%': { boxShadow: '0 0 15px rgba(251, 191, 36, 0.5), inset 0 0 10px rgba(251, 191, 36, 0.2)' }
                        },
                        warpSpeed: {
                            '0%': { transform: 'scale(1)', filter: 'blur(0)' },
                            '50%': { transform: 'scale(1.5)', filter: 'blur(4px)', opacity: '0.5' },
                            '100%': { transform: 'scale(1)', filter: 'blur(0)', opacity: '1' }
                        },
                        checkPop: {
                            '0%': { transform: 'scale(0.5)', opacity: '0' },
                            '50%': { transform: 'scale(1.2)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Google Fonts --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@400;600;900&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <!-- Markdown --><script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // 2. CONFIGURATION DE VOTRE PROJET FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAbvWHO46zkGVgTiYBwAYjOW0Lo1LzA4e8",
            authDomain: "ultimed-2d332.firebaseapp.com",
            projectId: "ultimed-2d332",
            storageBucket: "ultimed-2d332.firebasestorage.app",
            messagingSenderId: "944246190546",
            appId: "1:944246190546:web:210e73fd118a955dbe580b",
            measurementId: "G-QS93Y4XXP6"
        };
        
        // 3. INITIALISATION GLOBALE
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <style>

:target::before {
    content: "";
    display: block;
    height: 120px; /* Espace de compensation (Header height + gap) */
    margin-top: -120px; /* Remonter le padding pour ne pas le voir */
    visibility: hidden;
    pointer-events: none;
}

        body { background-color: #050505; color: #e5e7eb; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .depth-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #111, #050505); overflow: hidden; }
        .orb { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.3; animation: float 18s infinite ease-in-out; }
        .orb-1 { top: -20%; left: -10%; width: 60vw; height: 60vw; background: #1e3a8a; animation-delay: 0s; }
        .orb-2 { bottom: -20%; right: -10%; width: 50vw; height: 50vw; background: #4c1d95; animation-delay: -5s; }
        
        /* --- Card Styling --- */
        .card-cinema { background: rgba(20, 20, 20, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .card-cinema:hover { transform: translateY(-6px); border-color: rgba(255, 255, 255, 0.25); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.75); z-index: 20; }
        .card-panel { background: rgba(15, 15, 15, 0.3); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(15px); }
        
        .status-lu { background: rgba(15, 40, 15, 0.5) !important; border-color: rgba(34, 197, 94, 0.3); box-shadow: 0 0 10px rgba(34, 197, 94, 0.1); }
        .status-lu:hover { box-shadow: 0 0 30px rgba(34, 197, 94, 0.3), 0 20px 40px -10px rgba(0, 0, 0, 0.5); border-color: rgba(34, 197, 94, 0.5); }
        .status-maitrise { background: rgba(40, 30, 5, 0.5) !important; border-color: rgba(251, 191, 36, 0.3); box-shadow: 0 0 10px rgba(251, 191, 36, 0.15); }
        .status-maitrise:hover { box-shadow: 0 0 30px rgba(251, 191, 36, 0.5), 0 20px 40px -10px rgba(0, 0, 0, 0.5); border-color: rgba(251, 191, 36, 0.5); }
        .status-legendaire { 
            background: rgba(30, 5, 40, 0.7) !important; /* Fond violet sombre */
            border-color: rgba(168, 85, 247, 0.5) !important; /* Bordure Violette */
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.3); 
        }
        .status-legendaire:hover { 
            box-shadow: 0 0 50px rgba(168, 85, 247, 0.6), 0 20px 40px -10px rgba(0, 0, 0, 0.8); 
            border-color: rgba(168, 85, 247, 0.9) !important; 
            transform: translateY(-8px) scale(1.02);
        }
        
        .modal-backdrop { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(20px); }
        
        /* Custom Select Styling */
        select { 
            -webkit-appearance: none; -moz-appearance: none; appearance: none; 
            background-color: rgba(10, 10, 10, 0.6); backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; 
            border-radius: 12px; color: #e5e7eb; cursor: pointer; padding-right: 30px;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
        }
        select option { background-color: #1a1a1a !important; color: #e5e7eb; }
        select:hover { border-color: rgba(255,255,255,0.25); }
        select:focus { outline: none; border-color: #ffffff; box-shadow: 0 0 15px rgba(255, 255, 255, 0.1); }

        input, textarea { background: rgba(30,30,30,0.5); border-color: #333; color: white; }
        input:focus, select:focus, textarea:focus { border-color: white; outline: none; }
        
/* Cache les flèches (spinners) des inputs numériques */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Pour Firefox */
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; } .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 250px; overflow: visible; }
        .circle-bg { fill: none; stroke: #222; stroke-width: 2.5; }
        .circle { fill: none; stroke-width: 2.5; stroke-linecap: round; transition: stroke-dasharray 0.5s ease; }
        .timer-active { text-shadow: 0 0 15px rgba(59, 130, 246, 0.8); }
        .particle { position: fixed; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; z-index: 9999; animation: particleRise 2s ease-out forwards; }
        @keyframes particleRise { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-150px) scale(0); opacity: 0; } }
        .autocomplete-list { position: absolute; top: 100%; left: 0; width: 100%; background: rgba(20, 20, 20, 0.95); border: 1px solid #333; border-radius: 0 0 12px 12px; z-index: 50; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .autocomplete-item { padding: 10px 15px; cursor: pointer; font-size: 0.85rem; border-bottom: 1px solid #222; transition: background 0.2s; }
        .autocomplete-item:hover { background: #1e3a8a; color: white; }

        .shockwave-ring { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; border-style: solid; opacity: 0; animation: shockwave 1s ease-out; pointer-events: none; }
        .screen-flash { position: fixed; inset: 0; z-index: 40; pointer-events: none; animation: screenFlash 0.5s ease-out forwards; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 10px; color: white; font-size: 0.9rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: toastSlide 0.3s ease-out; display: flex; items-center; gap: 10px; min-width: 250px; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.success { border-left: 4px solid #22c55e; }
        .toast.info { border-left: 4px solid #3b82f6; }
        #celebrationOverlay.active { display: flex !important; opacity: 1 !important; }
        .flashcard-content h1, .flashcard-content h2, .flashcard-content h3 { color: #facc15; border-bottom: 1px solid rgba(250,204,21,0.2); padding-bottom: 5px; margin-top: 1.5rem; }
        .flashcard-content ul { list-style-type: disc; margin-left: 20px; }
        .flashcard-content p, .flashcard-content li { color: #d1d5db; line-height: 1.6; }
        .chat-bubble { max-width: 80%; padding: 12px 16px; border-radius: 16px; font-size: 0.9rem; line-height: 1.5; animation: toastSlide 0.3s ease-out; }
        .chat-user { align-self: flex-end; background-color: #2563eb; color: white; border-bottom-right-radius: 4px; }
        .chat-ai { align-self: flex-start; background-color: #333; color: #e5e7eb; border-bottom-left-radius: 4px; border: 1px solid #444; }
        .notes-thematic { transition: background-color 0.5s; }
        
        /* --- MODERNIZED SUGGESTIONS --- */
        .suggestion-card { 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .suggestion-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 15px 40px -10px rgba(0,0,0,0.8); 
            background: rgba(255,255,255,0.08) !important;
        }
        .suggestion-card.done { 
            opacity: 0.6; 
            background: rgba(20, 50, 20, 0.4) !important; 
            border-color: rgba(34, 197, 94, 0.3); 
        }
        .suggestion-card.done h3 { text-decoration: line-through; color: #6b7280; }

@keyframes shakeError {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }

        .animate-shake {
            animation: shakeError 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        .validation-error {
            border-color: #ef4444 !important;
            background-color: rgba(239, 68, 68, 0.15) !important;
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.4) !important;
        }
        .validation-error h3, .validation-error p {
            color: #fca5a5 !important;
        }

        .custom-checkbox input:checked + div { background-color: #22c55e; border-color: #22c55e; }
        .custom-checkbox input:checked + div i { opacity: 1; animation: check-pop 0.3s ease-out forwards; }
        
        .view-bar { width: 4px; height: 100%; border-radius: 1px; transition: background-color 0.3s; }

        .glass-panel { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        input[type="date"] { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: 10px; border-radius: 8px; width: 100%; font-family: 'Courier Prime', monospace; cursor: pointer; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        .digit-scroll { display: inline-block; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .btn-gold { background: linear-gradient(135deg, #d97706 0%, #fbbf24 100%); color: black; font-weight: bold; border: none; transition: all 0.3s ease; }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); }

/* --- DINO DIAMOND INTERACTION --- */
        .diamond-particle {
            position: absolute;
            pointer-events: none;
            animation: floatDiamond 1.2s ease-out forwards;
            font-size: 1rem;
            z-index: 30;
            text-shadow: 0 0 10px rgba(103, 232, 249, 0.8);
        }

        @keyframes floatDiamond {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translateY(-15px) scale(1); }
            100% { transform: translateY(-50px) scale(0.8); opacity: 0; }
        }

        .dino-woke {
            /* Pas de tremblement, juste un glow propre et une couleur Cyan */
            transform: scale(1.1);
            color: #67e8f9; /* Cyan-300 */
            filter: drop-shadow(0 0 20px rgba(34, 211, 238, 0.6));
        }

/* --- CUSTOM DRIVER.JS THEME (Ultimate Cockpit Style) --- */

/* 1. La Bulle Principale */
.driver-popover {
    background-color: rgba(10, 10, 12, 0.95) !important; /* Noir profond quasi opaque */
    backdrop-filter: blur(20px) !important;
    border: 1px solid rgba(251, 191, 36, 0.3) !important; /* Bordure Dorée subtile */
    box-shadow: 0 0 40px rgba(0,0,0,0.8), inset 0 0 20px rgba(251,191,36,0.05) !important;
    color: #e5e7eb !important;
    border-radius: 20px !important;
    padding: 24px !important;
    min-width: 320px !important;
    max-width: 400px !important;
}

/* 2. Le Titre */
.driver-popover-title {
    font-family: 'Montserrat', sans-serif !important;
    font-size: 18px !important;
    font-weight: 900 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    color: #fbbf24 !important; /* Jaune Or */
    margin-bottom: 12px !important;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* 3. Le Texte */
.driver-popover-description {
    font-family: 'Inter', sans-serif !important;
    font-size: 14px !important;
    line-height: 1.6 !important;
    color: #d1d5db !important; /* Gris clair */
    font-weight: 400 !important;
}

/* 4. Les Boutons (Navigation) */
.driver-popover-footer {
    margin-top: 20px !important;
}

.driver-popover-footer button {
    background-color: rgba(255, 255, 255, 0.05) !important;
    color: white !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 10px !important;
    text-shadow: none !important;
    font-weight: bold !important;
    font-size: 11px !important;
    padding: 8px 16px !important;
    transition: all 0.3s ease !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
}

.driver-popover-footer button:hover {
    background-color: rgba(255, 255, 255, 0.15) !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}

/* Le bouton "Terminé" ou "Suivant" en mode Action */
.driver-popover-next-btn {
    background: linear-gradient(135deg, #d97706 0%, #fbbf24 100%) !important;
    color: black !important;
    border: none !important;
    font-weight: 900 !important;
}

/* 5. La Flèche (Triangle) */
.driver-popover-arrow-side-left.driver-popover-arrow { border-left-color: rgba(10, 10, 12, 0.95) !important; }
.driver-popover-arrow-side-right.driver-popover-arrow { border-right-color: rgba(10, 10, 12, 0.95) !important; }
.driver-popover-arrow-side-top.driver-popover-arrow { border-top-color: rgba(10, 10, 12, 0.95) !important; }
.driver-popover-arrow-side-bottom.driver-popover-arrow { border-bottom-color: rgba(10, 10, 12, 0.95) !important; }

/* --- CSS GLASSMORPHISM & LUEUR INTERNE --- */
@keyframes softGlassPulse {
    0%, 100% { 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 0 0 rgba(255, 255, 255, 0); 
        border-color: rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
    }
    50% { 
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2), inset 0 0 15px rgba(100, 200, 255, 0.15); 
        border-color: rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.06);
    }
}

.glass-btn {
    /* Base Glassmorphism */
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px; /* Arrondi comme vos boutons actuels */
    
    /* Animation */
    animation: softGlassPulse 4s infinite ease-in-out;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.glass-btn:hover {
    /* Effet au survol (plus intense) */
    transform: translateY(-3px) scale(1.05);
    background: rgba(255, 255, 255, 0.15) !important;
    border-color: rgba(255, 255, 255, 0.5) !important;
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.2) !important;
    animation: none; /* On stoppe la pulsation au survol pour fixer l'état actif */
}

/* Style personnalisé pour le Slider d'objectif */
input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 16px;
    width: 16px;
    border-radius: 50%;
    background: #3b82f6; /* Bleu */
    border: 2px solid #1e293b; /* Bordure sombre */
    cursor: pointer;
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    margin-top: -6px; /* Centrer sur la barre */
    transition: transform 0.1s;
}

input[type=range]::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
}

input[type=range]::-webkit-slider-runnable-track {
    width: 100%;
    height: 4px;
    cursor: pointer;
    background: #334155;
    border-radius: 2px;
}

/* --- AJOUT : Animation Lueur Multicolore --- */
/* --- Animation "Spectre Complet" (Toutes les matières) --- */
        @keyframes spectralPulse {
            0%   { color: #ef4444; filter: drop-shadow(0 0 15px rgba(239, 68, 68, 0.8)); }   /* Rouge (Cardio) */
            6%   { color: #f97316; filter: drop-shadow(0 0 15px rgba(249, 115, 22, 0.8)); }  /* Orange (Néphro) */
            12%  { color: #f59e0b; filter: drop-shadow(0 0 15px rgba(245, 158, 11, 0.8)); }  /* Amber (Gastro) */
            18%  { color: #eab308; filter: drop-shadow(0 0 15px rgba(234, 179, 8, 0.8)); }   /* Jaune (Infectio) */
            24%  { color: #84cc16; filter: drop-shadow(0 0 15px rgba(132, 204, 22, 0.8)); }  /* Lime (Rhumato) */
            30%  { color: #22c55e; filter: drop-shadow(0 0 15px rgba(34, 197, 94, 0.8)); }   /* Vert (MPR) */
            36%  { color: #10b981; filter: drop-shadow(0 0 15px rgba(16, 185, 129, 0.8)); }  /* Emerald (Santé Pub) */
            42%  { color: #14b8a6; filter: drop-shadow(0 0 15px rgba(20, 184, 166, 0.8)); }  /* Teal (ORL) */
            48%  { color: #06b6d4; filter: drop-shadow(0 0 15px rgba(6, 182, 212, 0.8)); }   /* Cyan (Pédia) */
            54%  { color: #0ea5e9; filter: drop-shadow(0 0 15px rgba(14, 165, 233, 0.8)); }  /* Sky (Pneumo) */
            60%  { color: #3b82f6; filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.8)); }  /* Bleu (Ophtalmo) */
            66%  { color: #6366f1; filter: drop-shadow(0 0 15px rgba(99, 102, 241, 0.8)); }  /* Indigo (Neuro) */
            72%  { color: #8b5cf6; filter: drop-shadow(0 0 15px rgba(139, 92, 246, 0.8)); }  /* Violet (Psy) */
            78%  { color: #a855f7; filter: drop-shadow(0 0 15px rgba(168, 85, 247, 0.8)); }  /* Purple (Interne) */
            84%  { color: #d946ef; filter: drop-shadow(0 0 15px rgba(217, 70, 239, 0.8)); }  /* Fuchsia (Addicto) */
            90%  { color: #ec4899; filter: drop-shadow(0 0 15px rgba(236, 72, 153, 0.8)); }  /* Pink (Gynéco) */
            96%  { color: #f43f5e; filter: drop-shadow(0 0 15px rgba(244, 63, 94, 0.8)); }   /* Rose (Dermato) */
            100% { color: #ef4444; filter: drop-shadow(0 0 15px rgba(239, 68, 68, 0.8)); }   /* Retour au Rouge */
        }

        .animate-spectral {
            /* Durée de 20s pour que chaque couleur reste visible environ 1.2 à 1.5 secondes */
            /* C'est une transition douce et continue (linear) */
            animation: spectralPulse 20s linear infinite; 
        }

/* --- CORRECTION LISTES NOTES (Tailwind Reset Fix) --- */
        #detailNotesArea ul {
            list-style-type: disc !important;
            padding-left: 1.5rem !important;
            margin-bottom: 1rem;
        }
        
        #detailNotesArea ol {
            list-style-type: decimal !important;
            padding-left: 1.5rem !important;
            margin-bottom: 1rem;
        }
        
        #detailNotesArea li {
            display: list-item !important; /* Force l'affichage en élément de liste */
            margin-bottom: 0.25rem;
        }
        
        /* Style pour le gras et l'italique pour être sûr */
        #detailNotesArea b, #detailNotesArea strong { font-weight: bold !important; }
        #detailNotesArea i, #detailNotesArea em { font-style: italic !important; }

/* --- STYLE DES TITRES DANS LES NOTES --- */
        #detailNotesArea h2 {
            font-size: 1.5rem !important; /* Gros texte */
            font-weight: 800 !important;  /* Très gras */
            color: #fbbf24 !important;    /* Couleur Or (Gold) */
            margin-top: 1.5rem !important;
            margin-bottom: 0.5rem !important;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2); /* Ligne de séparation subtile */
            padding-bottom: 5px;
            font-family: 'Montserrat', sans-serif; /* Police des titres */
        }

/* --- ANIMATION BURST (Changement de matière) --- */
        @keyframes burstExpand {
            0% { width: 0; height: 0; opacity: 0.8; }
            40% { opacity: 0.9; }
            100% { width: 250vmax; height: 250vmax; opacity: 0; }
        }
        
        .animate-burst {
            animation: burstExpand 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

/* --- ANIMATION ICONE GÉANTE --- */
        @keyframes iconZoomFade {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            20% { opacity: 1; }
            50% { transform: scale(1.2) rotate(0deg); opacity: 0.8; }
            100% { transform: scale(2) rotate(10deg); opacity: 0; }
        }

        .animate-icon-burst {
            animation: iconZoomFade 0.7s ease-out forwards;
        }

/* --- FLASH LUMINEUX COLORÉ --- */
/* 1. La classe optimisée */
.transition-flash {
    position: fixed;
    inset: 0;
    z-index: 10000;
    pointer-events: none;
    
    /* On définit le fond ICI pour éviter de le recalculer à chaque frame */
    background: radial-gradient(circle, rgba(59, 130, 246, 0.6) 0%, rgba(168, 85, 247, 0.4) 60%, rgba(0,0,0,0) 100%);
    
    /* Optimisation matérielle indispensable pour la fluidité */
    will-change: opacity, transform;
    mix-blend-mode: screen; 
    
    /* On applique le flou de base (statique pour éviter le lag) */
    backdrop-filter: blur(5px);

    /* L'animation */
    animation: flashBurst 1.5s ease-out forwards;
}

/* 2. Les Keyframes avec "Zone de Sécurité" */
@keyframes flashBurst {
    0% { 
        opacity: 0; 
        transform: scale(1);
    }
    10% { 
        /* Montée très rapide de la lumière */
        opacity: 1; 
        transform: scale(1.05);
    }
    80% {
        /* LE SECRET EST ICI : On commence à être invisible */
        opacity: 0; 
        transform: scale(1.15);
    }
    100% { 
        /* ZONE DE SÉCURITÉ : On reste invisible jusqu'à la fin */
        /* Cela garantit que si le JS supprime l'élément à 1.5s pile, */
        /* l'élément est déjà invisible depuis 0.3 secondes. */
        opacity: 0; 
        transform: scale(1.2);
    }
}

/* --- EFFET GLOW DYNAMIQUE NOTES --- */
        #notesPanel {
            /* Couleur par défaut (Gris/Blanc) */
            --glow-rgb: 255, 255, 255; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #notesPanel:hover {
            /* Bordure colorée */
            border-color: rgba(var(--glow-rgb), 0.6) !important;
            
            /* Lueur externe (Le "Brille") */
            box-shadow: 0 0 40px -5px rgba(var(--glow-rgb), 0.3), 
                        inset 0 0 20px rgba(var(--glow-rgb), 0.05) !important;
            
            /* Léger soulèvement */
            transform: translateY(-4px);
        }

/* --- CUSTOM SLIDER STYLE --- */
.range-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    outline: none;
    cursor: pointer;
    transition: background 0.3s;
}

/* Le curseur (Rond qui bouge) */
.range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--thumb-color, #4b5563); /* Couleur dynamique via JS */
    border: 2px solid #111;
    box-shadow: 0 0 10px var(--thumb-color, #4b5563); /* Lueur */
    cursor: pointer;
    transition: all 0.2s ease;
    transform: translateY(-6px); /* Centrer sur la barre (6px hauteur barre vs 18px thumb) */
}

.range-slider::-webkit-slider-thumb:hover {
    transform: translateY(-6px) scale(1.2); /* Grossit au survol */
}

/* La piste (Barre de fond) */
.range-slider::-webkit-slider-runnable-track {
    width: 100%;
    height: 6px;
    cursor: pointer;
    background: transparent;
    border-radius: 10px;
}

    </style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
<script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
</head>

<body class="min-h-screen flex flex-col text-gray-100 font-sans">

    <div class="depth-bg"><div class="orb orb-1"></div><div class="orb orb-2"></div></div>
    <div id="matiereGlowOverlay" class="fixed inset-0 z-[-1] transition-opacity duration-700 opacity-0 pointer-events-none"></div>
    <div id="toast-container"></div>

    <div id="celebrationOverlay" class="fixed inset-0 z-[100] hidden opacity-0 flex-col items-center justify-center transition-opacity duration-300 pointer-events-none bg-black/80 backdrop-blur-2xl">
        <div class="relative flex flex-col items-center justify-center transform scale-90 transition-transform duration-500" id="celebrationContent">
<div id="celebrationGlow" class="absolute inset-0 bg-yellow-500/20 blur-[120px] rounded-full"></div>            <div class="relative mb-16">
	    <div id="celebrationRing" class="absolute inset-0 rounded-full border-2 border-yellow-500/30 animate-gold-pulse scale-150"></div>
                <div class="absolute inset-0 rounded-full border-2 border-yellow-500/30 animate-gold-pulse scale-150"></div>
                <i class="fa-solid fa-dragon text-[180px] text-gray-100 drop-shadow-2xl relative z-10" id="iconDragon"></i>
                <i class="fa-solid fa-crown text-6xl text-yellow-400 absolute -top-16 left-1/2 transform -translate-x-1/2 animate-bounce z-20 drop-shadow-[0_0_20px_rgba(250,204,21,0.8)]" id="iconCrown"></i>
                <i class="fa-solid fa-trophy text-[180px] text-yellow-400 drop-shadow-2xl relative z-10 animate-pulse-fast hidden" id="iconTrophy"></i>
            </div>
            <div class="text-center space-y-2">
                <h2 class="text-6xl md:text-8xl font-display font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 to-yellow-600 tracking-widest uppercase drop-shadow-2xl">VICTOIRE !</h2>
                <div class="flex items-center justify-center gap-3 text-yellow-500/80 font-mono text-sm uppercase tracking-[0.4em]">
                    <div class="h-px w-12 bg-yellow-500/50"></div>
                    <span>Suggestions du jour complétées</span>
                    <div class="h-px w-12 bg-yellow-500/50"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="focusOverlay" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-2xl transition-opacity duration-500 opacity-0">
        <div class="relative flex flex-col items-center text-center px-4">
            <div class="w-32 h-32 border-2 border-yellow-500/30 rotate-45 flex items-center justify-center mb-12 animate-pulse relative">
                <div class="absolute inset-0 bg-yellow-500/10 blur-xl"></div>
                <i class="fa-solid fa-dragon text-5xl text-yellow-400 drop-shadow-[0_0_25px_rgba(250,204,21,0.8)] -rotate-45"></i>
            </div>
            <h2 class="text-3xl md:text-5xl font-display font-black text-yellow-400 tracking-[0.1em] uppercase mb-4 drop-shadow-lg" id="focusQuote">FOCUS ABSOLU</h2>
            <p class="text-yellow-200/70 text-sm font-bold uppercase tracking-widest">1 Minute Complétée</p>
        </div>
    </div>

<div class="fixed bottom-6 right-6 z-[90] flex flex-row-reverse items-center gap-4">
    
    <button onclick="toggleMusicMenu()" id="mainMusicBtn" class="w-14 h-14 rounded-full bg-[#050505] border border-white/10 text-gray-400 hover:text-white hover:border-purple-500/50 hover:shadow-[0_0_25px_rgba(168,85,247,0.3)] transition-all duration-500 flex items-center justify-center group z-50 relative shadow-2xl">
        
        <i id="mainMusicIcon" class="fa-solid fa-music text-lg group-hover:scale-110 transition-transform duration-300"></i>
        
        <div id="musicVisualizer" class="hidden absolute inset-0 items-center justify-center gap-1 pointer-events-none">
            <div class="w-0.5 h-3 bg-purple-400 animate-[pulse_1s_ease-in-out_infinite]"></div>
            <div class="w-0.5 h-5 bg-purple-400 animate-[pulse_1.2s_ease-in-out_infinite]"></div>
            <div class="w-0.5 h-3 bg-purple-400 animate-[pulse_0.8s_ease-in-out_infinite]"></div>
        </div>
    </button>

    <div id="musicMenuOptions" class="flex items-center gap-2 pr-2 pl-2 py-2 bg-[#0a0a0a]/95 backdrop-blur-xl border border-white/10 rounded-full shadow-2xl transition-all duration-500 ease-out opacity-0 translate-x-10 pointer-events-none scale-95 origin-right">
    
    <button onclick="togglePlayPause()" id="miniPlayBtn" class="w-10 h-10 rounded-full bg-black border border-white/10 text-white flex items-center justify-center transition-all shadow-lg group/play hover:border-purple-500 hover:shadow-[0_0_20px_rgba(168,85,247,0.6)] hover:text-purple-400">
        <i id="miniPlayIcon" class="fa-solid fa-play text-xs ml-0.5"></i>
    </button>

    <div class="w-px h-6 bg-white/10 mx-1"></div>

    <button id="btn-theme4" onclick="setMusicTheme('theme4')" class="w-10 h-10 rounded-full bg-emerald-900/20 border border-emerald-500/30 text-emerald-400 hover:text-white hover:bg-emerald-600 hover:shadow-[0_0_15px_rgba(16,185,129,0.6)] flex items-center justify-center transition-all group relative" title="Thème Nature">
        <i class="fa-solid fa-tree text-xs"></i>
    </button>

    <button id="btn-theme1" onclick="setMusicTheme('theme1')" class="w-10 h-10 rounded-full bg-sky-400/10 border border-sky-400/30 text-sky-300 hover:text-white hover:bg-sky-500 hover:shadow-[0_0_15px_rgba(14,165,233,0.6)] flex items-center justify-center transition-all group relative" title="Thème Focus (Air)">
        <i class="fa-solid fa-wind text-xs"></i>
    </button>

    <button id="btn-theme3" onclick="setMusicTheme('theme3')" class="w-10 h-10 rounded-full bg-indigo-950/80 border border-indigo-500/30 text-indigo-300 hover:text-white hover:bg-indigo-600 hover:shadow-[0_0_15px_rgba(79,70,229,0.6)] flex items-center justify-center transition-all group relative" title="Thème Drama">
        <i class="fa-solid fa-masks-theater text-xs"></i>
    </button>

    <button id="btn-theme2" onclick="setMusicTheme('theme2')" class="w-10 h-10 rounded-full bg-orange-500/10 border border-orange-500/30 text-orange-400 hover:text-white hover:bg-orange-500 hover:shadow-[0_0_15px_rgba(249,115,22,0.6)] flex items-center justify-center transition-all group relative" title="Thème Épique">
        <i class="fa-solid fa-fire text-xs"></i>
    </button>

</div>

</div>

    <header class="fixed top-0 w-full z-50 bg-[#050505]/80 backdrop-blur-xl border-b border-white/10 transition-all duration-300 shadow-[0_4px_30px_rgba(0,0,0,0.1)]">
        <div class="container mx-auto px-6 h-20 flex justify-between items-center relative">
            
            <div class="flex items-center gap-4 cursor-pointer group" onclick="resetView()">
                <div class="relative w-10 h-10 flex items-center justify-center">
                    <div class="absolute inset-0 bg-blue-600/20 rounded-full blur-md group-hover:bg-blue-500/30 transition duration-500"></div>
                    <i id="navbarIcon" class="fa-solid fa-dragon text-3xl text-white relative z-10 group-hover:scale-110 transition-transform duration-300"></i>
                </div>
                <div class="hidden sm:block">
                    <h1 class="text-sm font-display font-black tracking-[0.9em] text-white uppercase group-hover:text-white-400 transition">Ultimed</h1>
                    <p class="text-[9px] text-gray-500 font-mono uppercase tracking-widest opacity-60"></p>
                </div>
            </div>

            <div class="hidden lg:flex items-center gap-3 px-6 py-2 bg-[#111]/60 backdrop-blur-md rounded-full border border-white/10 shadow-lg">
                <div id="customLinksContainer" class="flex items-center gap-2"></div>
                
                <div class="h-4 w-px bg-white/10 mx-1"></div>

                <button onclick="openLinkModal()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-white/10 transition group" title="Ajouter un site">
                    <div class="w-5 h-5 rounded-full bg-white/10 flex items-center justify-center text-gray-400 group-hover:text-white group-hover:bg-blue-500 transition-colors">
                        <i class="fa-solid fa-plus text-[10px] group-hover:rotate-90 transition-transform"></i>
                    </div>
                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider group-hover:text-white">Nouveau</span>
                </button>
            </div>

            <div class="flex items-center gap-4 lg:gap-6">
                
   <div class="flex items-center gap-3">
    
    <div onclick="openXPModal()" class="hidden xl:flex items-center gap-2.5 bg-blue-900/20 backdrop-blur-md px-3 py-1.5 rounded-lg border border-blue-500/10 shadow-lg hover:border-blue-500/50 hover:bg-blue-900/40 transition-all cursor-pointer group h-10 select-none active:scale-95">
    
    <div class="flex flex-col items-end justify-center leading-none">
        <span class="text-[8px] text-blue-300/60 font-bold uppercase tracking-wider">Niv.</span>
        <span id="lvlDisplay" class="text-blue-100 font-display font-black text-lg leading-none group-hover:text-white transition">0</span>
    </div>

    <div class="h-5 w-px bg-blue-500/20 mx-1"></div>

    <div class="flex flex-col justify-center w-24">
        <div class="flex justify-between items-center mb-1">
            <i class="fa-solid fa-bolt text-[8px] text-blue-500 group-hover:text-blue-400 transition"></i>
            <span class="text-[8px] font-mono font-bold text-blue-300"><span id="xpDisplay">0</span> XP</span>
        </div>
        
        <div class="w-full h-1 bg-blue-900/50 rounded-full overflow-hidden border border-white/5">
            <div id="xpBar" class="h-full bg-gradient-to-r from-blue-400 to-indigo-400 shadow-[0_0_5px_rgba(96,165,250,0.8)] relative transition-all duration-500" style="width: 0%"></div>
        </div>
    </div>
</div>

<div onclick="openCountdownModal()" class="hidden md:flex items-center gap-2.5 bg-orange-900/10 backdrop-blur-md px-3 py-1.5 rounded-lg border border-orange-500/10 shadow-lg hover:border-orange-500/50 hover:bg-orange-900/30 transition-all cursor-pointer group h-10 select-none active:scale-95">
    
    <div class="flex flex-col items-end justify-center leading-none">
        <span class="text-[8px] text-orange-500/60 font-bold uppercase tracking-wider mb-0.5">Jours</span>
        <span class="text-[8px] text-gray-500 font-bold uppercase tracking-wider">Restants</span>
    </div>
    
    <div class="h-5 w-px bg-orange-500/20 mx-1"></div>

    <div class="flex items-center gap-2">
        <span id="countdownDisplay" class="text-orange-100 font-display font-black text-lg leading-none tracking-wide group-hover:text-white transition">---</span>
        <i class="fa-solid fa-hourglass-half text-orange-500/80 text-xs group-hover:animate-spin-slow"></i>
    </div>
</div>

                <button onclick="resetView()" class="w-10 h-10 glass-btn flex items-center justify-center text-gray-400 hover:text-green-400 transition-all shadow-lg group relative overflow-hidden" title="Accueil (Tableau de bord)">
        <i class="fa-solid fa-house text-sm group-hover:scale-110 transition-transform relative z-10"></i>
    </button>

    <button onclick="toggleCalendarView()" class="w-10 h-10 glass-btn flex items-center justify-center text-gray-400 hover:text-blue-400 transition-all shadow-lg group relative overflow-hidden" title="Calendrier">
        <i class="fa-regular fa-calendar text-sm group-hover:scale-110 transition-transform relative z-10"></i>
    </button>

    <div class="relative" id="userMenuDropdown">
    <button onclick="toggleUserMenu()" class="w-10 h-10 glass-btn flex items-center justify-center text-gray-400 hover:text-white transition-all shadow-lg group relative overflow-hidden" title="Menu Utilisateur">
        <i class="fa-solid fa-bars text-lg group-hover:scale-110 transition-transform"></i>
    </button>

    <div id="dropdownMenuBody" class="absolute right-0 top-full mt-3 w-64 bg-[#111]/90 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl transform origin-top-right transition-all duration-200 scale-95 opacity-0 invisible z-[100]">
        
        <div class="p-4 border-b border-white/5">
            <p class="text-white font-bold text-sm truncate" id="menuUserName">Docteur</p>
            <p class="text-xs text-gray-500 uppercase tracking-wider">Étudiant</p>
        </div>

        <div class="p-2 space-y-1">
            <button onclick="openGlobalSettings(); toggleUserMenu()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5 text-gray-300 hover:text-white transition text-left group">
                <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-400 group-hover:bg-purple-500 group-hover:text-white transition"><i class="fa-solid fa-sliders"></i></div>
                <div><div class="text-sm font-bold">Paramètres</div><div class="text-[10px] text-gray-500 group-hover:text-gray-400">Compte & Données</div></div>
            </button>
            
            <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-500/10 text-gray-300 hover:text-red-400 transition text-left group">
                <div class="w-8 h-8 rounded-lg bg-red-500/10 flex items-center justify-center text-red-500 group-hover:bg-red-500 group-hover:text-white transition"><i class="fa-solid fa-power-off"></i></div>
                <div><div class="text-sm font-bold">Déconnexion</div><div class="text-[10px] text-gray-500 group-hover:text-red-400/70">Fermer la session</div></div>
            </button>
        </div>

        <div class="p-2 border-t border-white/5">
            <button onclick="startTutorial(); toggleUserMenu()" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-xs font-bold text-gray-500 hover:text-white hover:bg-white/5 transition"><i class="fa-solid fa-circle-question"></i> Aide / Tutoriel</button>
        </div>
    </div>
</div>

    </header>

    <div class="h-24"></div>

    <main class="flex-grow container mx-auto px-4 pb-20">
        <h1 class="text-3xl md:text-5xl font-display font-black text-white tracking-tight mb-8 mt-4 text-center md:text-left animate-fade-in-up" id="greetingDisplay">Bonjour, Docteur.</h1>
	<div id="dashboardView">
    <div class="flex items-center justify-between mb-6 pl-2 animate-fade-in-up">
        <h2 class="text-gray-500 text-xs font-bold uppercase tracking-widest flex items-center gap-2">
            <i class="fa-solid fa-gauge-high text-blue-500/50"></i> Tableau de bord
        </h2>
        <div class="h-px flex-grow bg-white/5 ml-4"></div>
    </div>

    <section class="mb-12 grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in-up" style="animation-delay: 0.1s;">

            <div class="card-panel rounded-3xl p-6 flex flex-col items-center justify-center relative shadow-2xl order-1 min-h-[400px]">
    <div class="absolute inset-0 overflow-hidden rounded-3xl pointer-events-none">
         <div id="timerGlow" class="absolute w-40 h-40 bg-blue-600/10 rounded-full blur-[70px] transition-all duration-1000 opacity-0 scale-50"></div>
         <div id="timerFlame" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full h-full bg-yellow-500/5 blur-xl z-0"></div>
    </div>
    
    <div class="absolute top-6 right-6 z-30 flex flex-col items-end">
    
    <button onclick="toggleGoalPanel()" id="goalDisplayBtn" class="w-8 h-8 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:text-blue-400 hover:bg-blue-500/10 hover:border-blue-500/50 transition-all shadow-lg group active:scale-95" title="Définir un objectif">
        <i class="fa-solid fa-crosshairs text-sm group-hover:rotate-90 transition-transform duration-500"></i>
        <span id="goalValueDisplay" class="hidden">Libre</span>
    </button>

    <div id="goalControlPanel" class="absolute top-full right-0 mt-3 w-84 bg-[#121212] border border-white/10 rounded-2xl p-5 shadow-2xl backdrop-blur-xl opacity-0 invisible transform -translate-y-2 transition-all duration-300 origin-top-right z-50">
        
        <div class="flex justify-between items-center mb-6">
            <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2">
                <i class="fa-solid fa-hourglass-start text-blue-500"></i> Durée cible
            </h4>
            <button onclick="toggleGoalPanel()" class="w-6 h-6 rounded-full hover:bg-white/10 flex items-center justify-center text-gray-600 hover:text-white transition"><i class="fa-solid fa-times text-xs"></i></button>
        </div>

        <div class="mb-6">
            
            <div class="flex items-center gap-3">
                <input type="range" id="goalSlider" min="0" max="720" step="15" value="0" 
                       oninput="updateGoalFromInput(this.value)" 
                       class="flex-grow h-1.5 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400 transition-all block">
                
                <input type="text" id="goalInputManual" readonly value="Libre"
                       class="w-28 bg-black/20 border border-white/5 rounded-lg py-1.5 px-0 text-center text-blue-400 text-xs font-bold tracking-tighter focus:outline-none cursor-default flex-shrink-0">
            </div>

            <div class="flex items-center gap-3 mt-2">
                <div class="flex-grow flex justify-between text-[9px] text-gray-600 font-mono uppercase tracking-wider px-0.5">
                    <span>0h</span>
                    <span>6h</span>
                    <span>12h</span>
                </div>
                <div class="w-28 flex-shrink-0"></div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2 mb-4">
            <button onclick="setPresetGoal(25)" class="py-2 rounded-xl border border-white/5 bg-white/[0.02] hover:bg-blue-500/10 hover:border-blue-500/30 text-gray-400 hover:text-white transition flex flex-col items-center gap-0.5 group">
                <span class="text-sm font-bold group-hover:text-blue-400 transition-colors">25</span>
                <span class="text-[8px] uppercase tracking-wider opacity-50">Pomo</span>
            </button>
            <button onclick="setPresetGoal(60)" class="py-2 rounded-xl border border-white/5 bg-white/[0.02] hover:bg-blue-500/10 hover:border-blue-500/30 text-gray-400 hover:text-white transition flex flex-col items-center gap-0.5 group">
                <span class="text-sm font-bold group-hover:text-blue-400 transition-colors">1h</span>
                <span class="text-[8px] uppercase tracking-wider opacity-50">Session</span>
            </button>
            <button onclick="setPresetGoal(120)" class="py-2 rounded-xl border border-white/5 bg-white/[0.02] hover:bg-purple-500/10 hover:border-purple-500/30 text-gray-400 hover:text-white transition flex flex-col items-center gap-0.5 group">
                <span class="text-sm font-bold group-hover:text-purple-400 transition-colors">2h</span>
                <span class="text-[8px] uppercase tracking-wider opacity-50">Deep</span>
            </button>
        </div>
        
        <button onclick="setPresetGoal(0)" class="w-full py-2 text-[10px] font-bold text-gray-600 hover:text-red-400 transition uppercase tracking-widest hover:bg-red-500/5 rounded-lg">
            Désactiver
        </button>
    </div>
</div>

    <div class="flex-grow flex items-end justify-center pb-6 w-full relative z-20">
        <div id="dinoWrapper" class="relative transition-transform duration-300 cursor-pointer group" onclick="triggerDinoJump()">
            
            <div id="dinoSpeechBubble" class="absolute bottom-full mb-7 left-1/2 -translate-x-1/2 w-64 p-4 rounded-2xl bg-slate-900/95 backdrop-blur-xl border border-cyan-500/30 shadow-[0_0_30px_-5px_rgba(6,182,212,0.4)] hidden opacity-0 transition-all duration-300 z-[9999]">
                <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-slate-900/95 backdrop-blur-xl border-r border-b border-cyan-500/30 rotate-45"></div>
                <h4 class="text-cyan-400 font-display font-black text-xs uppercase tracking-widest mb-1 drop-shadow-md flex items-center gap-2">
                    <i class="fa-solid fa-star"></i> Magic Creature
                </h4>
                <p id="dinoSpeechText" class="text-cyan-50 text-sm font-medium leading-relaxed drop-shadow-sm">Prêt à majorer ?</p>
            </div>

            <i class="fa-solid fa-dragon text-6xl text-gray-500 transition-colors duration-300 relative z-10" id="dinoIcon"></i>
            <div id="dinoZzz" class="absolute -top-6 -right-6 text-lg font-bold text-gray-600 animate-pulse z-10">Zzz</div>
        </div>
    </div>

    <div class="flex flex-col items-center z-10 mb-6">
        <div id="timerDisplay" class="text-6xl font-mono font-black text-white tracking-widest transition-all duration-500 tabular-nums drop-shadow-lg">00:00</div>
        
        <div id="timerProgressBarContainer" class="w-32 h-1 bg-gray-800 rounded-full mt-4 overflow-hidden hidden transition-all">
            <div id="timerProgressBar" class="h-full bg-blue-500 w-0 shadow-[0_0_10px_rgba(59,130,246,0.8)] transition-all duration-1000"></div>
        </div>
        <div id="timerMessage" class="h-5 mt-1 text-xs font-bold text-blue-400 opacity-0 transition-opacity uppercase tracking-wider"></div>
    </div>

    <div class="flex items-center gap-6 mt-auto relative z-20">
        <button onclick="resetTimer()" class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center text-gray-500 hover:text-white hover:bg-white/5 transition group" title="Réinitialiser">
            <i class="fa-solid fa-rotate-right text-xs group-hover:rotate-180 transition-transform duration-500"></i>
        </button>
        
        <div class="relative flex items-center justify-center">
            <svg class="w-16 h-16 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 -rotate-90 pointer-events-none">
                <circle cx="32" cy="32" r="30" stroke="rgba(255,255,255,0.1)" stroke-width="2" fill="none" />
                <circle id="playBtnProgress" cx="32" cy="32" r="30" stroke="#3b82f6" stroke-width="2" fill="none" stroke-dasharray="188" stroke-dashoffset="188" class="transition-all duration-1000" />
            </svg>
            <button onclick="toggleTimer()" id="timerBtn" class="w-14 h-14 rounded-full bg-white text-black flex items-center justify-center shadow-lg hover:scale-105 transition-all duration-300 group relative overflow-hidden active:scale-95 z-10">
                <i class="fa-solid fa-play text-xl ml-0.5 group-hover:scale-110 transition" id="timerIcon"></i>
                <div id="shockwaveContainer" class="absolute inset-0 pointer-events-none"></div>
            </button>
        </div>

        <button onclick="finishSession()" id="finishBtn" class="w-10 h-10 rounded-full border border-green-500/30 text-green-500 hover:bg-green-500 hover:text-white flex items-center justify-center transition opacity-30 cursor-not-allowed transform scale-90" disabled title="Terminer la session">
            <i class="fa-solid fa-flag-checkered text-xs"></i>
        </button>
    </div>
</div>

            <div class="card-panel rounded-3xl p-6 flex flex-col shadow-2xl order-2 relative z-20 min-h-[400px]">
                <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-4">
                    <div class="flex items-center gap-3">
                        <button onclick="toggleCalendarView()" class="w-8 h-8 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:text-blue-400 hover:bg-blue-500/10 transition group" title="Ouvrir le Calendrier">
                            <i class="fa-regular fa-calendar text-xs group-hover:scale-110 transition-transform"></i>
                        </button>
                        <h3 class="font-display font-bold text-lg text-white tracking-wide">Objectifs du Jour</h3>
                    </div>
                    <span class="text-xs text-gray-500 uppercase font-bold" id="dateToday">...</span>
                </div>

                <div class="relative mb-4 group">
    <input type="text" id="todoInput" placeholder="Rechercher..." 
           class="w-full bg-transparent border border-transparent hover:bg-white/5 focus:bg-black/40 focus:border-blue-500/50 rounded-xl px-4 py-2 text-xs font-medium text-gray-600 focus:text-white placeholder-gray-800 focus:placeholder-gray-500 transition-all outline-none" 
           autocomplete="off">
           
    <i class="fa-solid fa-search absolute right-4 top-2.5 text-gray-800 group-hover:text-gray-600 transition-colors text-xs pointer-events-none"></i>
    
    <div id="autocompleteList" class="autocomplete-list hidden"></div>
</div>

                <div class="flex-grow overflow-y-auto custom-scrollbar space-y-2 pr-1" id="todoList">
                    <div class="text-center text-gray-600 text-xs mt-10 italic">Sélectionnez vos priorités.</div>
                </div>
            </div> 

            <div id="notesPanel" 
     onclick="openFullScreenNotes()" 
     class="card-panel rounded-3xl p-6 flex flex-col shadow-2xl relative group order-3 min-h-[400px] notes-thematic cursor-pointer">
    
    <div id="notesHeader" class="flex items-center justify-between mb-4">
        
        <div class="flex items-center gap-3">
            <div onclick="event.stopPropagation()" class="relative w-8 h-8 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition border border-white/10 group/select">
                    <i id="notesIcon" class="fa-solid text-sm text-gray-400"></i>
                    <select id="notesMatiereSelect" onchange="changeNotesMatiere(this.value)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" title="Changer de matière"></select>
            </div>
            <h3 id="notesTitle" class="font-display font-bold text-lg text-white tracking-wide">Notes Générales</h3>
        </div>

        <div class="flex items-center gap-2">
            <span id="saveIndicator" class="text-[10px] text-green-500 font-bold opacity-0 transition-opacity">SAUVEGARDÉ</span>
            
            <button class="w-8 h-8 rounded-lg bg-white/5 hover:bg-white/20 border border-white/10 text-gray-400 hover:text-white flex items-center justify-center transition-all hover:scale-110" title="Agrandir / Outils">
                <i class="fa-solid fa-expand text-xs"></i>
            </button>
        </div>
    </div>

    <div class="flex-grow relative bg-black/20 backdrop-blur-md rounded-xl border border-white/10 overflow-hidden shadow-inner cursor-text focus-within:border-white/30 focus-within:bg-black/40 transition-all duration-300 group/edit" 
         onclick="event.stopPropagation()">
        
        <div id="quickNotesPreview" 
             contenteditable="true"
             oninput="saveDashboardNotes()"
             class="w-full h-full p-5 overflow-y-auto text-sm text-gray-200 leading-relaxed focus:outline-none custom-scrollbar relative z-10 text-shadow-sm">
        </div>
        
        <div id="emptyNotePlaceholder" class="absolute top-5 left-5 text-sm text-gray-500/80 italic pointer-events-none hidden z-0">
            Cliquez pour écrire...
        </div>
    </div>
</div>

        </section>
        
        <section class="mb-12 animate-fade-in-up" style="animation-delay: 0.2s;">
            <div class="flex items-center justify-between mb-6 pl-2">
            <h2 class="text-gray-500 text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                <i class="fa-solid fa-chart-pie text-purple-500/50"></i> Statistiques Globales
            </h2>
            <div class="h-px flex-grow bg-white/5 ml-4"></div>
        </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div onclick="filterByStatus('lu')" class="cursor-pointer bg-[#111] border border-white/5 hover:border-green-500/30 hover:shadow-[0_0_30px_rgba(34,197,94,0.15)] transition-all duration-500 rounded-2xl p-6 flex items-center justify-between relative overflow-hidden group">
                    <div class="absolute -right-10 -top-10 w-48 h-48 bg-green-500/10 blur-[60px] rounded-full group-hover:bg-green-500/20 transition-all duration-500 pointer-events-none"></div>
                    <div class="z-10">
                        <p class="text-gray-400 text-sm font-medium mb-1 group-hover:text-green-200/70 transition-colors">Premier Passage</p>
                        <h3 class="text-3xl font-display font-bold text-white mb-2 group-hover:drop-shadow-[0_0_10px_rgba(34,197,94,0.5)] transition-all">Cours Lus</h3>
                        <p class="text-xs text-green-400 font-mono"><span id="countLu">0</span> / 367 ITEMS</p>
                    </div>
                    <div class="w-24 h-24 relative z-10">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle stroke-green-500 drop-shadow-[0_0_5px_rgba(34,197,94,0.8)]" id="ringLu" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white" id="pctLu">0%</div>
                    </div>
                </div>

                <div onclick="filterByStatus('maitrise')" class="cursor-pointer bg-[#111] border border-white/5 hover:border-yellow-500/30 hover:shadow-[0_0_30px_rgba(234,179,8,0.15)] transition-all duration-500 rounded-2xl p-6 flex items-center justify-between relative overflow-hidden group">
                    <div class="absolute -right-10 -top-10 w-48 h-48 bg-yellow-500/10 blur-[60px] rounded-full group-hover:bg-yellow-500/20 transition-all duration-500 pointer-events-none"></div>
                    <div class="z-10">
                        <p class="text-gray-400 text-sm font-medium mb-1 group-hover:text-yellow-200/70 transition-colors">Validation Finale</p>
                        <h3 class="text-3xl font-display font-bold text-white mb-2 group-hover:drop-shadow-[0_0_10px_rgba(234,179,8,0.5)] transition-all">Maîtrisés</h3>
                        <p class="text-xs text-yellow-400 font-mono"><span id="countMaitrise">0</span> / 367 ITEMS</p>
                    </div>
                    <div class="w-24 h-24 relative z-10">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle stroke-yellow-500 drop-shadow-[0_0_5px_rgba(234,197,94,0.8)]" id="ringMaitrise" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white" id="pctMaitrise">0%</div>
                    </div>
                </div>
            </div>
            <div class="mb-4">
            <div class="flex items-center justify-between mb-4 pl-2">
                <div class="flex items-center gap-4 flex-grow">
                    <h2 class="text-gray-500 text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-layer-group text-emerald-500/50"></i> Progression par Matière
                    </h2>
                    <div class="h-px flex-grow bg-white/5"></div>
                </div>
                <span class="text-[9px] text-gray-600 uppercase tracking-widest ml-4 font-mono hidden sm:block">
                    <i class="fa-solid fa-arrows-left-right mr-1"></i> Scroll
                </span>
            </div>
            <div class="flex gap-4 overflow-x-auto hide-scrollbar p-4" id="subjectProgressContainer"></div>
        </div>
        </section>

        <section id="suggestionBlock" class="mb-12 animate-fade-in-up hidden" style="animation-delay: 0.3s;">
            <div class="relative bg-black/20 border border-white/10 backdrop-blur-2xl rounded-[2rem] p-8 shadow-[0_0_50px_-10px_rgba(249,115,22,0.1)] overflow-hidden transition-all duration-500 hover:shadow-[0_0_70px_-10px_rgba(249,115,22,0.2)] hover:border-white/20">
                <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-orange-600/10 rounded-full blur-[100px] -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 w-[300px] h-[300px] bg-yellow-600/5 rounded-full blur-[80px] translate-y-1/2 -translate-x-1/2 pointer-events-none"></div>
                <div class="flex justify-between items-center mb-6 relative z-10">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-orange-500/20 to-yellow-500/20 border border-orange-500/30 flex items-center justify-center shadow-[0_0_20px_rgba(249,115,22,0.3)] backdrop-blur-md">
                            <i class="fa-solid fa-fire text-orange-400 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-display font-black text-2xl text-white tracking-tight">Suggestions du Jour</h3>
                            <p class="text-xs font-bold text-orange-400/70 uppercase tracking-widest">Révision Prioritaire</p>
                        </div>
                    </div>
                    <button onclick="renderSuggestions(true)" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 flex items-center justify-center text-gray-400 hover:text-white transition-all hover:rotate-180 duration-500" title="Rafraîchir">
                        <i class="fa-solid fa-sync-alt"></i>
                    </button>
                </div>
                <div id="suggestionList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 relative z-10"></div>
            </div>
        </section>

        <div id="subjectHeader" class="relative h-56 w-full max-w-6xl mx-auto z-30 mb-4 flex items-center justify-center">
    
    <div id="staticHeaderContent" onclick="toggleSubjectCarousel()" class="cursor-pointer group transition-all duration-300 z-20 hover:scale-105 flex flex-col items-center justify-center absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
        
        <div class="flex items-center gap-6 mb-4">
            
            <i class="fa-solid fa-chevron-left text-xl text-white/10 transition-all duration-300 group-hover:text-white/40 group-hover:-translate-x-2"></i>

            <div id="subjectIconContainer" class="w-20 h-20 rounded-3xl bg-white/5 border border-white/10 flex items-center justify-center shadow-2xl backdrop-blur-xl transition-all duration-500 group-hover:border-white/30 group-hover:bg-white/10">
                <i id="subjectIcon" class="fa-solid fa-book-medical text-3xl text-gray-400 transition-all duration-500 group-hover:text-white group-hover:rotate-12"></i>
            </div>

            <i class="fa-solid fa-chevron-right text-xl text-white/10 transition-all duration-300 group-hover:text-white/40 group-hover:translate-x-2"></i>
            
        </div>
        
        <div class="text-center w-max">
            <h2 id="subjectTitle" class="text-3xl font-display font-black text-white uppercase tracking-tight drop-shadow-2xl leading-none mb-2 transition-all">Programme R2C</h2>
            <div class="text-[10px] text-gray-600 font-bold uppercase tracking-[0.3em] group-hover:text-blue-400 transition-colors bg-black/30 px-3 py-1 rounded-full border border-white/5 inline-block">
                Ouvrir le menu
            </div>
        </div>

    </div>

    <div id="subjectCarouselContainer" 
         class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-screen h-64 flex items-center justify-center opacity-0 pointer-events-none scale-100 transition-all duration-300 z-50"
         style="-webkit-mask-image: linear-gradient(to right, transparent 0%, black 20%, black 80%, transparent 100%); mask-image: linear-gradient(to right, transparent 0%, black 20%, black 80%, transparent 100%);">
        
        <div class="w-full h-full overflow-x-auto hide-scrollbar flex items-center snap-x snap-mandatory py-10" id="scrollContainer">
            <div class="flex gap-8 px-[calc(50vw-6rem)] min-w-max items-center h-full" id="subjectCarouselTrack">
                </div>
        </div>
    </div>

</div>

<style>
    /* Masque pour fondre les bords du carrousel */
    .mask-linear-sides {
        mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    }
</style>

        <div class="sticky top-24 z-40 mb-8" id="filterBar">
    <div class="bg-[#151515]/60 backdrop-blur-xl p-1.5 rounded-full border border-white/10 shadow-[0_8px_32px_rgba(0,0,0,0.5)] flex items-center max-w-3xl mx-auto transition-all hover:border-white/20 hover:bg-[#151515]/80">
        <div class="pl-4 text-gray-500"><i class="fa-solid fa-search"></i></div>
        <input type="text" id="searchInput" placeholder="Rechercher un cours..." class="bg-transparent border-none w-full text-sm px-3 py-2 focus:ring-0 text-white placeholder-gray-600 font-medium">
        <div class="h-6 w-px bg-white/10 mx-2"></div>
        <div class="relative w-8 h-8 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition cursor-pointer mr-1 group">
            <i id="filterIcon" class="fa-solid fa-filter text-gray-400 text-xs group-hover:text-white transition-colors"></i>
            <select id="matiereFilter" onchange="handleFilterChange(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" title="Filtrer par matière">
                <option value="all">Toutes</option>
            </select>
        </div>
    </div>
</div>

        <div id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6"></div>
        <div id="emptyState" class="hidden text-center py-20 text-gray-500">Aucun résultat</div>
</div>
	<div id="calendarView" class="hidden animate-fade-in-up h-full">
        <div class="flex flex-col lg:flex-row gap-6 h-full">
            
            <div class="flex-grow card-panel rounded-3xl p-8 shadow-2xl flex flex-col">
                
                <div class="flex justify-between items-center mb-8">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleCalendarView()" class="w-10 h-10 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition group">
                            <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                        </button>
                        
                        <h2 class="text-3xl font-display font-black text-white tracking-tight flex items-center gap-3">
                            <i class="fa-solid fa-calendar-days text-blue-400"></i>
                            <span id="calMonthYear">Octobre 2023</span>
                        </h2>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition"><i class="fa-solid fa-chevron-left"></i></button>
                        <button onclick="changeMonth(1)" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-7 mb-4 text-center">
                    <div class="text-xs font-bold text-gray-500 uppercase">Lun</div>
                    <div class="text-xs font-bold text-gray-500 uppercase">Mar</div>
                    <div class="text-xs font-bold text-gray-500 uppercase">Mer</div>
                    <div class="text-xs font-bold text-gray-500 uppercase">Jeu</div>
                    <div class="text-xs font-bold text-gray-500 uppercase">Ven</div>
                    <div class="text-xs font-bold text-gray-500 uppercase">Sam</div>
                    <div class="text-xs font-bold text-gray-500 uppercase">Dim</div>
                </div>

                <div id="calendarGrid" class="grid grid-cols-7 gap-2 overflow-y-auto custom-scrollbar pr-1 flex-grow content-start"></div>
            </div>

            <div class="w-full lg:w-96 flex flex-col gap-4">
                
                <div class="bg-blue-900/20 border border-blue-500/30 rounded-2xl p-6 flex items-center justify-between">
                    <div>
                        <div class="text-xs font-bold text-blue-400 uppercase tracking-widest">Planning du</div>
                        <h3 class="text-2xl font-black text-white" id="selectedDateLabel">Aujourd'hui</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                </div>

                <div class="relative">
                    <input type="text" id="calendarSearchInput" placeholder="Planifier un item..." 
                           class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-sm focus:border-blue-500 transition text-white" 
                           autocomplete="off" 
                           onkeypress="if(event.key === 'Enter') addPlanningItem()">
                    
                    <i class="fa-solid fa-search absolute right-4 top-3.5 text-gray-500 text-sm"></i>
                    
                    <div id="calendarAutocompleteList" class="autocomplete-list hidden"></div>
                </div>

                <div class="card-panel rounded-2xl p-4 flex-grow flex flex-col overflow-hidden">
                    <div id="dayItemsList" class="flex-grow overflow-y-auto custom-scrollbar space-y-3 pr-1">
                        </div>
                </div>
            </div>
        </div>
    </div>

<div id="itemDetailView" class="hidden animate-fade-in-up h-full flex flex-col">

<div class="flex flex-col gap-6 mb-8">
                
                <div>
                    <button onclick="closeItemDetail()" class="w-10 h-10 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10 transition group">
                        <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                    </button>
                </div>

                <div class="flex items-center gap-6">
                    
                    <div id="detailNumberContainer" class="w-24 h-24 rounded-full flex-shrink-0 flex items-center justify-center border border-white/10 bg-white/5 shadow-2xl transition-all duration-500 relative overflow-hidden group">
                        
                        <div id="detailNumberBg" class="absolute inset-0 opacity-20 transition-colors duration-500 z-0"></div>
                        
                        <i id="detailNumberIconGhost" class="absolute fa-solid fa-heart-pulse text-4xl opacity-40 z-10 transition-all duration-500 transform scale-125 rotate-12"></i>

                        <span id="detailItemIdDisplay" class="text-4xl font-display font-black text-white/90 tracking-tighter z-20 drop-shadow-md">000</span>
                    
                    </div>

                    <div class="h-16 w-1 bg-white/10 rounded-full"></div>

                    <div class="flex flex-col justify-center gap-1">
                        
                        <div class="flex items-center gap-2" id="detailMatiereBadge">
                            <i id="detailMatiereIcon" class="fa-solid fa-heart-pulse text-sm"></i>
                            <span id="detailMatiere" class="text-xs font-bold uppercase tracking-[0.15em]">MATIÈRE</span>
                        </div>

                        <h2 id="detailTitle" class="text-2xl md:text-4xl font-display font-black text-white leading-tight tracking-tight max-w-4xl">
                            Titre de l'Item
                        </h2>
                    </div>

                    <div class="ml-auto flex items-center gap-3 flex-shrink-0 h-14"> <div class="flex flex-row gap-2 h-full">
        
        <button onclick="startRevisionChat(currentItemId, document.getElementById('detailTitle').innerText)" 
                class="w-14 h-full flex items-center justify-center rounded-xl border border-indigo-500/30 bg-indigo-500/10 text-indigo-400 hover:text-white hover:bg-indigo-500/40 transition-all hover:scale-105 hover:shadow-[0_0_15px_rgba(99,102,241,0.3)] group" 
                title="Interroger le Tuteur IA">
            <i class="fa-solid fa-microchip text-xl group-hover:animate-pulse"></i>
        </button>

        <button onclick="openErrorModal()" 
                class="w-14 h-full flex items-center justify-center rounded-xl border border-red-500/30 bg-red-500/10 text-red-400 hover:text-white hover:bg-red-500/40 transition-all hover:scale-105 hover:shadow-[0_0_15px_rgba(239,68,68,0.3)] relative group" 
                title="Boîte à Erreurs">
            <i class="fa-solid fa-box-open text-xl"></i>
            
            <span id="errorCountLabel" class="absolute -top-1.5 -right-1.5 min-w-[18px] h-[18px] px-1 bg-red-600 rounded-full text-white font-bold text-[10px] flex items-center justify-center border border-[#111] shadow-sm hidden group-hover:bg-red-500">
                0
            </span>
        </button>
    </div>
    
    <div id="difficultyGaugeContainer" 
     class="bg-white/5 backdrop-blur-xl border rounded-xl px-4 py-1.5 w-52 h-full flex flex-col justify-center shadow-2xl relative overflow-hidden transition-all duration-300" 
     style="--glass-color: rgba(250, 204, 21, 0.4); border-color: rgba(255, 255, 255, 0.1);">
    
    <div class="absolute inset-0 opacity-40 blur-xl transition-all duration-300 pointer-events-none" id="difficultyGlow"></div>

    <div class="flex justify-between items-end mb-1.5 relative z-10">
        <span class="text-[9px] text-gray-400 font-black uppercase tracking-widest">NIVEAU</span>
        <span id="difficultyLevelLabel" class="text-xs font-bold font-mono transition-colors duration-300">...</span> 
    </div>
    
    <div class="flex items-center w-full h-4 relative z-10" id="difficultySelector">
        </div>
</div>
</div>
            </div>

            <div class="flex-grow flex flex-col gap-6 overflow-hidden">
            
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-shrink-0">
        
        <div class="space-y-6 overflow-y-auto custom-scrollbar pr-2 lg:col-span-1">
            
            <div class="grid grid-cols-2 gap-3">
                
                <div class="card-panel p-4 rounded-xl flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-purple-500/20 text-purple-400 flex items-center justify-center"><i class="fa-solid fa-eye"></i></div>
                    <div>
                        <div class="text-xl font-bold text-white" id="detailVues">0</div>
                        <div class="text-[10px] text-gray-500 uppercase">Vues</div>
                    </div>
                </div>

                <div class="card-panel p-4 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-white/5 transition" onclick="toggleStatusFromDetail()">
                    <div id="detailStatusIconBg" class="w-10 h-10 rounded-full bg-gray-800 text-gray-500 flex items-center justify-center transition-colors"><i id="detailStatusIcon" class="fa-solid fa-check"></i></div>
                    <div>
                        <div class="text-sm font-bold text-white" id="detailStatusText">Non Lu</div>
                        <div class="text-[10px] text-gray-500 uppercase">Statut</div>
                    </div>

                </div>

                <div class="card-panel p-4 rounded-xl flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center"><i class="fa-solid fa-clipboard-list"></i></div>
                    <div>
                        <div class="text-xl font-bold text-white" id="detailFrequency">0</div>
                        <div class="text-[10px] text-gray-500 uppercase">Concours</div>
                    </div>
                </div>

                <div class="card-panel p-4 rounded-xl flex items-center gap-3">
                        <div id="detailDiffIconBg" class="w-10 h-10 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center"><i class="fa-solid fa-layer-group"></i></div>
                        <div>
                        <div class="text-sm font-bold text-white" id="detailOfficialDiff">Normale</div>
                        <div class="text-[10px] text-gray-500 uppercase">Difficulté R2C</div>
                    </div>
                </div>

            </div>

            <div class="card-panel p-5 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-white uppercase tracking-widest">Ressources</h3>
                </div>
                <div id="detailResourcesList" class="space-y-3">
                    </div>
            </div>                  
        </div>

        <div class="lg:col-span-2 flex flex-col gap-4 h-full overflow-hidden">
            
            <div class="flex-grow card-panel rounded-2xl flex flex-col relative group border-blue-500/30 shadow-lg overflow-hidden">
                <div class="absolute top-4 right-4 z-10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    <span class="text-[10px] text-green-400 font-mono bg-black/50 px-2 py-1 rounded" id="noteSaveIndicator">Sauvegardé</span>
                </div>

                <div class="flex flex-wrap items-center justify-center gap-2 p-2 border-b border-white/10 bg-[#151515]">
                        <div class="flex bg-black/20 rounded-lg p-1">
                        <button onclick="formatText('formatBlock', 'H2')" class="w-8 h-8 rounded hover:bg-white/10 text-gold-500 hover:text-white transition flex items-center justify-center" title="Grand Titre"><i class="fa-solid fa-heading"></i></button>
                    </div>
                    <div class="w-px h-6 bg-white/10"></div>
                    <div class="flex bg-black/20 rounded-lg p-1">
                        <button onclick="formatText('bold')" class="w-8 h-8 rounded hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-bold"></i></button>
                        <button onclick="formatText('italic')" class="w-8 h-8 rounded hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-italic"></i></button>
                        <button onclick="formatText('underline')" class="w-8 h-8 rounded hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-underline"></i></button>
                    </div>
                    <div class="w-px h-6 bg-white/10"></div>
                    <div class="flex bg-black/20 rounded-lg p-1">
                        <button onclick="formatText('insertUnorderedList')" class="w-8 h-8 rounded hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-list-ul"></i></button>
                        <button onclick="formatText('insertOrderedList')" class="w-8 h-8 rounded hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-list-ol"></i></button>
                    </div>

                    <div class="w-px h-6 bg-white/10"></div>
                    <div class="flex items-center gap-1 bg-black/20 rounded-lg p-1 px-2">
                        <button onclick="formatText('foreColor', '#e5e7eb')" class="w-5 h-5 rounded-full bg-gray-200 border border-transparent hover:scale-110 transition" title="Blanc"></button>
                        <button onclick="formatText('foreColor', '#3b82f6')" class="w-5 h-5 rounded-full bg-blue-500 border border-transparent hover:scale-110 transition" title="Bleu"></button>
                        <button onclick="formatText('foreColor', '#ef4444')" class="w-5 h-5 rounded-full bg-red-500 border border-transparent hover:scale-110 transition" title="Rouge"></button>
                        <button onclick="formatText('foreColor', '#22c55e')" class="w-5 h-5 rounded-full bg-green-500 border border-transparent hover:scale-110 transition" title="Vert"></button>
                        <button onclick="formatText('foreColor', '#eab308')" class="w-5 h-5 rounded-full bg-yellow-500 border border-transparent hover:scale-110 transition" title="Jaune"></button>
                        <button onclick="formatText('foreColor', '#a855f7')" class="w-5 h-5 rounded-full bg-purple-500 border border-transparent hover:scale-110 transition" title="Violet"></button>
                    </div>
                    <div class="ml-2 border-l border-white/10 pl-2">
                        <button onclick="formatText('removeFormat')" class="w-8 h-8 rounded hover:bg-red-500/20 text-gray-500 hover:text-red-400 transition flex items-center justify-center"><i class="fa-solid fa-eraser"></i></button>
                    </div>
                </div>

                <div id="detailNotesArea" 
                        contenteditable="true" 
                        class="w-full h-full bg-[#0a0a0a] p-6 overflow-y-auto text-gray-300 font-sans leading-relaxed focus:outline-none text-sm custom-scrollbar"
                        oninput="saveCurrentNotes()">
                </div>
            </div>
        </div>

    </div> 
    <div class="mt-6 w-full card-panel rounded-2xl p-6 relative group border-blue-500/30 shadow-lg animate-fade-in-up flex-shrink-0">
        
        <div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-fuchsia-500/20 text-fuchsia-400 flex items-center justify-center border border-fuchsia-500/30 shadow-[0_0_15px_rgba(192,38,211,0.2)]">
                    <i class="fa-solid fa-images"></i>
                </div>
                <div>
                    <h3 class="text-lg font-display font-bold text-white">Atlas & Schémas</h3>
                    <p class="text-xs text-gray-500">Galerie personnelle de l'item</p>
                </div>
            </div>
            
            <label class="cursor-pointer group/upload relative overflow-hidden" onclick="playSound('click')">
    <input type="file" accept="image/*" multiple onchange="handleImageUpload(this)" class="hidden">
    <div class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-fuchsia-600 to-purple-600 text-white hover:from-fuchsia-500 hover:to-purple-500 transition-all duration-300 flex items-center gap-2 font-bold text-xs shadow-lg shadow-purple-900/40 border border-white/10 hover:scale-105 active:scale-95">
        <i class="fa-solid fa-cloud-arrow-up text-sm"></i>
        <span class="uppercase tracking-wide">Ajouter</span>
    </div>
</label>
        </div>

        <div id="itemGalleryGrid" class="columns-2 md:columns-3 lg:columns-4 gap-4 space-y-4 pb-2">
            </div>
        
        <div id="emptyGalleryState" class="hidden py-12 flex flex-col items-center justify-center text-gray-600 border-2 border-dashed border-white/5 rounded-xl bg-black/20">
            <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mb-3">
                <i class="fa-regular fa-image text-2xl opacity-50"></i>
            </div>
            <p class="text-sm font-medium">Glissez ou ajoutez vos schémas ici</p>
        </div>
    </div>
    <div id="imageLightbox" class="fixed inset-0 z-[200] hidden bg-black/95 backdrop-blur-2xl flex items-center justify-center px-4 transition-all duration-300 opacity-0" onclick="closeLightbox()">
        <button class="absolute top-6 right-6 w-12 h-12 rounded-full bg-white/10 hover:bg-red-500 text-white transition flex items-center justify-center z-50 backdrop-blur-md border border-white/10">
            <i class="fa-solid fa-times text-xl"></i>
        </button>
        <img id="lightboxImg" src="" class="max-w-[80vw] max-h-[80vh] rounded-lg shadow-2xl object-contain transform scale-95 transition-transform duration-300">
    </div>
</div>

    </main>

<div id="globalSettingsModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="glass-panel w-full max-w-2xl p-0 rounded-3xl transform scale-95 transition-all duration-300 relative overflow-hidden flex flex-col max-h-[90vh]" id="globalSettingsContent">
            
            <div class="p-6 border-b border-white/10 bg-black/40 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-800 to-black border border-white/10 flex items-center justify-center">
                        <i class="fa-solid fa-sliders text-white text-sm"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-display font-bold text-white">Paramètres</h2>
                        <p class="text-xs text-gray-400">Gérez votre profil et vos outils</p>
                    </div>
                </div>
                <button onclick="closeGlobalSettings()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition"><i class="fa-solid fa-times"></i></button>
            </div>

            <div class="p-8 overflow-y-auto custom-scrollbar space-y-8">
                
<section>
                    <h3 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i class="fa-solid fa-user"></i> Identité</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Avatar</label>
                            <div class="grid grid-cols-5 gap-2" id="avatarGrid"></div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Nom Complet</label>
                                <input type="text" id="settingName" placeholder="Dr. House" class="w-full bg-[#151515] border border-white/10 rounded-xl px-4 py-3 text-white focus:border-blue-500 transition text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Alias (Affichage)</label>
                                <input type="text" id="settingAlias" placeholder="Docteur" class="w-full bg-[#151515] border border-white/10 rounded-xl px-4 py-3 text-white focus:border-blue-500 transition text-sm">
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-[#151515] p-4 rounded-xl border border-white/5 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center transition-colors" id="soundIconBg">
                                <i class="fa-solid fa-volume-high" id="soundIconSettings"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-white">Effets Sonores</p>
                                <p class="text-[10px] text-gray-500">Bruitages et musiques d'ambiance</p>
                            </div>
                        </div>
                        
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="settingSoundToggle" class="sr-only peer" onchange="toggleSoundPreview(this)">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    </section>

                <div class="h-px w-full bg-white/5"></div>

                </section>

<div class="mt-6 pt-6 border-t border-white/5">
    <h3 class="text-xs font-bold text-green-400 uppercase tracking-widest mb-4 flex items-center gap-2">
        <i class="fa-solid fa-shield-halved"></i> Sécurité
    </h3>
    
    <div class="bg-[#151515] p-5 rounded-xl border border-white/5 space-y-4">
        <div>
            <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Nouveau mot de passe</label>
            <div class="relative">
                <input type="password" id="settingNewPassword" placeholder="6 caractères minimum" 
                       class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-green-500 transition text-sm">
                <i class="fa-solid fa-lock absolute right-4 top-3.5 text-gray-600"></i>
            </div>
        </div>
        
        <button onclick="updateUserPassword()" class="w-full py-2 rounded-lg bg-green-500/10 border border-green-500/30 text-green-400 font-bold text-xs hover:bg-green-500 hover:text-white transition flex items-center justify-center gap-2">
            <i class="fa-solid fa-rotate"></i> Mettre à jour le mot de passe
        </button>
        
        <p class="text-[9px] text-gray-600 italic text-center">
            Par sécurité, une reconnexion récente peut être requise.
        </p>
    </div>
</div>

                <div class="h-px w-full bg-white/5"></div>

                <section>
    <h3 class="text-xs font-bold text-orange-500 uppercase tracking-widest mb-4 flex items-center gap-2">
        <i class="fa-solid fa-flag-checkered"></i> Objectif Concours
    </h3>
    
    <div class="bg-orange-500/5 border border-orange-500/20 rounded-2xl p-5 flex flex-col md:flex-row gap-6 items-center">
        
        <div class="flex-grow w-full">
            <label class="block text-xs font-bold uppercase text-orange-500/70 mb-2">Date de l'épreuve</label>
            <input type="date" id="settingDate" class="w-full bg-black/50 border border-orange-500/30 rounded-xl px-4 py-3 text-white focus:border-orange-500 transition cursor-pointer">
        </div>
        
        <div class="text-center min-w-[120px]">
            <div class="text-xs text-gray-400 mb-1">Restant</div>
            <div class="text-3xl font-mono font-black text-white" id="settingDaysLeft">--</div>
            <div class="text-[10px] uppercase text-orange-500 font-bold tracking-widest">Jours</div>
        </div>

    </div>
</section>

                <div class="h-px w-full bg-white/5"></div>

                <section>
                    <h3 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i class="fa-solid fa-microchip"></i> IA & Données</h3>
                    <div class="mb-6">
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Clé API Google Gemini</label>
                        <div class="relative">
                            <input type="password" id="settingKey" placeholder="Collez votre clé API ici..." class="w-full bg-[#151515] border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white focus:border-purple-500 transition text-sm font-mono">
                            <i class="fa-solid fa-key absolute left-3 top-3.5 text-gray-600"></i>
                        </div>
                        <p class="text-[10px] text-gray-600 mt-2 ml-1">Nécessaire pour le Tuteur IA.</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="exportData()" class="group px-4 py-3 rounded-xl bg-[#151515] border border-white/10 hover:border-blue-500/50 hover:bg-blue-500/10 transition text-left">
                            <div class="flex items-center gap-3 mb-1">
                                <div class="w-8 h-8 rounded-lg bg-blue-500/20 text-blue-400 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-download"></i></div>
                                <span class="text-sm font-bold text-white">Exporter</span>
                            </div>
                            <p class="text-[10px] text-gray-500">Sauvegarder ma config</p>
                        </button>
                        <button onclick="document.getElementById('importFile').click()" class="group px-4 py-3 rounded-xl bg-[#151515] border border-white/10 hover:border-purple-500/50 hover:bg-purple-500/10 transition text-left">
                            <div class="flex items-center gap-3 mb-1">
                                <div class="w-8 h-8 rounded-lg bg-purple-500/20 text-purple-400 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-upload"></i></div>
                                <span class="text-sm font-bold text-white">Importer</span>
                            </div>
                            <p class="text-[10px] text-gray-500">Charger une config</p>
                        </button>
                        <input type="file" id="importFile" class="hidden" onchange="importData(this)">
                    </div>

                    <div class="mt-4 pt-4 border-t border-white/5">
                        <button onclick="startTutorial(); closeGlobalSettings()" class="text-xs font-bold uppercase text-blue-400 hover:text-white transition flex items-center gap-2">
                            <i class="fa-solid fa-circle-question"></i>
                            Relancer le tutoriel
                        </button>
                    </div>

                    <div class="mt-8 pt-6 border-t border-white/5">
                        <h3 class="text-xs font-bold text-red-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-triangle-exclamation"></i> Attention
                        </h3>
                        <button onclick="resetProgress()" class="w-full py-3 rounded-xl border border-red-500/30 bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition font-bold text-sm flex items-center justify-center gap-2 group">
                            <i class="fa-solid fa-trash-can group-hover:animate-bounce"></i> 
                            Réinitialiser toute la progression
                        </button>
                        <p class="text-[10px] text-gray-500 mt-2 text-center">
                            Efface : XP, Niveaux, Statuts, Vues, ToDos.<br>
                            <span class="text-gray-400">Conserve : Vos liens (Vidéos/Fiches), Clé API, Profil.</span>
                        </p>
                    </div>

                </section>
            </div>

            <div class="p-6 border-t border-white/10 bg-black/40 flex justify-end gap-3">
                <button onclick="closeGlobalSettings()" class="px-6 py-3 rounded-xl text-sm font-bold text-gray-400 hover:text-white transition">Annuler</button>
                <button onclick="saveGlobalSettings()" class="px-8 py-3 rounded-xl bg-white text-black text-sm font-bold hover:bg-gray-200 transition shadow-lg flex items-center gap-2"><span>Enregistrer tout</span><i class="fa-solid fa-check"></i></button>
            </div>

        </div>
    </div>

    <div id="playerModal" class="hidden fixed inset-0 z-[80] modal-backdrop flex items-center justify-center px-4 transition-all duration-300 opacity-0 scale-95"><div id="playerWrapper" class="bg-[#111] border border-white/10 rounded-2xl shadow-2xl relative overflow-hidden flex flex-col transition-all duration-500 ease-out"><div class="bg-black/50 backdrop-blur-sm px-6 py-4 border-b border-white/5 flex justify-between items-center z-20 absolute top-0 w-full"><h3 class="text-sm font-bold text-white font-display truncate pr-4 drop-shadow-md" id="playerTitle">Lecture</h3><button onclick="closePlayer()" class="w-8 h-8 rounded-full bg-black/50 flex items-center justify-center text-gray-300 hover:text-white hover:bg-red-500/80 transition"><i class="fa-solid fa-times"></i></button></div><div class="relative bg-black flex items-center justify-center w-full h-full" id="playerContainer"><div id="playerLoader" class="absolute inset-0 flex flex-col items-center justify-center bg-[#0a0a0a] z-10"><div class="w-12 h-12 bg-white text-black flex items-center justify-center font-display font-black text-xl tracking-tighter rounded-sm animate-pulse-fast">UM</div></div></div></div></div>
    <div id="addModal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center px-4"><div class="bg-[#111] border border-white/10 rounded-3xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white font-display" id="modalTitle">Ajouter</h3><button onclick="closeModal()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button></div><div class="space-y-4"><div id="itemInputGroup"><label class="block text-xs font-bold uppercase text-gray-500 mb-2">Numéro d'Item</label><input type="number" id="targetItem" placeholder="Ex: 331" class="w-full bg-[#222] border border-[#333] rounded-xl px-4 py-3 text-white focus:border-white transition"></div><div id="typeInputGroup"><label class="block text-xs font-bold uppercase text-gray-500 mb-2">Format</label><div class="grid grid-cols-2 gap-3"><label class="cursor-pointer"><input type="radio" name="resType" value="video" class="peer sr-only" checked><div class="p-3 bg-[#222] rounded-xl text-center text-gray-500 peer-checked:text-red-500 peer-checked:bg-red-500/10 border border-transparent peer-checked:border-red-500/20 transition"><i class="fa-solid fa-video"></i> Vidéo</div></label><label class="cursor-pointer"><input type="radio" name="resType" value="audio" class="peer sr-only"><div class="p-3 bg-[#222] rounded-xl text-center text-gray-500 peer-checked:text-yellow-500 peer-checked:bg-yellow-500/10 border border-transparent peer-checked:border-yellow-500/20 transition"><i class="fa-solid fa-headphones"></i> Audio</div></label><label class="cursor-pointer"><input type="radio" name="resType" value="flash" class="peer sr-only"><div class="p-3 bg-[#222] rounded-xl text-center text-gray-500 peer-checked:text-purple-500 peer-checked:bg-purple-500/10 border border-transparent peer-checked:border-purple-500/20 transition"><i class="fa-solid fa-bolt"></i> Flash</div></label><label class="cursor-pointer"><input type="radio" name="resType" value="fiche" class="peer sr-only"><div class="p-3 bg-[#222] rounded-xl text-center text-gray-500 peer-checked:text-blue-500 peer-checked:bg-blue-500/10 border border-transparent peer-checked:border-blue-500/20 transition"><i class="fa-solid fa-file-pdf"></i> Fiche</div></label></div></div><div><div id="nameInputGroup" class="mb-4">
    <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Titre (Optionnel)</label>
    <input type="text" id="resourceName" placeholder="Ex: Cours du Collège, Vidéo Dr. Astuce..." class="w-full bg-[#222] border border-[#333] rounded-xl px-4 py-3 text-white focus:border-white transition">
</div><label class="block text-xs font-bold uppercase text-gray-500 mb-2">Lien URL</label><input type="text" id="newLink" placeholder="https://..." class="w-full bg-[#222] border border-[#333] rounded-xl px-4 py-3 text-white text-sm focus:border-white transition"></div></div><div class="flex justify-end gap-3 mt-8"><button onclick="closeModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm font-medium">Annuler</button><button onclick="attachResource()" class="px-8 py-3 bg-white text-black rounded-xl text-sm font-bold hover:bg-gray-200 transition shadow-lg">Enregistrer</button></div></div></div>
<div id="linkModal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="glass-panel w-full max-w-sm p-6 rounded-2xl transform scale-95 transition-all duration-300">
            <h3 class="text-lg font-display font-bold text-white mb-4 flex items-center gap-2">
                <i class="fa-solid fa-link text-blue-400"></i> Nouveau Raccourci
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Nom du site</label>
                    <input type="text" id="linkName" placeholder="Ex: SIDES, AnkiWeb..." class="w-full bg-[#151515] border border-white/10 rounded-xl px-4 py-3 text-white focus:border-blue-500 transition text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-2">URL (Lien)</label>
                    <input type="text" id="linkUrl" placeholder="https://..." class="w-full bg-[#151515] border border-white/10 rounded-xl px-4 py-3 text-white focus:border-blue-500 transition text-sm">
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeLinkModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm font-medium">Annuler</button>
                <button onclick="saveCustomLink()" class="px-6 py-2 bg-white text-black rounded-xl text-sm font-bold hover:bg-gray-200 transition shadow-lg">Ajouter</button>
            </div>
        </div>
    </div>
<div id="resourceListModal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/90 backdrop-blur-sm transition-opacity duration-300 opacity-0">
    <div class="glass-panel w-full max-w-lg p-6 rounded-2xl transform scale-95 transition-all duration-300 flex flex-col max-h-[80vh]">
        
        <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
            <h3 class="text-xl font-display font-bold text-white flex items-center gap-3">
                <i id="resListIcon" class="fa-solid fa-layer-group"></i>
                <span id="resListTitle">Ressources</span>
            </h3>
            <button onclick="closeResourceListModal()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>

        <div id="resListContainer" class="flex-grow overflow-y-auto custom-scrollbar space-y-3 pr-2">
            </div>

        <div class="mt-6 pt-4 border-t border-white/10">
            <button id="resListAddBtn" class="w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm shadow-lg flex items-center justify-center gap-2 transition-transform hover:scale-105 active:scale-95">
                <i class="fa-solid fa-plus"></i>
                <span>Ajouter une nouvelle ressource</span>
            </button>
        </div>
    </div>
</div>

    <div id="aiModal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center px-4"><div class="bg-[#111] border border-white/10 rounded-3xl w-full max-w-2xl h-[80vh] flex flex-col shadow-2xl"><div class="px-6 py-4 border-b border-white/5 flex justify-between items-center"><h3 class="font-bold text-white flex items-center gap-2" id="aiModalTitle"><i class="fa-solid fa-microchip text-purple-400"></i> Assistant IA</h3><button onclick="closeAiModal()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button></div><div id="aiLoading" class="hidden absolute inset-0 z-50 bg-[#0a0a0a] flex flex-col items-center justify-center"><div class="w-12 h-12 bg-white text-black flex items-center justify-center font-display font-black text-xl tracking-tighter rounded-sm animate-pulse-fast">IA</div><p class="mt-4 text-gray-500 text-sm">Réflexion en cours...</p></div><div id="aiContent" class="flex-grow overflow-y-auto p-6 bg-[#0a0a0a] flashcard-content max-w-none prose prose-invert prose-p:text-gray-300 prose-headings:text-white hidden"></div><div id="tutorChatInterface" class="hidden flex flex-col h-full overflow-hidden"><div id="chatHistory" class="flex-grow overflow-y-auto p-4 space-y-4 bg-[#0a0a0a] scroll-smooth"></div><div class="p-4 border-t border-white/10 bg-[#111] flex gap-2"><input type="text" id="chatInput" class="flex-grow bg-[#222] border border-[#333] rounded-xl px-4 py-3 text-white focus:border-blue-500 transition text-sm" placeholder="Posez votre question sur l'item..." onkeypress="if(event.key === 'Enter') sendChatMessage()"><button onclick="sendChatMessage()" class="w-12 h-12 flex items-center justify-center bg-blue-600 text-white rounded-xl hover:bg-blue-500 transition"><i class="fa-solid fa-paper-plane"></i></button></div></div></div></div>
    <div id="confirmModal" class="hidden fixed inset-0 z-[90] modal-backdrop flex items-center justify-center px-4"><div class="bg-[#111] border border-white/10 rounded-2xl p-6 shadow-2xl max-w-sm w-full"><h3 class="text-lg font-bold text-white mb-2">Confirmation</h3><p class="text-gray-400 text-sm mb-6">Voulez-vous vraiment supprimer cette ressource ?</p><div class="flex justify-end gap-3"><button onclick="closeConfirmModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm font-medium">Non</button><button id="confirmBtnAction" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700">Oui, supprimer</button></div></div></div>

	<div id="errorModal" class="fixed inset-0 z-[150] hidden flex items-center justify-center bg-black/90 backdrop-blur-md transition-opacity duration-300 opacity-0">
        <div class="glass-panel w-full max-w-3xl h-[80vh] rounded-3xl transform scale-95 transition-all duration-300 flex flex-col overflow-hidden relative">
            
            <div class="p-6 border-b border-white/10 bg-black/40 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-red-500/20 border border-red-500/30 flex items-center justify-center text-red-400">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-display font-bold text-white">Mes Pièges & Erreurs</h3>
                        <p class="text-xs text-gray-400">Créez des flashcards pour ne plus jamais vous tromper.</p>
                    </div>
                </div>
                <button onclick="closeErrorModal()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition"><i class="fa-solid fa-times"></i></button>
            </div>

            <div class="flex-grow p-6 overflow-y-auto custom-scrollbar bg-[#0a0a0a]">
                <div id="errorCardsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 auto-rows-fr">
                    </div>
                
                <div id="emptyErrorState" class="hidden flex flex-col items-center justify-center h-full text-gray-600 opacity-50 mt-10">
                    <i class="fa-solid fa-box-open text-4xl mb-4"></i>
                    <p class="text-sm">La boîte est vide. Ajoutez votre première erreur !</p>
                </div>
            </div>

            <div class="p-4 border-t border-white/10 bg-[#111] flex gap-2 items-center">
                <input type="text" id="newErrorInput" placeholder="Écrivez un piège, une erreur fréquente ou un chiffre clé..." 
                       class="flex-grow bg-[#222] border border-white/10 rounded-xl px-4 py-3 text-white focus:border-red-500 transition text-sm"
                       onkeypress="if(event.key === 'Enter') addErrorCard()">
                
                <button onclick="addErrorCard()" class="px-6 py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-red-900/20 flex items-center gap-2 transition hover:scale-105">
                    <span>Ajouter</span>
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>
    </div>

<div id="resetConfirmModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/90 backdrop-blur-xl transition-opacity duration-300 opacity-0">
        <div class="glass-panel w-full max-w-md p-1 rounded-3xl transform scale-95 transition-all duration-300 border border-red-500/30 shadow-[0_0_50px_rgba(220,38,38,0.2)]">
            
            <div class="bg-[#0f0505] rounded-[20px] p-8 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-red-600/10 blur-[80px] rounded-full pointer-events-none"></div>

                <div class="flex flex-col items-center text-center mb-6">
                    <div class="w-16 h-16 rounded-2xl bg-red-500/10 border border-red-500/20 flex items-center justify-center mb-4 text-red-500 shadow-[0_0_20px_rgba(220,38,38,0.2)] animate-pulse">
                        <i class="fa-solid fa-radiation text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-display font-black text-white uppercase tracking-wide">Reset Usine</h3>
                    <p class="text-red-400 text-sm font-bold mt-1">Irréversible</p>
                </div>

                <div class="bg-red-900/10 border border-red-500/10 rounded-xl p-4 mb-8 text-left">
                    <p class="text-gray-400 text-xs mb-2 uppercase font-bold tracking-wider">Ce qui sera supprimé :</p>
                    <ul class="text-sm text-gray-300 space-y-1.5">
                        <li class="flex items-center gap-2"><i class="fa-solid fa-circle-xmark text-red-500 text-xs"></i> Toute la progression & XP</li>
                        <li class="flex items-center gap-2"><i class="fa-solid fa-circle-xmark text-red-500 text-xs"></i> Calendrier & Historique</li>
                        <li class="flex items-center gap-2"><i class="fa-solid fa-circle-xmark text-red-500 text-xs"></i> Notes, Erreurs & Difficultés</li>
                        <li class="flex items-center gap-2"><i class="fa-solid fa-circle-xmark text-red-500 text-xs"></i> Liens ajoutés (Vidéos/Fiches)</li>
                    </ul>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeResetModal()" class="py-3 rounded-xl bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white font-bold text-sm transition">
                        Annuler
                    </button>
                    <button onclick="executeFullReset()" class="py-3 rounded-xl bg-red-600 hover:bg-red-500 text-white font-bold text-sm shadow-lg shadow-red-900/40 transition flex items-center justify-center gap-2 group">
                        <span>Tout Effacer</span>
                        <i class="fa-solid fa-skull group-hover:rotate-12 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

<div id="importConfirmModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/90 backdrop-blur-xl transition-opacity duration-300 opacity-0">
        <div class="glass-panel w-full max-w-md p-1 rounded-3xl transform scale-95 transition-all duration-300 border border-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.1)]">
            
            <div class="bg-[#0a0a10] rounded-[20px] p-8 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-600/10 blur-[80px] rounded-full pointer-events-none"></div>

                <div class="flex flex-col items-center text-center mb-6">
                    <div class="w-16 h-16 rounded-2xl bg-blue-500/10 border border-blue-500/20 flex items-center justify-center mb-4 text-blue-500 shadow-[0_0_20px_rgba(59,130,246,0.2)]">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-display font-black text-white uppercase tracking-wide">Confirmer l'Import</h3>
                    <p class="text-blue-400 text-sm font-bold mt-1">Écraser les données actuelles</p>
                </div>

                <div class="bg-blue-900/10 border border-blue-500/10 rounded-xl p-4 mb-8 text-left">
                    <p class="text-gray-300 text-sm">
                        L'importation va **REMPLACER** toutes vos données existantes (Statuts, XP, Notes, etc.) par celles contenues dans le fichier **ultimed_config.json**.
                    </p>
                    <p class="text-red-400 text-xs mt-2 font-bold">
                        Ceci est irréversible. Confirmez-vous l'écrasement ?
                    </p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeImportModal()" class="py-3 rounded-xl bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white font-bold text-sm transition">
                        Annuler
                    </button>
                    <button id="confirmImportBtn" class="py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm shadow-lg shadow-blue-900/40 transition flex items-center justify-center gap-2">
                        <span>Oui, Remplacer</span>
                        <i class="fa-solid fa-file-import"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="chronoStartOverlay" class="fixed inset-0 z-[200] hidden flex flex-col items-center justify-center w-screen h-screen bg-black/80 backdrop-blur-xl transition-opacity duration-700 opacity-0 pointer-events-none">
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-[500px] h-[500px] bg-cyan-500/20 blur-[120px] rounded-full"></div>
        </div>
        <div class="relative z-10 flex flex-col items-center transform scale-110">
            <div class="relative mb-8">
                <div class="absolute inset-0 rounded-full border border-cyan-500/30 animate-ping opacity-20"></div>
                <div class="absolute inset-0 rounded-full border border-cyan-400/50 animate-[spin_3s_linear_infinite]"></div>
                <div class="w-32 h-32 rounded-full bg-cyan-900/20 border border-cyan-500/30 flex items-center justify-center shadow-[0_0_30px_rgba(34,211,238,0.3)] backdrop-blur-md">
                    <i class="fa-solid fa-dragon text-5xl text-cyan-400 drop-shadow-[0_0_15px_rgba(34,211,238,0.8)] animate-pulse"></i>
                </div>
            </div>
            <div class="text-center space-y-3">
                <h2 class="text-4xl md:text-5xl font-display font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-200 to-blue-500 tracking-[0.15em] uppercase drop-shadow-2xl animate-fade-in-up">
                    C'EST PARTI ! 
                </h2>
                <div class="flex items-center justify-center gap-4 opacity-80">
                    <div class="h-px w-12 bg-gradient-to-r from-transparent to-cyan-500"></div>
                    <p class="text-cyan-100 font-mono text-sm font-bold uppercase tracking-widest">
                        Focus Concours : Maximal
                    </p>
                    <div class="h-px w-12 bg-gradient-to-l from-transparent to-cyan-500"></div>
                </div>
            </div>
        </div>
    </div>

<div id="fullScreenNotesModal" class="fixed inset-0 z-[150] hidden flex items-center justify-center bg-black/90 backdrop-blur-xl transition-opacity duration-300 opacity-0">
    <div class="w-full h-full md:w-[90%] md:h-[90%] bg-[#0a0a0a] border border-white/10 rounded-none md:rounded-3xl shadow-2xl flex flex-col overflow-hidden relative transform scale-95 transition-all duration-300" id="fullScreenNotesContent">
        
        <div class="p-4 md:p-6 border-b border-white/10 bg-[#111] flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center" id="fsNoteIconBg">
                    <i id="fsNoteIcon" class="fa-solid fa-book text-xl text-gray-400"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-display font-black text-white tracking-tight" id="fsNoteTitle">Notes Générales</h2>
                    <p class="text-xs text-gray-500 font-mono uppercase tracking-widest">Éditeur Complet</p>
                </div>
            </div>
            
            <div class="flex gap-3">
                <span id="fsSaveIndicator" class="text-xs font-bold text-green-500 self-center opacity-0 transition-opacity mr-4">SAUVEGARDÉ</span>
                <button onclick="closeFullScreenNotes()" class="px-6 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-white font-bold transition flex items-center gap-2">
                    <span>Fermer</span>
                    <i class="fa-solid fa-compress"></i>
                </button>
            </div>
        </div>

        <div class="flex flex-wrap items-center gap-2 p-3 border-b border-white/10 bg-[#151515]">
            <div class="flex bg-black/20 rounded-lg p-1">
                <button onclick="formatFullNote('formatBlock', 'H2')" class="w-8 h-8 rounded hover:bg-white/10 text-yellow-500 hover:text-white transition flex items-center justify-center" title="Grand Titre"><i class="fa-solid fa-heading"></i></button>
            </div>
            <div class="w-px h-6 bg-white/10"></div>
            <div class="flex bg-black/20 rounded-lg p-1">
                <button onclick="formatFullNote('bold')" class="w-8 h-8 rounded hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-bold"></i></button>
                <button onclick="formatFullNote('italic')" class="w-8 h-8 rounded hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-italic"></i></button>
                <button onclick="formatFullNote('underline')" class="w-8 h-8 rounded hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-underline"></i></button>
            </div>
            <div class="w-px h-6 bg-white/10"></div>
            <div class="flex bg-black/20 rounded-lg p-1">
                <button onclick="formatFullNote('insertUnorderedList')" class="w-8 h-8 rounded hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-list-ul"></i></button>
                <button onclick="formatFullNote('insertOrderedList')" class="w-8 h-8 rounded hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-list-ol"></i></button>
            </div>
            <div class="w-px h-6 bg-white/10"></div>
            <div class="flex items-center gap-1 bg-black/20 rounded-lg p-1 px-2">
                <button onclick="formatFullNote('foreColor', '#e5e7eb')" class="w-5 h-5 rounded-full bg-gray-200 border border-transparent hover:scale-110 transition" title="Blanc"></button>
                <button onclick="formatFullNote('foreColor', '#3b82f6')" class="w-5 h-5 rounded-full bg-blue-500 border border-transparent hover:scale-110 transition" title="Bleu"></button>
                <button onclick="formatFullNote('foreColor', '#ef4444')" class="w-5 h-5 rounded-full bg-red-500 border border-transparent hover:scale-110 transition" title="Rouge"></button>
                <button onclick="formatFullNote('foreColor', '#22c55e')" class="w-5 h-5 rounded-full bg-green-500 border border-transparent hover:scale-110 transition" title="Vert"></button>
                <button onclick="formatFullNote('foreColor', '#eab308')" class="w-5 h-5 rounded-full bg-yellow-500 border border-transparent hover:scale-110 transition" title="Jaune"></button>
                <button onclick="formatFullNote('foreColor', '#a855f7')" class="w-5 h-5 rounded-full bg-purple-500 border border-transparent hover:scale-110 transition" title="Violet"></button>
            </div>
             <div class="ml-auto border-l border-white/10 pl-2">
                <button onclick="formatFullNote('removeFormat')" class="w-8 h-8 rounded hover:bg-red-500/20 text-gray-500 hover:text-red-400 transition flex items-center justify-center" title="Effacer le formatage"><i class="fa-solid fa-eraser"></i></button>
            </div>
        </div>

        <div id="fullScreenEditor" 
             contenteditable="true" 
             class="flex-grow w-full bg-[#0a0a0a] p-8 overflow-y-auto text-gray-300 font-sans leading-relaxed focus:outline-none text-base custom-scrollbar prose prose-invert max-w-none"
             oninput="saveFullScreenContent()">
        </div>
    </div>
</div>

<div id="xpModal" class="fixed inset-0 z-[160] hidden flex items-center justify-center bg-black/90 backdrop-blur-xl transition-opacity duration-300 opacity-0">
    <div class="w-full max-w-lg bg-[#0f0f13] border border-blue-500/30 rounded-3xl shadow-[0_0_50px_rgba(59,130,246,0.2)] relative overflow-hidden transform scale-95 transition-all duration-300" id="xpModalContent">
        
        <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-blue-900/40 to-transparent"></div>
        
        <div class="relative p-6 text-center border-b border-white/5">
            <div class="w-20 h-20 mx-auto bg-blue-500/20 rounded-full flex items-center justify-center border border-blue-400/50 mb-3 shadow-[0_0_20px_rgba(59,130,246,0.4)]">
                <i id="xpModalIcon" class="fa-solid fa-dragon text-3xl text-blue-400"></i>
            </div>
            <h2 class="text-2xl font-display font-black text-white uppercase tracking-widest">Niveau <span id="xpModalLevel" class="text-blue-400">0</span></h2>
            <p class="text-xs text-blue-200/60 font-mono uppercase mt-1">Grade : Interne Novice</p>
            <button onclick="closeXPModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white transition"><i class="fa-solid fa-times"></i></button>
        </div>

        <div class="p-6 space-y-6">
            
            <div>
                <div class="flex justify-between text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">
                    <span>Progression Niveau</span>
                    <span id="xpModalProgressText">0 / 1000 XP</span>
                </div>
                <div class="h-4 bg-black rounded-full border border-white/10 overflow-hidden relative">
                    <div id="xpModalBar" class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 shadow-[0_0_15px_rgba(59,130,246,0.6)] transition-all duration-1000" style="width: 0%"></div>
                    <div class="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMDUiLz4KPC9zdmc+')] opacity-30"></div>
                </div>
                <p class="text-[10px] text-right text-gray-500 mt-1 italic">Plus que <span id="xpModalMissing" class="text-white font-bold">1000</span> XP pour le prochain niveau</p>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white/5 p-3 rounded-xl border border-white/5 text-center">
                    <div class="text-2xl font-black text-green-400" id="xpModalLu">0</div>
                    <div class="text-[9px] text-gray-400 uppercase">Items Lus</div>
                </div>
                <div class="bg-white/5 p-3 rounded-xl border border-white/5 text-center">
                    <div class="text-2xl font-black text-gold-500" id="xpModalMaitrise">0</div>
                    <div class="text-[9px] text-gray-400 uppercase">Maîtrisés</div>
                </div>
            </div>

            <div class="bg-blue-900/10 border border-blue-500/20 rounded-xl p-4 flex items-center gap-4">
                <div class="w-12 h-12 bg-black rounded-lg flex items-center justify-center border border-white/10">
                    <i id="nextRewardIcon" class="fa-solid fa-question text-gray-600 text-xl"></i>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-white">Prochain Avatar</h4>
                    <p class="text-[10px] text-blue-300" id="nextRewardText">Débloqué au niveau supérieur</p>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="chronoModal" class="fixed inset-0 z-[160] hidden flex items-center justify-center bg-black/90 backdrop-blur-xl transition-opacity duration-300 opacity-0">
    <div class="w-full max-w-lg bg-[#120f0f] border border-orange-500/30 rounded-3xl shadow-[0_0_50px_rgba(249,115,22,0.15)] relative overflow-hidden transform scale-95 transition-all duration-300" id="chronoModalContent">
        
        <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-orange-900/40 to-transparent"></div>

        <div class="relative p-6 text-center border-b border-white/5">
            <div class="w-20 h-20 mx-auto bg-orange-500/20 rounded-full flex items-center justify-center border border-orange-400/50 mb-3 shadow-[0_0_20px_rgba(249,115,22,0.4)] animate-pulse-slow">
                <i class="fa-solid fa-hourglass-half text-3xl text-orange-400"></i>
            </div>
            <h2 class="text-2xl font-display font-black text-white uppercase tracking-widest">Objectif Concours</h2>
            <input type="date" id="modalDateInput" onchange="updateExamDateFromModal(this.value)" class="mt-2 bg-black/50 border border-white/10 text-white text-xs px-3 py-1 rounded-lg text-center uppercase tracking-widest cursor-pointer hover:border-orange-500 transition-colors">
            <button onclick="closeChronoModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white transition"><i class="fa-solid fa-times"></i></button>
        </div>

        <div class="p-6 space-y-6">
            
            <div class="flex justify-center gap-4">
                <div class="text-center">
                    <div class="text-5xl font-display font-black text-white" id="chronoDays">000</div>
                    <div class="text-[10px] font-bold text-orange-500 uppercase tracking-[0.2em]">Jours Restants</div>
                </div>
            </div>

            <div>
                <div class="flex justify-between text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">
                    <span>Temps écoulé (Année Universitaire)</span>
                    <span id="timeElapsedPct">0%</span>
                </div>
                <div class="h-3 bg-black rounded-full border border-white/10 overflow-hidden">
                    <div id="timeProgressBar" class="h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-500" style="width: 0%"></div>
                </div>
            </div>

            <div class="bg-[#0a0a0a] border border-white/5 rounded-xl p-4 flex items-start gap-3">
                <i class="fa-solid fa-quote-left text-orange-500/50 text-xl mt-1"></i>
                <div>
                    <p class="text-sm text-gray-300 italic" id="chronoQuote">"Le temps est votre ressource la plus précieuse. Ne la gaspillez pas."</p>
                </div>
            </div>

        </div>
    </div>
</div>

	<div id="subjectBurstOverlay" class="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none hidden overflow-hidden">
    <div id="subjectBurstCircle" class="rounded-full absolute"></div>
    <i id="subjectBurstIcon" class="relative z-10 text-[50vmin] opacity-0 transform transition-all"></i>
</div> 

<div id="loginOverlay" class="fixed inset-0 z-[9999] bg-[#050505] flex items-center justify-center transition-opacity duration-500 opacity-100">

    <div class="relative w-full max-w-md p-1">
        <div class="absolute inset-0 bg-blue-600/20 blur-[60px] rounded-full pointer-events-none"></div>
        
        <div class="relative card-panel rounded-3xl p-8 text-center border border-white/10 shadow-2xl bg-black/80 backdrop-blur-xl">
            <div class="mb-8">
                <i class="fa-solid fa-dragon text-5xl text-blue-500 mb-4 drop-shadow-[0_0_15px_rgba(59,130,246,0.6)] animate-pulse"></i>
                <h3 class="text-3xl font-display font-black text-white tracking-widest uppercase">Ultimed</h3>
                <p class="text-blue-400 text-xs font-bold uppercase tracking-[0.3em]">Cockpit R2C</p>
            </div>
            
            <div id="authError" class="hidden mb-4 p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-400 text-xs font-bold"></div>

            <div class="space-y-4">
                <div class="group relative">
                    <i class="fa-solid fa-envelope absolute left-4 top-4 text-gray-500 group-focus-within:text-blue-400 transition-colors"></i>
                    <input type="email" id="loginEmail" placeholder="Email" 
                           class="w-full bg-[#151515] border border-white/10 rounded-xl pl-12 pr-4 py-3 text-white text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition outline-none"
                           onkeydown="if(event.key === 'Enter') document.getElementById('loginPassword').focus()">
                </div>
                       
                <div>
                    <div class="group relative">
    <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-blue-400 transition-colors"></i>
    
    <input type="password" id="loginPassword" placeholder="Mot de passe" 
           class="w-full bg-[#151515] border border-white/10 rounded-xl pl-12 pr-10 py-3 text-white text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition outline-none"
           onkeydown="if(event.key === 'Enter') handleAuthAction()">

    <button type="button" onclick="togglePasswordVisibility()" 
            class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition-colors cursor-pointer focus:outline-none" 
            title="Afficher/Masquer">
        <i id="passwordToggleIcon" class="fa-solid fa-eye"></i>
    </button>
</div>
                </div>
            </div>
            
            <button id="authBtn" onclick="handleAuthAction()" class="w-full mt-8 py-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white rounded-xl font-bold transition shadow-lg shadow-blue-900/30 flex items-center justify-center gap-2 group">
                <span id="authBtnText">Connexion</span>
                <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
            </button>
            
            <div class="mt-6 pt-6 border-t border-white/10">
                <p class="text-gray-500 text-xs mb-2" id="toggleText">Pas encore de compte ?</p>
                <button onclick="toggleAuthMode()" class="text-white text-sm font-bold hover:text-blue-400 transition uppercase tracking-wide">
                    <span id="toggleLink">Créer un compte</span>
                </button>
            </div>
        </div>
    </div>
</div>

    <script>

        /* ==========================================
            ultimed Ultimate Cockpit - Logic Script 
            ==========================================
        */

// --- GLOBAL VARIABLES ---
        var userResources = [], userStatus = {}, userTodos = [], courses = [], celebrationTimeout, userItemImages = {};
        var userName = "", userAlias = "Docteur", userApiKey = "", chatHistory = [], currentRevisionContext = "";
	var userExamDate = "";
        var currentNotesMatiere = "Général", currentSuggestions = [], dailySuggestionsDone = {}, currentStatusFilter = "all", userVues = {};
        var userAvatar = "fa-dragon"; 
        var userUnlockedAvatars = ['fa-dragon'];
        var sessionViewedResources = {};
        var seconds = 0;
        var isTimerRunning = false;
        var timerInterval;
	var userHistory = {};
	var userPlanning = {}; 
        var currentCalendarDate = new Date();
        var selectedCalendarDate = new Date().toISOString().split('T')[0];
	var userXP = 0;
	var userLevel = 0;
	var userLinks = [];
	var userItemNotes = {}; // Stocke les notes par ID { "154": "Texte..." }
	var userItemDifficulty = {}; // Stocke la difficulté { "154": 3 } (1 à 5)
	var userItemErrors = {};
	var userXPClaimed = {};
	var userSubjectNotes = {};
	var isRegistering = false;
	var pendingImportContent = null;
        var pendingConfirmAction = null;
	

// --- CONFIGURATION DES RÉCOMPENSES (NIVEAUX) ---
	const levelRewards = {
    2: 'fa-cat',      // Chat au niveau 2
    5: 'fa-dog',      // Chien au niveau 5
    10: 'fa-crow',    // Corbeau au niveau 10 (Expert)
    15: 'fa-otter',   // Loutre au niveau 15
    20: 'fa-fish',    // Poisson au niveau 20
    25: 'fa-spider',  // Araignée au niveau 25
    30: 'fa-horse',   // Cheval au niveau 30
    40: 'fa-frog',    // Grenouille au niveau 40
    50: 'fa-dove'     // Colombe au niveau 50 (Légendaire)
};

// --- MOTIVATIONAL QUOTES (POUR LES MILESTONES DU TIMER) ---
        const motivationalQuotes = [
            "La douleur est temporaire, la fierté est éternelle.",
            "Chaque minute compte.",
            "Ne lâche rien, Docteur.",
            "Focus maximum activé.",
            "La réussite est au bout de l'effort.",
            "Discipline = Liberté."
        ];

        // --- DINO MESSAGES (TECH STYLE) ---
        const dinoMessages = [
            "Système prêt.", "Focus activé.", "En attente d'ordres.", 
            "Batterie pleine.", "Cerveau : 100%", "Objectif : Major", 
            "Données synchronisées."
        ];

// --- GESTION MUSIQUE AVANCÉE (THÈMES) ---
const audioSystem = {
    enabled: true,
    musicVolume: 0.15,
    currentTheme: null, // On démarre sans thème défini (pour le mode aléatoire)
    isPlaying: false,
    playlist: [], 
    
    mainAudio: new Audio(),
    layer1: new Audio(),
    layer2: new Audio(),
    layer3: new Audio(),
    
    layersFinished: 0,     
    activeLayersCount: 0,  

    themes: {
        theme1: [ // Focus
            './sounds/Air/AR-01-Beginnings.mp3',
            './sounds/Melody/ML-01-Beginnings.mp3',
            './sounds/Strings/ST-01-Beginnings.mp3',
            './sounds/Undertones/UT-01-Beginnings.mp3'
        ],
        theme2: [ // Épique
            './sounds/Epic/Drive.mp3', 
            './sounds/Epic/Clean-Bass.mp3',
            './sounds/Epic/Keep-Moving.mp3',
            './sounds/Epic/Painful-Wait-A.mp3'
        ],
        theme3: [ // Drama
            { ST: './sounds/Drama/STManifesto.mp3', BP: './sounds/Drama/BPManifesto.mp3', UT: './sounds/Drama/UTManifesto.mp3' },
            { ST: './sounds/Drama/STAnthology.mp3', BP: './sounds/Drama/BPAnthology.mp3', UT: './sounds/Drama/UTAnthology.mp3' },
            { ST: './sounds/Drama/STPremise.mp3', BP: './sounds/Drama/BPPremise.mp3', UT: './sounds/Drama/UTPremise.mp3' }
        ],
        theme4: [ // Nature
            './sounds/Nature/New-Life.mp3',
            './sounds/Nature/Night-Winds.mp3',
            './sounds/Nature/Outer-Limits.mp3',
            './sounds/Nature/Summer-Woods.mp3',
            './sounds/Nature/Bright-Winds.mp3'
        ]
    },
    
    sounds: {
        success: new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3'),
        click: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
        levelUp: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),
        chronoStart: new Audio('https://assets.mixkit.co/active_storage/sfx/2986/2986-preview.mp3'),
        mastery: new Audio('https://assets.mixkit.co/active_storage/sfx/657/657-preview.mp3'),
        whoosh: new Audio('https://assets.mixkit.co/active_storage/sfx/3124/3124-preview.mp3'),
        error: new Audio('https://assets.mixkit.co/active_storage/sfx/1110/1110-preview.mp3'),
        refresh: new Audio('https://assets.mixkit.co/active_storage/sfx/2043/2043-preview.mp3'),
        subjectClick: new Audio('https://assets.mixkit.co/active_storage/sfx/1120/1120-preview.mp3'),
        creature: new Audio('https://assets.mixkit.co/active_storage/sfx/2350/2350-preview.mp3'),
	track4: new Audio('./sounds/Undertones/UT-01-Beginnings.mp3')
    }
};

// --- DATA (ITEMS R2C ENRICHIS) ---

        const rawItems = [
            {id:"1", t:"Relation médecin-malade", m:"Médecine Générale", d:"Normale", f:12},
            {id:"2", t:"Valeurs professionnelles, éthique", m:"Santé Publique", d:"Normale", f:1},
            {id:"3", t:"Raisonnement, EBM, décision partagée", m:"Médecine Générale", d:"Normale", f:2},
            {id:"4", t:"Qualité et sécurité des soins", m:"Santé Publique", d:"Normale", f:21},
            {id:"5", t:"Responsabilités, erreurs, aléa", m:"Santé Publique", d:"Normale", f:10},
            {id:"6", t:"Organisation de l'exercice clinique", m:"Santé Publique", d:"Normale", f:5},
            {id:"7", t:"Droits individuels et collectifs", m:"Médecine Légale", d:"Normale", f:10},
            {id:"8", t:"Discriminations", m:"Médecine Légale", d:"Normale", f:0},
            {id:"9", t:"Introduction à l'éthique médicale", m:"Médecine Légale", d:"Normale", f:8},
            {id:"10", t:"Approches transversales du corps", m:"Médecine Légale", d:"Normale", f:0},
            {id:"11", t:"Violences et santé", m:"Médecine Légale", d:"Normale", f:6},
            {id:"12", t:"Violences sexuelles", m:"Médecine Légale", d:"Normale", f:22},
            {id:"13", t:"Certificats médicaux. Décès", m:"Médecine Légale", d:"Normale", f:28},
            {id:"14", t:"La mort", m:"Médecine Légale", d:"Normale", f:4},
            {id:"15", t:"Soins psychiatriques sans consentement", m:"Psychiatrie", d:"Difficile", f:1},
            {id:"16", t:"Organisation du système de soins", m:"Santé Publique", d:"Difficile", f:10},
            {id:"17", t:"Télémédecine et télésanté", m:"Santé Publique", d:"Normale", f:1},
            {id:"18", t:"Santé et numérique", m:"Santé Publique", d:"Normale", f:1},
            {id:"19", t:"Sécurité sociale, assurances", m:"Santé Publique", d:"Difficile", f:16},
            {id:"20", t:"Méthodologie de la recherche", m:"Santé Publique", d:"Normale", f:20},
            {id:"21", t:"Mesure état de santé population", m:"Santé Publique", d:"Normale", f:2},
            {id:"22", t:"Maladies rares", m:"Génétique", d:"Difficile", f:0},
            {id:"23", t:"Grossesse normale", m:"Gynécologie", d:"Difficile", f:14},
            {id:"24", t:"Principales complications grossesse", m:"Gynécologie", d:"Difficile", f:16},
            {id:"25", t:"Grossesse extra-utérine", m:"Gynécologie", d:"Normale", f:14},
            {id:"26", t:"Douleur abdo femme enceinte", m:"Gynécologie", d:"Normale", f:4},
            {id:"27", t:"Prévention risques fœtaux", m:"Gynécologie", d:"Très difficile", f:20},
            {id:"28", t:"Infection urinaire grossesse", m:"Gynécologie", d:"Facile", f:5},
            {id:"29", t:"Risques professionnels maternité", m:"Médecine du Travail", d:"Difficile", f:0},
            {id:"30", t:"Prématurité et RCIU", m:"Gynécologie", d:"Difficile", f:5},
            {id:"31", t:"Accouchement et suites de couches", m:"Gynécologie", d:"Normale", f:1},
            {id:"32", t:"Soins du nouveau-né à terme", m:"Pédiatrie", d:"Normale", f:6},
            {id:"33", t:"Allaitement maternel", m:"Gynécologie", d:"Facile", f:4},
            {id:"34", t:"Suites de couches pathologiques", m:"Gynécologie", d:"Normale", f:5},
            {id:"35", t:"Anomalies du cycle / Métrorragies", m:"Gynécologie", d:"Normale", f:6},
            {id:"36", t:"Contraception", m:"Gynécologie", d:"Facile", f:17},
            {id:"37", t:"IVG", m:"Gynécologie", d:"Facile", f:10},
            {id:"38", t:"Infertilité du couple", m:"Gynécologie", d:"Difficile", f:14},
            {id:"39", t:"AMP", m:"Gynécologie", d:"Normale", f:3},
            {id:"40", t:"Algies pelviennes femme", m:"Gynécologie", d:"Normale", f:5},
            {id:"41", t:"Endométriose", m:"Gynécologie", d:"Normale", f:1},
            {id:"42", t:"Aménorrhée", m:"Gynécologie", d:"Difficile", f:8},
            {id:"43", t:"Hémorragie génitale femme", m:"Gynécologie", d:"Normale", f:4},
            {id:"44", t:"Tuméfaction pelvienne femme", m:"Gynécologie", d:"Normale", f:0},
            {id:"45", t:"Spécificités maladies génétiques", m:"Génétique", d:"Difficile", f:33},
            {id:"46", t:"Médecine génomique", m:"Génétique", d:"Normale", f:3},
            {id:"47", t:"Suivi nourrisson et enfant", m:"Pédiatrie", d:"Difficile", f:13},
            {id:"48", t:"Alimentation de l'enfant", m:"Pédiatrie", d:"Difficile", f:11},
            {id:"49", t:"Puberté normale et pathologique", m:"Pédiatrie", d:"Difficile", f:2},
            {id:"50", t:"Pathologie génito-scrotale", m:"Urologie", d:"Facile", f:4},
            {id:"51", t:"Troubles miction enfant", m:"Pédiatrie", d:"Normale", f:1},
            {id:"52", t:"Strabisme de l'enfant", m:"Ophtalmologie", d:"Normale", f:3},
            {id:"53", t:"Retard de croissance", m:"Pédiatrie", d:"Difficile", f:12},
            {id:"54", t:"Boiterie chez l'enfant", m:"Pédiatrie", d:"Normale", f:5},
            {id:"55", t:"Dév. psychomoteur enfant", m:"Pédiatrie", d:"Très difficile", f:4},
            {id:"56", t:"L'enfant handicapé", m:"Pédiatrie", d:"Normale", f:3},
            {id:"57", t:"Maltraitance et enfants en danger", m:"Pédiatrie", d:"Normale", f:16},
            {id:"58", t:"Sexualité et troubles", m:"Gynécologie", d:"Normale", f:8},
            {id:"59", t:"Sujets en précarité", m:"Médecine Générale", d:"Normale", f:10},
            {id:"60", t:"Troubles psychiques : FDR", m:"Psychiatrie", d:"Normale", f:4},
            {id:"61", t:"Classifications troubles mentaux", m:"Psychiatrie", d:"Normale", f:0},
            {id:"62", t:"Offre de soins en psychiatrie", m:"Psychiatrie", d:"Difficile", f:1},
            {id:"63", t:"Schizophrénie", m:"Psychiatrie", d:"Difficile", f:14},
            {id:"64", t:"Troubles bipolaires", m:"Psychiatrie", d:"Normale", f:7},
            {id:"65", t:"Trouble délirant persistant", m:"Psychiatrie", d:"Normale", f:0},
            {id:"66", t:"Troubles anxieux, dépressifs, TOC...", m:"Psychiatrie", d:"Très difficile", f:58},
            {id:"67", t:"Troubles neurodéveloppement", m:"Psychiatrie", d:"Difficile", f:20},
            {id:"68", t:"Troubles comportement enfant", m:"Psychiatrie", d:"Normale", f:0},
            {id:"69", t:"Troubles psychiques grossesse", m:"Psychiatrie", d:"Normale", f:3},
            {id:"70", t:"Troubles psychiques sujet âgé", m:"Psychiatrie", d:"Normale", f:1},
            {id:"71", t:"TCA", m:"Psychiatrie", d:"Normale", f:12},
            {id:"72", t:"Troubles somatoformes", m:"Psychiatrie", d:"Difficile", f:8},
            {id:"73", t:"Psychothérapies", m:"Psychiatrie", d:"Normale", f:0},
            {id:"74", t:"Psychotropes", m:"Thérapeutique", d:"Très difficile", f:9},
            {id:"75", t:"Addiction tabac", m:"Addictologie", d:"Normale", f:13},
            {id:"76", t:"Addiction alcool", m:"Addictologie", d:"Normale", f:25},
            {id:"77", t:"Addiction médicaments", m:"Addictologie", d:"Normale", f:5},
            {id:"78", t:"Addiction drogues illicites", m:"Addictologie", d:"Difficile", f:10},
            {id:"79", t:"Addictions comportementales", m:"Addictologie", d:"Normale", f:0},
            {id:"80", t:"Dopage", m:"Addictologie", d:"Normale", f:1},
            {id:"81", t:"Altération chronique vision", m:"Ophtalmologie", d:"Difficile", f:23},
            {id:"82", t:"Altération aiguë vision", m:"Ophtalmologie", d:"Difficile", f:20},
            {id:"83", t:"Infections oculaires", m:"Ophtalmologie", d:"Difficile", f:10},
            {id:"84", t:"Glaucomes", m:"Ophtalmologie", d:"Normale", f:4},
            {id:"85", t:"Troubles réfraction", m:"Ophtalmologie", d:"Normale", f:8},
            {id:"86", t:"Pathologie paupières", m:"Ophtalmologie", d:"Normale", f:3},
            {id:"87", t:"Epistaxis", m:"ORL & CMF", d:"Facile", f:14},
            {id:"88", t:"Trouble parole / Dysphonie", m:"ORL & CMF", d:"Normale", f:2},
            {id:"89", t:"Altération audition", m:"ORL & CMF", d:"Normale", f:4},
            {id:"90", t:"Pathologie glandes salivaires", m:"ORL & CMF", d:"Normale", f:2},
            {id:"91", t:"Déficit neurologique récent", m:"Neurologie", d:"Difficile", f:17},
            {id:"92", t:"Déficit moteur/sensitif membres", m:"Neurologie", d:"Normale", f:8},
            {id:"93", t:"Compression médullaire", m:"Neurologie", d:"Normale", f:13},
            {id:"94", t:"Rachialgie", m:"Rhumatologie", d:"Normale", f:16},
            {id:"95", t:"Radiculalgie et Sd canalaire", m:"Rhumatologie", d:"Difficile", f:0},
            {id:"96", t:"Neuropathies périphériques", m:"Neurologie", d:"Très difficile", f:20},
            {id:"97", t:"Guillain-Barré", m:"Neurologie", d:"Difficile", f:6},
            {id:"98", t:"Myasthénie", m:"Neurologie", d:"Normale", f:1},
            {id:"99", t:"Migraine et algies face", m:"Neurologie", d:"Difficile", f:6},
            {id:"100", t:"Céphalée inhabituelle", m:"Neurologie", d:"Normale", f:7},
            {id:"101", t:"Paralysie faciale", m:"Neurologie", d:"Difficile", f:11},
            {id:"102", t:"Diplopie", m:"Ophtalmologie", d:"Normale", f:3},
            {id:"103", t:"Vertige", m:"ORL & CMF", d:"Très difficile", f:9},
            {id:"104", t:"Sclérose en plaques", m:"Neurologie", d:"Facile", f:22},
            {id:"105", t:"Épilepsie", m:"Neurologie", d:"Difficile", f:22},
            {id:"106", t:"Parkinson", m:"Neurologie", d:"Normale", f:7},
            {id:"107", t:"Mouvements anormaux", m:"Neurologie", d:"Normale", f:6},
            {id:"108", t:"Confusion, démences", m:"Neurologie", d:"Normale", f:6},
            {id:"109", t:"Troubles marche et équilibre", m:"Neurologie", d:"Difficile", f:5},
            {id:"110", t:"Troubles du sommeil", m:"Pneumologie", d:"Normale", f:31},
            {id:"111", t:"Dermatoses faciales", m:"Dermatologie", d:"Difficile", f:7},
            {id:"112", t:"Dermatoses bulleuses", m:"Dermatologie", d:"Facile", f:21},
            {id:"113", t:"Hémangiomes", m:"Dermatologie", d:"Normale", f:8},
            {id:"114", t:"Exanthème et érythrodermie", m:"Dermatologie", d:"Très difficile", f:12},
            {id:"115", t:"Toxidermies", m:"Dermatologie", d:"Difficile", f:9},
            {id:"116", t:"Prurit", m:"Dermatologie", d:"Difficile", f:5},
            {id:"117", t:"Psoriasis", m:"Dermatologie", d:"Normale", f:12},
            {id:"118", t:"Personne handicapée", m:"MPR & Gériatrie", d:"Normale", f:16},
            {id:"119", t:"Maladie chronique et handicap", m:"MPR & Gériatrie", d:"Normale", f:7},
            {id:"120", t:"Complications immobilité", m:"Urgence Réanimation", d:"Normale", f:7},
            {id:"121", t:"Handicap psychique", m:"Psychiatrie", d:"Normale", f:2},
            {id:"122", t:"Rééducation et réadaptation", m:"MPR & Gériatrie", d:"Normale", f:18},
            {id:"123", t:"Vieillissement normal", m:"MPR & Gériatrie", d:"Normale", f:6},
            {id:"124", t:"Ménopause et andropause", m:"Gynécologie", d:"Difficile", f:10},
            {id:"125", t:"Incontinence urinaire", m:"Urologie", d:"Normale", f:13},
            {id:"126", t:"Trouble de l'érection", m:"Urologie", d:"Normale", f:4},
            {id:"127", t:"HBP", m:"Urologie", d:"Facile", f:5},
            {id:"128", t:"Ostéoporose", m:"Rhumatologie", d:"Normale", f:11},
            {id:"129", t:"Arthrose", m:"Rhumatologie", d:"Normale", f:11},
            {id:"130", t:"Sujet âgé malade", m:"MPR & Gériatrie", d:"Normale", f:9},
            {id:"131", t:"Troubles marche sujet âgé", m:"MPR & Gériatrie", d:"Normale", f:4},
            {id:"132", t:"Troubles cognitifs sujet âgé", m:"MPR & Gériatrie", d:"Difficile", f:4},
            {id:"133", t:"Autonomie et dépendance", m:"MPR & Gériatrie", d:"Difficile", f:12},
            {id:"134", t:"Douleur : physiopathologie", m:"Douleur", d:"Normale", f:7},
            {id:"135", t:"Thérapeutiques antalgiques", m:"Douleur", d:"Difficile", f:32},
            {id:"136", t:"Anesthésie", m:"Urgence Réanimation", d:"Normale", f:11},
            {id:"137", t:"Douleur chez l'enfant", m:"Pédiatrie", d:"Difficile", f:1},
            {id:"138", t:"Douleur personne vulnérable", m:"Douleur", d:"Normale", f:4},
            {id:"139", t:"Soins palliatifs (1)", m:"Soins Palliatifs", d:"Normale", f:6},
            {id:"140", t:"Soins palliatifs (2)", m:"Soins Palliatifs", d:"Normale", f:1},
            {id:"141", t:"Soins palliatifs (3)", m:"Soins Palliatifs", d:"Normale", f:14},
            {id:"142", t:"Soins palliatifs pédiatrie", m:"Soins Palliatifs", d:"Normale", f:1},
            {id:"143", t:"Soins palliatifs réanimation", m:"Soins Palliatifs", d:"Normale", f:1},
            {id:"144", t:"Deuil", m:"Psychiatrie", d:"Normale", f:4},
            {id:"145", t:"Surveillance maladies transmissibles", m:"Infectiologie", d:"Normale", f:8},
            {id:"146", t:"Vaccinations", m:"Infectiologie", d:"Difficile", f:24},
            {id:"147", t:"Fièvre aiguë", m:"Infectiologie", d:"Difficile", f:20},
            {id:"148", t:"Infections naso-sinusiennes", m:"ORL & CMF", d:"Normale", f:6},
            {id:"149", t:"Angines", m:"ORL & CMF", d:"Très facile", f:16},
            {id:"150", t:"Otites infectieuses", m:"ORL & CMF", d:"Facile", f:30},
            {id:"151", t:"Méningites", m:"Infectiologie", d:"Difficile", f:26},
            {id:"152", t:"Endocardite infectieuse", m:"Infectiologie", d:"Normale", f:11},
            {id:"153", t:"Surveillance prothèses valvulaires", m:"Cardiologie", d:"Difficile", f:1},
            {id:"154", t:"Pneumonies", m:"Pneumologie", d:"Difficile", f:64},
            {id:"155", t:"Infections cutanées", m:"Dermatologie", d:"Très difficile", f:43},
            {id:"156", t:"IOA", m:"Infectiologie", d:"Normale", f:9},
            {id:"157", t:"Bactériémie / Fongémie", m:"Infectiologie", d:"Normale", f:11},
            {id:"158", t:"Sepsis et choc septique", m:"Infectiologie", d:"Difficile", f:6},
            {id:"159", t:"Tuberculose", m:"Infectiologie", d:"Très difficile", f:22},
            {id:"160", t:"Tétanos", m:"Infectiologie", d:"Normale", f:2},
            {id:"161", t:"Infections urinaires", m:"Urologie", d:"Facile", f:29},
            {id:"162", t:"IST", m:"Dermatologie", d:"Difficile", f:28},
            {id:"163", t:"Coqueluche", m:"Infectiologie", d:"Normale", f:2},
            {id:"164", t:"Exanthèmes fébriles enfant", m:"Pédiatrie", d:"Difficile", f:7},
            {id:"165", t:"Oreillons", m:"Infectiologie", d:"Facile", f:0},
            {id:"166", t:"Grippe", m:"Infectiologie", d:"Facile", f:1},
            {id:"167", t:"Hépatites virales", m:"Hépato-Gastro", d:"Difficile", f:15},
            {id:"168", t:"Infections à herpès virus", m:"Dermatologie", d:"Normale", f:9},
            {id:"169", t:"VIH", m:"Infectiologie", d:"Normale", f:16},
            {id:"170", t:"Paludisme", m:"Infectiologie", d:"Normale", f:28},
            {id:"171", t:"Gale et pédiculose", m:"Infectiologie", d:"Difficile", f:7},
            {id:"172", t:"Parasitoses digestives", m:"Infectiologie", d:"Très difficile", f:3},
            {id:"173", t:"Zoonoses", m:"Infectiologie", d:"Difficile", f:12},
            {id:"174", t:"Infections migrants", m:"Infectiologie", d:"Difficile", f:0},
            {id:"175", t:"Voyage pays tropical", m:"Infectiologie", d:"Difficile", f:20},
            {id:"176", t:"Diarrhées infectieuses", m:"Infectiologie", d:"Difficile", f:6},
            {id:"177", t:"Anti-infectieux", m:"Infectiologie", d:"Très difficile", f:12},
            {id:"178", t:"Risques émergents", m:"Infectiologie", d:"Normale", f:2},
            {id:"179", t:"TIAC", m:"Infectiologie", d:"Normale", f:3},
            {id:"180", t:"Risques irradiations", m:"Santé Publique", d:"Normale", f:4},
            {id:"181", t:"Sécurité sanitaire", m:"Santé Publique", d:"Normale", f:3},
            {id:"182", t:"Environnement professionnel", m:"Médecine du Travail", d:"Normale", f:17},
            {id:"183", t:"Médecine du travail", m:"Médecine du Travail", d:"Normale", f:6},
            {id:"184", t:"Accidents du travail / MP", m:"Médecine du Travail", d:"Difficile", f:19},
            {id:"185", t:"Réaction inflammatoire", m:"Médecine Interne", d:"Normale", f:11},
            {id:"186", t:"Hypersensibilités et allergies", m:"Médecine Interne", d:"Difficile", f:6},
            {id:"187", t:"Allergies cutanées", m:"Dermatologie", d:"Normale", f:26},
            {id:"188", t:"Allergies respiratoires", m:"Pneumologie", d:"Normale", f:27},
            {id:"189", t:"Déficit immunitaire", m:"Médecine Interne", d:"Difficile", f:8},
            {id:"190", t:"Fièvre prolongée", m:"Médecine Interne", d:"Difficile", f:6},
            {id:"191", t:"Fièvre immunodéprimé", m:"Infectiologie", d:"Normale", f:14},
            {id:"192", t:"Pathologies auto-immunes", m:"Médecine Interne", d:"Normale", f:5},
            {id:"193", t:"Vascularites systémiques", m:"Médecine Interne", d:"Normale", f:8},
            {id:"194", t:"Lupus et SAPL", m:"Médecine Interne", d:"Difficile", f:27},
            {id:"195", t:"Horton (ACG)", m:"Médecine Interne", d:"Normale", f:13},
            {id:"196", t:"Polyarthrite rhumatoïde", m:"Rhumatologie", d:"Difficile", f:13},
            {id:"197", t:"Spondyloarthrite", m:"Rhumatologie", d:"Très difficile", f:16},
            {id:"198", t:"Arthropathies microcristallines", m:"Rhumatologie", d:"Normale", f:7},
            {id:"199", t:"SDRC", m:"Douleur", d:"Difficile", f:6},
            {id:"200", t:"Arthrite récente", m:"Rhumatologie", d:"Normale", f:18},
            {id:"201", t:"Transplantation organes", m:"Néphrologie", d:"Difficile", f:17},
            {id:"202", t:"Biothérapies", m:"Médecine Interne", d:"Normale", f:7},
            {id:"203", t:"Dyspnée", m:"Pneumologie", d:"Normale", f:19},
            {id:"204", t:"Toux", m:"Pneumologie", d:"Normale", f:10},
            {id:"205", t:"Hémoptysie", m:"Pneumologie", d:"Difficile", f:6},
            {id:"206", t:"Épanchement pleural", m:"Pneumologie", d:"Normale", f:9},
            {id:"207", t:"Opacités intra-thoraciques", m:"Pneumologie", d:"Normale", f:12},
            {id:"208", t:"Insuffisance respiratoire chronique", m:"Pneumologie", d:"Difficile", f:5},
            {id:"209", t:"BPCO", m:"Pneumologie", d:"Difficile", f:39},
            {id:"210", t:"PID", m:"Pneumologie", d:"Très difficile", f:11},
            {id:"211", t:"Sarcoïdose", m:"Pneumologie", d:"Difficile", f:25},
            {id:"212", t:"Hémogramme", m:"Hématologie", d:"Normale", f:32},
            {id:"213", t:"Anémie", m:"Hématologie", d:"Difficile", f:45},
            {id:"214", t:"Thrombopénie", m:"Hématologie", d:"Difficile", f:16},
            {id:"215", t:"Purpuras", m:"Hématologie", d:"Normale", f:7},
            {id:"216", t:"Syndrome hémorragique", m:"Hématologie", d:"Normale", f:18},
            {id:"217", t:"Syndrome mononucléosique", m:"Hématologie", d:"Difficile", f:6},
            {id:"218", t:"Éosinophilie", m:"Hématologie", d:"Normale", f:10},
            {id:"219", t:"Pathologie du fer", m:"Hématologie", d:"Normale", f:16},
            {id:"220", t:"Adénopathie superficielle", m:"Hématologie", d:"Difficile", f:12},
            {id:"221", t:"Athérome", m:"Cardiologie", d:"Normale", f:2},
            {id:"222", t:"FDR Cardio-vasculaire", m:"Cardiologie", d:"Normale", f:14},
            {id:"223", t:"Dyslipidémies", m:"Endocrinologie", d:"Très difficile", f:10},
            {id:"224", t:"HTA", m:"Cardiologie", d:"Normale", f:35},
            {id:"225", t:"Artériopathie (AOMI)", m:"Vasculaire", d:"Normale", f:30},
            {id:"226", t:"TVP et Embolie pulmonaire", m:"Vasculaire", d:"Difficile", f:38},
            {id:"227", t:"Insuffisance veineuse", m:"Vasculaire", d:"Normale", f:5},
            {id:"228", t:"Ulcère de jambe", m:"Vasculaire", d:"Difficile", f:16},
            {id:"229", t:"Abords veineux", m:"Urgence Réanimation", d:"Normale", f:5},
            {id:"230", t:"Douleur thoracique", m:"Cardiologie", d:"Normale", f:8},
            {id:"231", t:"ECG", m:"Cardiologie", d:"Très difficile", f:22},
            {id:"232", t:"Fibrillation atriale", m:"Cardiologie", d:"Normale", f:13},
            {id:"233", t:"Valvulopathies", m:"Cardiologie", d:"Difficile", f:12},
            {id:"234", t:"Insuffisance cardiaque", m:"Cardiologie", d:"Difficile", f:25},
            {id:"235", t:"Péricardite aiguë", m:"Cardiologie", d:"Normale", f:0},
            {id:"236", t:"Troubles conduction", m:"Cardiologie", d:"Normale", f:11},
            {id:"237", t:"Palpitations", m:"Cardiologie", d:"Difficile", f:4},
            {id:"238", t:"Souffle cardiaque enfant", m:"Cardiologie", d:"Normale", f:5},
            {id:"239", t:"Acrosyndromes", m:"Vasculaire", d:"Difficile", f:15},
            {id:"240", t:"Hypoglycémie", m:"Endocrinologie", d:"Normale", f:8},
            {id:"241", t:"Goitre et nodules", m:"Endocrinologie", d:"Difficile", f:9},
            {id:"242", t:"Hyperthyroïdie", m:"Endocrinologie", d:"Normale", f:18},
            {id:"243", t:"Hypothyroïdie", m:"Endocrinologie", d:"Normale", f:5},
            {id:"244", t:"Adénome hypophysaire", m:"Endocrinologie", d:"Difficile", f:13},
            {id:"245", t:"Insuffisance surrénale", m:"Endocrinologie", d:"Très difficile", f:8},
            {id:"246", t:"Gynécomastie", m:"Endocrinologie", d:"Normale", f:0},
            {id:"247", t:"Diabète type 1 et 2", m:"Endocrinologie", d:"Très difficile", f:55},
            {id:"248", t:"Prévention par nutrition", m:"Nutrition", d:"Normale", f:5},
            {id:"249", t:"Modifications mode de vie", m:"Médecine Générale", d:"Normale", f:5},
            {id:"250", t:"Dénutrition", m:"Nutrition", d:"Difficile", f:11},
            {id:"251", t:"Amaigrissement", m:"Nutrition", d:"Normale", f:3},
            {id:"252", t:"Troubles nutritionnels âgé", m:"MPR & Gériatrie", d:"Normale", f:2},
            {id:"253", t:"Obésité", m:"Nutrition", d:"Normale", f:13},
            {id:"254", t:"Nutrition femme enceinte", m:"Nutrition", d:"Normale", f:2},
            {id:"255", t:"Diabète gestationnel", m:"Endocrinologie", d:"Facile", f:0},
            {id:"256", t:"Aptitude au sport", m:"Nutrition", d:"Normale", f:1},
            {id:"257", t:"Œdèmes", m:"Néphrologie", d:"Normale", f:4},
            {id:"258", t:"Élévation créatininémie", m:"Néphrologie", d:"Normale", f:2},
            {id:"259", t:"Protéinurie et Sd néphrotique", m:"Néphrologie", d:"Difficile", f:14},
            {id:"260", t:"Hématurie", m:"Urologie", d:"Normale", f:11},
            {id:"261", t:"Néphropathie glomérulaire", m:"Néphrologie", d:"Difficile", f:29},
            {id:"262", t:"Néphropathies interstitielles", m:"Néphrologie", d:"Difficile", f:1},
            {id:"263", t:"Néphropathies vasculaires", m:"Néphrologie", d:"Difficile", f:2},
            {id:"264", t:"IRC", m:"Néphrologie", d:"Difficile", f:30},
            {id:"265", t:"Lithiase urinaire", m:"Urologie", d:"Normale", f:22},
            {id:"266", t:"Polykystose rénale", m:"Néphrologie", d:"Normale", f:5},
            {id:"267", t:"Troubles hydro-électrolytiques", m:"Néphrologie", d:"Très difficile", f:36},
            {id:"268", t:"Hypercalcémie", m:"Endocrinologie", d:"Difficile", f:24},
            {id:"269", t:"Douleurs abdo aiguës", m:"Hépato-Gastro", d:"Normale", f:23},
            {id:"270", t:"Douleurs lombaires aiguës", m:"Urologie", d:"Normale", f:3},
            {id:"271", t:"RGO", m:"Hépato-Gastro", d:"Difficile", f:10},
            {id:"272", t:"Ulcère gastrique", m:"Hépato-Gastro", d:"Normale", f:29},
            {id:"273", t:"Dysphagie", m:"Hépato-Gastro", d:"Normale", f:2},
            {id:"274", t:"Vomissements", m:"Hépato-Gastro", d:"Normale", f:2},
            {id:"275", t:"Splénomégalie", m:"Hématologie", d:"Normale", f:5},
            {id:"276", t:"Hépatomégalie", m:"Hépato-Gastro", d:"Normale", f:2},
            {id:"277", t:"Lithiase biliaire", m:"Hépato-Gastro", d:"Difficile", f:9},
            {id:"278", t:"Ictère", m:"Hépato-Gastro", d:"Normale", f:10},
            {id:"279", t:"Cirrhose", m:"Hépato-Gastro", d:"Difficile", f:26},
            {id:"280", t:"Ascite", m:"Hépato-Gastro", d:"Normale", f:2},
            {id:"281", t:"Pancréatite chronique", m:"Hépato-Gastro", d:"Difficile", f:6},
            {id:"282", t:"MICI", m:"Hépato-Gastro", d:"Normale", f:18},
            {id:"283", t:"Constipation", m:"Hépato-Gastro", d:"Normale", f:3},
            {id:"284", t:"Colopathie fonctionnelle", m:"Hépato-Gastro", d:"Normale", f:0},
            {id:"285", t:"Diarrhée chronique", m:"Hépato-Gastro", d:"Normale", f:10},
            {id:"286", t:"Diarrhée aiguë", m:"Pédiatrie", d:"Normale", f:14},
            {id:"287", t:"Diverticulose", m:"Hépato-Gastro", d:"Normale", f:4},
            {id:"288", t:"Pathologie hémorroïdaire", m:"Hépato-Gastro", d:"Normale", f:13},
            {id:"289", t:"Hernie pariétale", m:"Hépato-Gastro", d:"Normale", f:11},
            {id:"290", t:"Épidémiologie cancers", m:"Cancérologie", d:"Normale", f:5},
            {id:"291", t:"Cancérogénèse", m:"Cancérologie", d:"Normale", f:19},
            {id:"292", t:"Diagnostic cancers", m:"Cancérologie", d:"Normale", f:3},
            {id:"293", t:"Anapath", m:"Cancérologie", d:"Normale", f:8},
            {id:"294", t:"Traitement cancers", m:"Cancérologie", d:"Très difficile", f:28},
            {id:"295", t:"Prise en charge cancer", m:"Cancérologie", d:"Normale", f:5},
            {id:"296", t:"Agranulocytose", m:"Hématologie", d:"Difficile", f:0},
            {id:"297", t:"Cancer de l'enfant", m:"Pédiatrie", d:"Normale", f:8},
            {id:"298", t:"Tumeurs VADS", m:"ORL & CMF", d:"Difficile", f:17},
            {id:"299", t:"Tumeurs intracrâniennes", m:"Neurologie", d:"Normale", f:3},
            {id:"300", t:"Tumeurs utérus (Col/Corps)", m:"Gynécologie", d:"Difficile", f:18},
            {id:"301", t:"Tumeurs colon/rectum", m:"Hépato-Gastro", d:"Difficile", f:26},
            {id:"302", t:"Tumeurs cutanées", m:"Dermatologie", d:"Difficile", f:13},
            {id:"303", t:"Tumeurs estomac", m:"Hépato-Gastro", d:"Normale", f:1},
            {id:"304", t:"Tumeurs foie", m:"Hépato-Gastro", d:"Normale", f:9},
            {id:"305", t:"Tumeurs œsophage", m:"Hépato-Gastro", d:"Normale", f:1},
            {id:"306", t:"Tumeurs ovaire", m:"Gynécologie", d:"Normale", f:11},
            {id:"307", t:"Tumeurs os", m:"Rhumatologie", d:"Normale", f:5},
            {id:"308", t:"Tumeurs pancréas", m:"Hépato-Gastro", d:"Normale", f:4},
            {id:"309", t:"Tumeurs poumon", m:"Pneumologie", d:"Difficile", f:14},
            {id:"310", t:"Tumeurs prostate", m:"Urologie", d:"Normale", f:21},
            {id:"311", t:"Tumeurs rein", m:"Urologie", d:"Normale", f:7},
            {id:"312", t:"Tumeurs sein", m:"Gynécologie", d:"Difficile", f:20},
            {id:"313", t:"Tumeurs testicule", m:"Urologie", d:"Normale", f:6},
            {id:"314", t:"Tumeurs vésicales", m:"Urologie", d:"Normale", f:6},
            {id:"315", t:"Leucémies aiguës", m:"Hématologie", d:"Difficile", f:6},
            {id:"316", t:"Syndromes myélodysplasiques", m:"Hématologie", d:"Difficile", f:4},
            {id:"317", t:"Syndromes myéloprolifératifs", m:"Hématologie", d:"Difficile", f:14},
            {id:"318", t:"LLC", m:"Hématologie", d:"Difficile", f:10},
            {id:"319", t:"Lymphomes malins", m:"Hématologie", d:"Très difficile", f:14},
            {id:"320", t:"Myélome multiple", m:"Hématologie", d:"Très difficile", f:11},
            {id:"321", t:"Bon usage du médicament", m:"Thérapeutique", d:"Normale", f:3},
            {id:"322", t:"Décision thérapeutique", m:"Thérapeutique", d:"Normale", f:1},
            {id:"323", t:"LCA", m:"Thérapeutique", d:"Normale", f:7},
            {id:"324", t:"Éducation thérapeutique", m:"Thérapeutique", d:"Normale", f:3},
            {id:"325", t:"Iatrogénie", m:"Thérapeutique", d:"Normale", f:14},
            {id:"326", t:"Cadre réglementaire", m:"Thérapeutique", d:"Normale", f:4},
            {id:"327", t:"Médecine intégrative", m:"Thérapeutique", d:"Normale", f:0},
            {id:"328", t:"Thérapeutiques non médicamenteuses", m:"MPR & Gériatrie", d:"Normale", f:14},
            {id:"329", t:"Transfusion (PSL)", m:"Hématologie", d:"Difficile", f:13},
            {id:"330", t:"Prescription classes médicamenteuses", m:"Thérapeutique", d:"Difficile", f:59},
            {id:"331", t:"Arrêt cardio-circulatoire", m:"Urgence Réanimation", d:"Normale", f:4},
            {id:"332", t:"État de choc", m:"Urgence Réanimation", d:"Difficile", f:19},
            {id:"333", t:"Situations exceptionnelles", m:"Urgence Réanimation", d:"Normale", f:0},
            {id:"334", t:"Traumatologie grave", m:"Urgence Réanimation", d:"Très difficile", f:36},
            {id:"335", t:"Trauma crânio-facial", m:"ORL & CMF", d:"Difficile", f:44},
            {id:"336", t:"Coma non traumatique", m:"Urgence Réanimation", d:"Normale", f:4},
            {id:"337", t:"Intoxications aiguës", m:"Urgence Réanimation", d:"Normale", f:9},
            {id:"338", t:"Œdème de Quincke", m:"Urgence Réanimation", d:"Normale", f:1},
            {id:"339", t:"SCA", m:"Cardiologie", d:"Normale", f:14},
            {id:"340", t:"AVC", m:"Neurologie", d:"Difficile", f:30},
            {id:"341", t:"Hémorragie méningée", m:"Neurologie", d:"Normale", f:13},
            {id:"342", t:"Malaise, PC", m:"Urgence Réanimation", d:"Normale", f:15},
            {id:"343", t:"État confusionnel", m:"Neurologie", d:"Normale", f:25},
            {id:"344", t:"Pré-éclampsie", m:"Gynécologie", d:"Difficile", f:7},
            {id:"345", t:"Malaise grave nourrisson", m:"Pédiatrie", d:"Difficile", f:7},
            {id:"346", t:"Convulsions enfant", m:"Pédiatrie", d:"Normale", f:3},
            {id:"347", t:"Rétention aiguë d'urine", m:"Urologie", d:"Normale", f:4},
            {id:"348", t:"IRA - Anurie", m:"Néphrologie", d:"Difficile", f:28},
            {id:"349", t:"Infection parties molles", m:"Infectiologie", d:"Normale", f:15},
            {id:"350", t:"Grosse jambe rouge", m:"Dermatologie", d:"Normale", f:8},
            {id:"351", t:"Agitation et délire", m:"Psychiatrie", d:"Normale", f:12},
            {id:"352", t:"Crise d'angoisse", m:"Psychiatrie", d:"Normale", f:1},
            {id:"353", t:"Risque suicidaire", m:"Psychiatrie", d:"Difficile", f:15},
            {id:"354", t:"Syndrome occlusif", m:"Hépato-Gastro", d:"Normale", f:15},
            {id:"355", t:"Hémorragie digestive", m:"Hépato-Gastro", d:"Normale", f:11},
            {id:"356", t:"Appendicite", m:"Hépato-Gastro", d:"Normale", f:11},
            {id:"357", t:"Péritonite aiguë", m:"Hépato-Gastro", d:"Normale", f:12},
            {id:"358", t:"Pancréatite aiguë", m:"Hépato-Gastro", d:"Difficile", f:8},
            {id:"359", t:"Détresse respiratoire aiguë", m:"Pneumologie", d:"Difficile", f:20},
            {id:"360", t:"Pneumothorax", m:"Pneumologie", d:"Facile", f:10},
            {id:"361", t:"Lésions ligamentaires", m:"Orthopédie", d:"Difficile", f:20},
            {id:"362", t:"Prothèses et ostéosynthèses", m:"Orthopédie", d:"Normale", f:8},
            {id:"363", t:"Fractures fréquentes", m:"Orthopédie", d:"Difficile", f:31},
            {id:"364", t:"Fractures enfant", m:"Pédiatrie", d:"Normale", f:2},
            {id:"365", t:"Surveillance plâtre", m:"Orthopédie", d:"Normale", f:6},
            {id:"366", t:"AES", m:"Infectiologie", d:"Difficile", f:2},
            {id:"367", t:"Impact environnement", m:"Santé Publique", d:"Normale", f:2}
        ];

        const matiereConfig = {
            'Cardiologie': { color: 'red', icon: 'fa-heart-pulse', gradient: 'from-red-500 to-rose-600' },
            'Pneumologie': { color: 'sky', icon: 'fa-lungs', gradient: 'from-sky-400 to-blue-600' },
            'Neurologie': { color: 'indigo', icon: 'fa-brain', gradient: 'from-indigo-500 to-violet-600' },
            'Hépato-Gastro': { color: 'amber', icon: 'fa-utensils', gradient: 'from-amber-400 to-orange-600' },
            'Urgence Réanimation': { color: 'rose', icon: 'fa-truck-medical', gradient: 'from-rose-600 to-red-700' },
            'Infectiologie': { color: 'yellow', icon: 'fa-virus', gradient: 'from-yellow-400 to-yellow-600' },
            'Néphrologie': { color: 'orange', icon: 'fa-filter', gradient: 'from-orange-400 to-red-500' },
            'Urologie': { color: 'orange', icon: 'fa-droplet', gradient: 'from-orange-500 to-red-600' },
            'Endocrinologie': { color: 'pink', icon: 'fa-dna', gradient: 'from-pink-500 to-rose-500' },
            'Gynécologie': { color: 'pink', icon: 'fa-person-pregnant', gradient: 'from-pink-400 to-rose-400' },
            'Pédiatrie': { color: 'cyan', icon: 'fa-baby', gradient: 'from-cyan-400 to-blue-500' },
            'Dermatologie': { color: 'rose', icon: 'fa-hand-dots', gradient: 'from-rose-400 to-pink-600' },
            'Psychiatrie': { color: 'violet', icon: 'fa-head-side-virus', gradient: 'from-violet-500 to-purple-600' },
            'Ophtalmologie': { color: 'blue', icon: 'fa-eye', gradient: 'from-blue-600 to-indigo-700' },
            'ORL & CMF': { color: 'teal', icon: 'fa-ear-listen', gradient: 'from-teal-400 to-emerald-600' },
            'Rhumatologie': { color: 'lime', icon: 'fa-bone', gradient: 'from-lime-500 to-green-600' },
            'Orthopédie': { color: 'emerald', icon: 'fa-crutch', gradient: 'from-emerald-500 to-green-600' },
            'Hématologie': { color: 'red', icon: 'fa-vial', gradient: 'from-red-600 to-rose-800' },
            'Santé Publique': { color: 'emerald', icon: 'fa-users', gradient: 'from-emerald-500 to-green-600' },
            'Médecine Légale': { color: 'indigo', icon: 'fa-scale-balanced', gradient: 'from-indigo-500 to-purple-600' },
            'Médecine Interne': { color: 'purple', icon: 'fa-user-doctor', gradient: 'from-purple-700 to-indigo-900' },
            'Médecine du Travail': { color: 'amber', icon: 'fa-helmet-safety', gradient: 'from-amber-500 to-yellow-600' },
            'Addictologie': { color: 'fuchsia', icon: 'fa-wine-bottle', gradient: 'from-fuchsia-600 to-pink-700' },
            'Douleur': { color: 'rose', icon: 'fa-face-frown-open', gradient: 'from-rose-300 to-pink-400' },
            'MPR & Gériatrie': { color: 'green', icon: 'fa-person-cane', gradient: 'from-green-600 to-emerald-700' },
            'Nutrition': { color: 'lime', icon: 'fa-apple-whole', gradient: 'from-lime-500 to-green-500' },
            'Soins Palliatifs': { color: 'teal', icon: 'fa-hands-holding', gradient: 'from-teal-400 to-cyan-500' },
            'Génétique': { color: 'indigo', icon: 'fa-dna', gradient: 'from-indigo-300 to-blue-500' },
            'Cancérologie': { color: 'stone', icon: 'fa-ribbon', gradient: 'from-stone-600 to-gray-800' },
            'Thérapeutique': { color: 'cyan', icon: 'fa-pills', gradient: 'from-cyan-400 to-blue-500' },
            'Médecine Générale': { color: 'blue', icon: 'fa-stethoscope', gradient: 'from-blue-500 to-indigo-600' },
            'Vasculaire': { color: 'red', icon: 'fa-road', gradient: 'from-red-500 to-red-700' },
        };

const defaultConfig = { color: 'gray', icon: 'fa-book-medical', gradient: 'from-gray-700 to-gray-900' };
        const availableAvatars = ['fa-dragon', 'fa-cat', 'fa-dog', 'fa-crow', 'fa-otter', 'fa-fish', 'fa-spider', 'fa-horse', 'fa-frog', 'fa-dove'];
        
         // --- Login Functions --
// --- 1. Bascule entre Connexion et Inscription ---
function toggleAuthMode() {
    isRegistering = !isRegistering;
    const btnText = document.getElementById('authBtnText');
    const toggleText = document.getElementById('toggleText');
    const toggleLink = document.getElementById('toggleLink');
    const errorBox = document.getElementById('authError');

    // Reset erreur
    errorBox.classList.add('hidden');

    if (isRegistering) {
        btnText.innerText = "S'inscrire";
        toggleText.innerText = "Déjà un compte ?";
        toggleLink.innerText = "Se connecter";
    } else {
        btnText.innerText = "Connexion";
        toggleText.innerText = "Pas encore de compte ?";
        toggleLink.innerText = "Créer un compte";
    }
}

// --- 2. Action principale (Click bouton) ---
function handleAuthAction() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorBox = document.getElementById('authError');

    if (!email || !password) {
        showAuthError("Veuillez remplir tous les champs.");
        return;
    }

    // Effet de chargement sur le bouton
    const btn = document.getElementById('authBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
    btn.disabled = true;

    if (isRegistering) {
        // --- CRÉATION DE COMPTE ---
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Succès : initApp gérera la suite via le listener
                console.log("Compte créé :", userCredential.user.uid);
            })
            .catch((error) => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                showAuthError(getFirebaseErrorMessage(error.code));
            });
    } else {
        // --- CONNEXION ---
        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Succès
                console.log("Connecté :", userCredential.user.uid);
            })
            .catch((error) => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                showAuthError("Email ou mot de passe incorrect.");
            });
    }
}

function togglePasswordVisibility() {
    const input = document.getElementById('loginPassword');
    const icon = document.getElementById('passwordToggleIcon');
    
    if (input.type === 'password') {
        // Afficher
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        // Masquer
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// --- Fonction de Déconnexion ---
function handleLogout() {
    // 1. Fermer le menu visuellement
    toggleUserMenu();

    // 2. Déconnecter de Firebase
    if (typeof auth !== 'undefined') {
        auth.signOut().then(() => {
            console.log("Déconnexion réussie.");
            // 3. Recharger la page pour réinitialiser l'interface (retour au Login)
            location.reload();
        }).catch((error) => {
            console.error("Erreur déconnexion:", error);
        });
    } else {
        // Cas hors ligne / mode démo
        location.reload();
    }
}

function showAuthError(msg) {
    const box = document.getElementById('authError');
    box.innerText = msg;
    box.classList.remove('hidden');
    // Animation de secousse
    const panel = document.querySelector('#loginOverlay .card-panel');
    panel.classList.add('animate-shake');
    setTimeout(() => panel.classList.remove('animate-shake'), 500);
}

function getFirebaseErrorMessage(code) {
    switch (code) {
        case 'auth/email-already-in-use': return "Cet email est déjà utilisé.";
        case 'auth/invalid-email': return "Format d'email invalide.";
        case 'auth/weak-password': return "Le mot de passe doit faire 6 caractères min.";
        default: return "Erreur d'authentification.";
    }
}

function resetPasswordProcess() {
    const email = document.getElementById('loginEmail').value.trim();
    const errorBox = document.getElementById('authError');
    const btn = event.target; // Le bouton cliqué

    // 1. Vérification
    if (!email) {
        showAuthError("Veuillez d'abord entrer votre email dans le champ ci-dessus.");
        // Petit focus visuel sur le champ email
        const emailInput = document.getElementById('loginEmail');
        emailInput.focus();
        emailInput.classList.add('border-red-500');
        setTimeout(() => emailInput.classList.remove('border-red-500'), 2000);
        return;
    }

    // 2. Envoi Firebase
    const oldText = btn.innerText;
    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Envoi...';

    auth.sendPasswordResetEmail(email)
        .then(() => {
            btn.innerText = oldText;
            if(errorBox) errorBox.classList.add('hidden');
            alert("📧 Email envoyé à " + email + ".\nVérifiez vos spams (et attendez quelques minutes) !");
        })
        .catch((error) => {
            btn.innerText = oldText;
            console.error(error);
            if (error.code === 'auth/user-not-found') {
                showAuthError("Aucun compte ne correspond à cet email.");
            } else if (error.code === 'auth/invalid-email') {
                showAuthError("L'adresse email est mal formatée.");
            } else {
                showAuthError("Erreur : " + error.message);
            }
        });
}

// --- Fonction pour forcer le démarrage sans Firebase ---
function startDemoMode() {
    // 1. Cacher l'écran de login
    const overlay = document.getElementById('loginOverlay');
    overlay.classList.add('opacity-0');
    setTimeout(() => {
        overlay.classList.add('hidden');
    }, 500);

    // 2. Initialiser l'application avec un utilisateur fictif
    console.log("Démarrage en mode Visiteur...");
    
    // On appelle la fonction principale qui charge les items
    // On passe un ID fictif 'local-user' pour que le script fonctionne
    completeInitialization('local-user');
    
    // Petit message de succès
    setTimeout(() => {
        // Si la fonction showToast existe, on l'utilise, sinon alert
        if(typeof showToast === 'function') {
            showToast("Mode Visiteur Activé", "success");
        }
    }, 1000);
}

        // --- TOAST SYSTEM (DÉSACTIVÉ) ---
function showToast(message, type = 'info') {
            // J'ai supprimé le code ici pour qu'aucun message ne s'affiche
            return;
        }

        // --- CONFIRM MODAL SYSTEM ---
        
function openConfirmModal(action) {
            pendingConfirmAction = action;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');
        }

function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmModal').classList.remove('flex');
            pendingConfirmAction = null;
        }

        document.getElementById('confirmBtnAction').addEventListener('click', () => {
            if(pendingConfirmAction) {
                pendingConfirmAction();
                closeConfirmModal();
            }
        });

        // --- INIT & PERSISTENCE ---

// --- REMPLACEZ TOUTE LA FONCTION initApp PAR CECI ---
function initApp() {
    const overlay = document.getElementById('loginOverlay');
    const dashboard = document.getElementById('dashboardView'); 

    if (typeof auth === 'undefined') {
        console.error("Erreur: Firebase n'est pas chargé.");
        return;
    }

    auth.onAuthStateChanged((user) => {
        if (user) {
            console.log("Utilisateur reconnu :", user.email);
            
            // --- SÉQUENCE CINÉMATIQUE (AVEC FLASH) ---
            
            // 1. On récupère le son (assurez-vous que c'est bien 'chronoStart' ou votre musique)
            const introSound = audioSystem.sounds['track4']; 
            
            if (audioSystem.enabled && introSound) {
                // On le lance
                introSound.currentTime = 0;
                introSound.volume = 0.2; // Ou votre volume préféré
                introSound.play().catch(e => console.log("Audio bloqué", e));

                // 2. On programme le fondu pour qu'il FINISSE à 12s
                // Donc on commence à 9s (9000ms) et on fait un fondu de 3s (3000ms)
                setTimeout(() => {
                    fadeOutAndStop(introSound, 3000);
                }, 9000);
            }

            // 2. Création du Flash Lumineux
            const flash = document.createElement('div');
            flash.className = 'transition-flash';
            document.body.appendChild(flash);
            // Nettoyage du flash après l'animation
            flash.addEventListener('animationend', () => {
    flash.remove();
});

            // 3. Explosion du Login (Disparition)            
if (dashboard) {
                dashboard.classList.remove('hidden'); // On l'affiche
            }

            // 5. Nettoyage final du Login (0.8s plus tard)
            setTimeout(() => {
                if(overlay) {
                    overlay.classList.add('hidden');
                }
            }, 800);

            // 6. Chargement des données
            completeInitialization(user.uid);

        } else {
            console.log("Non connecté.");
            
            // Reset état initial
            if(overlay) {
                overlay.style = ""; 
            }
            
            if(dashboard) {
                dashboard.classList.add('hidden');
            }
        }
    });
}

// --- FONCTION DE CHARGEMENT MISE À JOUR ---
// --- FONCTION DE CHARGEMENT CORRIGÉE ---
async function completeInitialization(userId) {
    console.log("Chargement des données pour :", userId);

    // 1. Récupération des données Cloud (Firebase)
    const userDocRef = db.collection('users').doc(userId);
    let loadedData = {};

    try {
        const doc = await userDocRef.get();
        
        if (doc.exists) {
            // Cas 1 : Sauvegarde trouvée, tout va bien
            console.log("Données trouvées !");
            loadedData = doc.data().userData || {};
        } else {
            // Cas 2 : Aucune sauvegarde trouvée
            // SÉCURITÉ : On demande confirmation avant de créer un nouveau profil vide
            // pour éviter d'écraser une sauvegarde existante en cas de bug.
            console.log("Aucune donnée trouvée pour cet ID.");
            
            if(confirm("Attention : Aucune sauvegarde trouvée.\n\nCliquez sur OK pour créer un nouveau profil vide.\nCliquez sur ANNULER si vous pensez que c'est une erreur (bug réseau) pour ne rien perdre.")) {
                 setTimeout(saveData, 2000); // On crée le profil seulement si vous dites OK
            } else {
                return; // On arrête tout, on ne touche à rien
            }
        }
    } catch (error) {
        // Cas 3 : Erreur technique (Pas d'internet, bug Firebase...)
        console.error("Erreur critique de chargement :", error);
        alert("ERREUR CRITIQUE : Impossible de lire vos données (Problème réseau ?).\n\nLe site va arrêter le chargement pour protéger votre sauvegarde.\nVérifiez votre connexion et rechargez la page.");
        return; // Arrêt d'urgence pour ne pas écraser les données
    }

    // 2. Afficher la date du jour
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    const dateElement = document.getElementById('dateToday');
    if(dateElement) dateElement.innerText = new Date().toLocaleDateString('fr-FR', options);

    // 3. HYDRATATION DES DONNÉES
    
    // -- Progression --
    userXP = loadedData.xp || 0;
    userLevel = Math.floor(userXP / 1000); 
    userStatus = loadedData.status || {};
    userVues = loadedData.vues || {};
    userHistory = loadedData.history || {};
    userPlanning = loadedData.planning || {};
    userTodos = loadedData.todos || [];
    userResources = loadedData.resources || [];
    userItemImages = loadedData.item_images || {};

    // -- Détails Items --
    userItemNotes = loadedData.item_notes || {};
    userItemDifficulty = loadedData.item_difficulty || {};
    userItemErrors = loadedData.item_errors || {};
    userXPClaimed = loadedData.xp_claimed || {};
    userSubjectNotes = loadedData.subject_notes || {};

    // -- Profil --
    userName = loadedData.user_name || "";
    userAlias = loadedData.user_alias || "Docteur";
    userAvatar = loadedData.current_avatar || "fa-dragon";
    userUnlockedAvatars = loadedData.unlocked_avatars || ['fa-dragon'];
    userLinks = loadedData.custom_links || [];
    
    // -- Clé API --
    if (loadedData.apiKey) {
        userApiKey = loadedData.apiKey;
        localStorage.setItem('ultimed_apiKey', userApiKey);
    }

    // -- Date Exam --
    if (loadedData.exam_date) {
        userExamDate = loadedData.exam_date;
        updateCountdownDisplay(userExamDate);
        const settingDateInput = document.getElementById('settingDate');
        if(settingDateInput) settingDateInput.value = userExamDate;
    }

    // -- LOGIQUE SUGGESTIONS DU JOUR --
    const todayKey = getTodayKey(); 
    const savedSuggestionsDate = loadedData.daily_suggestions ? loadedData.daily_suggestions.date : null;

    if (savedSuggestionsDate === todayKey && loadedData.daily_suggestions && loadedData.daily_suggestions.suggestions.length > 0) {
        console.log("Suggestions du jour restaurées.");
        currentSuggestions = loadedData.daily_suggestions.suggestions;
        dailySuggestionsDone = loadedData.daily_suggestions.done || {};
    } else {
        console.log("Nouvelle journée : Reset des suggestions.");
        currentSuggestions = [];
        dailySuggestionsDone = {};
    }

    // 4. MISE A JOUR DE L'INTERFACE
    updateGreetingDisplay();
    if(typeof updateXPDisplay === 'function') updateXPDisplay();
    if(typeof renderHeaderLinks === 'function') renderHeaderLinks();
    
    // Charge les réglages sons
    loadProfile(); 
    initNotes(); 

    // Listeners dynamiques
    const searchInput = document.getElementById('searchInput');
    if(searchInput) {
        const newSearch = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearch, searchInput);
        newSearch.addEventListener('input', render);
    }
    const quickNotes = document.getElementById('quickNotes');
    if(quickNotes) {
        const newNotes = quickNotes.cloneNode(true);
        quickNotes.parentNode.replaceChild(newNotes, quickNotes);
        newNotes.addEventListener('input', (e) => saveNotes(e.target.value));
        newNotes.value = userSubjectNotes[currentNotesMatiere] || "";
    }

    setupAutocompleteSystems();

    // --- SECTION NETTOYAGE & SYNCHRO ---

    // A. Définition de la date d'aujourd'hui (UNE SEULE FOIS)
    const savedDate = loadedData.last_update ? new Date(loadedData.last_update).toISOString().split('T')[0] : null;
    const todayStr = new Date().toISOString().split('T')[0]; 

    // B. Détecter le changement de jour (Nettoyage)
    if (savedDate && savedDate !== todayStr) {
        const oldLength = userTodos.length;
        userTodos = userTodos.filter(t => !t.done); // On garde ce qui n'est pas fait
        
        if (userTodos.length < oldLength) {
            console.log("Nettoyage matinal : Tâches terminées de la veille archivées.");
        }
    }

    // C. SYNCHRO AU DÉMARRAGE : PLANNING DU JOUR -> TODO LIST
    // (Note : on réutilise la variable todayStr déclarée au point A, on ne la recrée pas !)
    const todayPlannedItems = userPlanning[todayStr] || [];

    todayPlannedItems.forEach(itemId => {
        // 1. On vérifie si l'item n'est pas déjà fait
        const isDoneToday = userHistory[todayStr] && userHistory[todayStr].includes(itemId);
        
        // 2. On vérifie s'il n'est pas déjà dans la liste
        const isInTodos = userTodos.some(t => t.linkedItemId === itemId);

        // 3. Si c'est planifié, pas fait, et pas encore affiché : On l'ajoute !
        if (!isDoneToday && !isInTodos) {
            const itemInfo = rawItems.find(i => i.id === itemId);
            const title = itemInfo ? itemInfo.t : "Item " + itemId;

            userTodos.push({
                text: `Item ${itemId} - ${title}`,
                done: false, 
                id: Date.now() + Math.random(), 
                linkedItemId: itemId
            });
            
            console.log(`Synchro auto : Item ${itemId} ajouté aux objectifs du jour.`);
        }
    });

    // 5. RENDU FINAL
    buildCourses(); 
    populateFilters();
    updateStats();
    render(); 
    renderTodos();

    initSubjectCarousel();
    
    renderSuggestions(false);
}

// Petite fonction utilitaire requise
function setupAutocompleteSystems() {
    const todoInput = document.getElementById('todoInput');
    const autoList = document.getElementById('autocompleteList');
    const calInput = document.getElementById('calendarSearchInput');
    const calList = document.getElementById('calendarAutocompleteList');

    if (todoInput && autoList) {
        todoInput.addEventListener('input', (e) => handleAutoSearch(e, autoList, 'todo'));
        document.addEventListener('click', (e) => {
            if (!todoInput.contains(e.target) && !autoList.contains(e.target)) autoList.classList.add('hidden');
        });
    }
    if (calInput && calList) {
        calInput.addEventListener('input', (e) => handleAutoSearch(e, calList, 'planning'));
        document.addEventListener('click', (e) => {
            if (!calInput.contains(e.target) && !calList.contains(e.target)) calList.classList.add('hidden');
        });
    }
}

function handleAutoSearch(e, listElement, type) {
    const val = e.target.value.toLowerCase();
    if(!val) { listElement.classList.add('hidden'); return; }
    
    const matches = rawItems.filter(i => 
        i.id.includes(val) || i.t.toLowerCase().includes(val) || i.m.toLowerCase().includes(val)
    ).slice(0, 5);
    
    if(matches.length === 0) { listElement.classList.add('hidden'); return; }
    
    const action = type === 'todo' ? 'addSpecificTodo' : 'addPlanningItem';
    
    listElement.innerHTML = matches.map(m => `
        <div class="autocomplete-item" onclick="${action}('${m.id}', '${m.t.replace(/'/g, "&apos;")}')">
            <span class="font-bold text-blue-400">#${m.id}</span> ${m.t}
        </div>
    `).join('');
    listElement.classList.remove('hidden');
}

	function scrollToFilterBar() {
    // Timeout pour laisser le temps au DOM de finir de dessiner la grille
    setTimeout(() => {
        const filterBar = document.getElementById('filterBar');
        
        if (filterBar) {
            // Calcule la position verticale de la barre de filtre
            const targetPosition = filterBar.offsetTop;
            
            // Défilement : targetPosition - 120px (Barre de navigation + décalage)
            window.scrollTo({
                top: targetPosition - 120, // Ajustement : Remonte de 120px au-dessus
                behavior: 'smooth'
            });
        }
    }, 100);
}

        function handleFilterChange(selectElement) {
            const val = selectElement.value;
            updateGlobalGlow(val);
            
	    // --- 1. ANIMATION IMMERSIVE "BURST" (Cercle + Icone) ---
            if (val !== 'all') {
                const config = matiereConfig[val] || defaultConfig;
                const rgb = getMatiereColorValue(config.color); 
                
                const overlay = document.getElementById('subjectBurstOverlay');
                const circle = document.getElementById('subjectBurstCircle');
                const icon = document.getElementById('subjectBurstIcon'); // L'icône géante
                
                // A. Configurer le Cercle
                circle.style.backgroundColor = `rgba(${rgb}, 0.2)`; 
                circle.style.boxShadow = `0 0 100px 50px rgba(${rgb}, 0.5)`;
                
                // B. Configurer l'Icône
                // On lui donne la classe de l'icône (ex: fa-heart-pulse) et la couleur de la matière
                icon.className = `fa-solid ${config.icon} text-[70vmin] text-${config.color}-500 drop-shadow-[0_0_50px_rgba(${rgb.replace(/ /g, '')},0.8)]`;

                // C. Lancer les animations
                overlay.classList.remove('hidden');
                
                // Reset (force le redessin)
                circle.classList.remove('animate-burst');
                icon.classList.remove('animate-icon-burst');
                void circle.offsetWidth; 
                
                // Start
                circle.classList.add('animate-burst');
                icon.classList.add('animate-icon-burst');
                
                // Son
                playSound('subjectClick'); 

                // Nettoyage
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 700); // Un peu plus long pour laisser l'icône finir
            }
            // --------------------------------------

            // Gestion de l'icône du filtre
            const icon = document.getElementById('filterIcon');
            icon.className = "fa-solid text-xs transition-colors duration-300";
            
            if (val === 'all') {
                icon.classList.add('fa-filter', 'text-gray-400', 'group-hover:text-white');
            } else {
                const config = matiereConfig[val] || defaultConfig;
                icon.classList.remove('fa-filter');
                icon.classList.add(config.icon, `text-${config.color}-400`);
            }
            const notesSelect = document.getElementById('notesMatiereSelect');
            if(notesSelect) {
                // Si on met "Toutes", on va sur "Général", sinon sur la matière choisie
                const targetNoteMatiere = val === 'all' ? 'Général' : val;
                
                // On change seulement si nécessaire pour éviter de recharger inutilement
                if (notesSelect.value !== targetNoteMatiere) {
                    notesSelect.value = targetNoteMatiere;
                    changeNotesMatiere(targetNoteMatiere);
                }
            }
            render(); 
anchorToFilterBar()
        }
        
        function filterByStatus(status) {
            currentStatusFilter = currentStatusFilter === status ? 'all' : status; 
            render();
            const statusMessage = currentStatusFilter === 'lu' ? "Affichez: Lus" : currentStatusFilter === 'maitrise' ? "Affichez: Maîtrisés" : "Affichez: Tous";
            showToast(statusMessage, 'info');
            setTimeout(() => {
    const filterBar = document.getElementById('filterBar');
    if(filterBar) filterBar.scrollIntoView({ behavior: 'smooth', block: 'center' });
}, 100); 
        }

function loadProfile() {
    // On ne charge QUE les paramètres techniques locaux
    
    // 1. La Clé API (Pratique de l'avoir en local si on est hors ligne)
    const savedKey = localStorage.getItem('ultimed_apiKey');
    if(savedKey && !userApiKey) userApiKey = savedKey;

    // 2. Le Son (Préférence de l'appareil)
    const savedSound = localStorage.getItem('ultimed_sound_enabled');
    if (savedSound !== null) {
        audioSystem.enabled = (savedSound === 'true');
    }
}

        // La fonction de sauvegarde est modifiée pour utiliser Firestore
// --- FONCTION DE SAUVEGARDE CORRIGÉE (COMPLETE) ---
async function saveData() {
    const user = auth.currentUser;
    if (!user) return;

    const dataToSave = {
        // Progression
        xp: userXP,
        status: userStatus,
        vues: userVues,
        todos: userTodos,
        history: userHistory,
        planning: userPlanning,
        resources: userResources,
	item_images: userItemImages || {},

        // Détails Items
        item_notes: userItemNotes || {},
        item_difficulty: userItemDifficulty || {},
        item_errors: userItemErrors || {},
        xp_claimed: userXPClaimed || {},

        // --- AJOUTS POUR LA SYNCHRO ---
        // 1. Notes Générales (Par matière)
        subject_notes: userSubjectNotes || {},
        
        // 2. Suggestions du jour (Persistantes)
        daily_suggestions: {
            date: getTodayKey(),
            suggestions: currentSuggestions || [],
            done: dailySuggestionsDone || {}
        },
        // ------------------------------

        // Profil
	exam_date: userExamDate || "",
        custom_links: userLinks || [],
        unlocked_avatars: userUnlockedAvatars || ['fa-dragon'],
        current_avatar: userAvatar || 'fa-dragon',
        user_name: userName || "",
        user_alias: userAlias || "Docteur",
        
        last_update: new Date().toISOString()
    };

    try {
        await db.collection('users').doc(user.uid).set({ userData: dataToSave }, { merge: true });
        // console.log("Sauvegarde Cloud réussie."); // Optionnel pour debug
    } catch (error) {
        console.error("Erreur de sauvegarde :", error);
    }
}

        // --- NOTES LOGIC ---
        function initNotes() {
            const select = document.getElementById('notesMatiereSelect');
            const matieres = [...new Set(rawItems.map(i => i.m))].sort();
            
            let options = '<option value="Général">-- Général (Global) --</option>';
            options += matieres.map(m => `<option value="${m}">${m}</option>`).join('');
            select.innerHTML = options;
            
            const savedMatiere = localStorage.getItem('ultimed_notes_matiere') || "Général";
            if (matieres.includes(savedMatiere) || savedMatiere === "Général") {
                currentNotesMatiere = savedMatiere;
            }
            select.value = currentNotesMatiere;

            renderNotesPanel();
        }

        function getNotesMatiereConfig(matiereName) {
            if (matiereName === "Général") {
                return { name: "Notes Générales", color: 'gray', icon: 'fa-sticky-note', background: 'rgba(15, 15, 15, 0.3)', text: 'text-gray-400' };
            }
            const config = matiereConfig[matiereName] || defaultConfig;
            return {
                name: matiereName,
                color: config.color,
                icon: config.icon,
                background: `rgba(${getMatiereColorValue(config.color)}, 0.1)`, 
                text: `text-${config.color}-400`
            };
        }

        function getMatiereColorValue(colorName) {
            const colorMap = {
                'red': '185, 28, 28', 'sky': '14, 165, 233', 'indigo': '79, 70, 229', 'amber': '245, 158, 11', 'rose': '244, 63, 94', 
                'yellow': '250, 204, 21', 'orange': '251, 146, 60', 'pink': '236, 72, 153', 'cyan': '6, 182, 212', 'violet': '139, 92, 246',
                'teal': '20, 184, 166', 'lime': '132, 204, 22', 'emerald': '16, 185, 129', 'purple': '168, 85, 247', 'stone': '120, 113, 108',
                'blue': '59, 130, 246', 'gray': '107, 114, 128', 'slate': '100, 116, 139', 'fuchsia': '217, 70, 239', 'green': '34, 197, 94'
            };
            return colorMap[colorName] || '15, 15, 15'; 
        }

        function updateGlobalGlow(matiereName) {
            const glowOverlay = document.getElementById('matiereGlowOverlay');
            const config = getNotesMatiereConfig(matiereName);
            const colorValues = getMatiereColorValue(config.color);

            if (matiereName === "Général" || matiereName === "all" || !matiereName) {
                glowOverlay.style.opacity = '0';
            } else {
                glowOverlay.style.background = `radial-gradient(circle at center, rgba(${colorValues}, 0.1), rgba(${colorValues}, 0) 60%)`;
                glowOverlay.style.opacity = '1';
                glowOverlay.style.filter = 'blur(100px)';
            }
        }

        function renderNotesPanel() {
    const notesPanel = document.getElementById('notesPanel');
    const notesIcon = document.getElementById('notesIcon');
    const notesTitle = document.getElementById('notesTitle');
    const select = document.getElementById('notesMatiereSelect');
    
    const config = getNotesMatiereConfig(currentNotesMatiere);

    // 1. Textes et Icones
    if(notesIcon) notesIcon.className = `fa-solid ${config.icon} text-xs text-gray-300 group-hover:text-white transition-colors`;
    if(notesTitle) notesTitle.innerText = config.name;
    
    if(select && select.value !== currentNotesMatiere) select.value = currentNotesMatiere;

    // 2. Fond et Style de Base
    if(notesPanel) {
        notesPanel.classList.forEach(cls => {
             if (cls.startsWith('bg-')) notesPanel.classList.remove(cls); 
        });
        notesPanel.style.backgroundColor = config.background; 
        
        // --- LA MAGIE OPÈRE ICI ---
        // On récupère le code RGB de la matière (ex: "239, 68, 68" pour Cardio)
        const rgb = getMatiereColorValue(config.color);
        
        // On l'injecte dans la variable CSS du panneau
        notesPanel.style.setProperty('--glow-rgb', rgb);
        // -------------------------
    }
    
    updateGlobalGlow(currentNotesMatiere);

    if (typeof updateDashboardPreview === 'function') {
        updateDashboardPreview();
    }
}

        function changeNotesMatiere(newMatiere) {
    // 1. Mise à jour de la variable globale
    currentNotesMatiere = newMatiere;

    // 2. Sauvegarde de la préférence locale (pour s'en souvenir au prochain rechargement)
    localStorage.setItem('ultimed_notes_matiere', newMatiere);

    // 3. Mise à jour de l'interface (Couleur, Titre, Icone, Aperçu du texte)
    // Cette fonction appelle déjà updateDashboardPreview() à la fin
    renderNotesPanel();

    // 4. Petit feedback sonore
    playSound('subjectClick');
}

        function saveNotes(content) {
    // MODIFICATION : On enregistre dans la variable globale
    userSubjectNotes[currentNotesMatiere] = content;
    
    // Et on envoie au Cloud
    saveData();
    
    const indicator = document.getElementById('saveIndicator');
    if(indicator) {
        indicator.classList.remove('opacity-0');
        setTimeout(() => indicator.classList.add('opacity-0'), 1000);
    }
}

        // --- UNIFIED GLOBAL SETTINGS LOGIC ---
        function openGlobalSettings() {
    const modal = document.getElementById('globalSettingsModal');
    const content = document.getElementById('globalSettingsContent');
    
    // 1. Remplir les champs Profil
    document.getElementById('settingName').value = userName;
    document.getElementById('settingAlias').value = userAlias === "Docteur" ? "" : userAlias;
    document.getElementById('settingKey').value = userApiKey;
    
    // 2. Remplir la Date et Lancer le Calcul
    const dateInput = document.getElementById('settingDate');
    
    // On utilise la variable globale userExamDate (source de vérité)
    if (userExamDate) {
        dateInput.value = userExamDate;
        updateSettingPreview(userExamDate); // <--- C'EST CETTE LIGNE QUI AFFICHE LES JOURS
    } else {
        document.getElementById('settingDaysLeft').innerText = "--";
    }

    // 3. Ajouter l'écouteur d'événement sur l'input date
    // Pour que le nombre change en temps réel quand on modifie la date
    dateInput.onchange = (e) => updateSettingPreview(e.target.value);

    // 4. Remplir les Avatars & Sons
    renderGlobalAvatarSelection();
    const toggle = document.getElementById('settingSoundToggle');
    if(toggle) {
        toggle.checked = audioSystem.enabled;
        toggleSoundPreview(toggle);
    }

    // 5. Affichage Modale
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        content.classList.remove('scale-95');
        content.classList.add('scale-100');
    }, 10);
}

        function closeGlobalSettings() {
            const modal = document.getElementById('globalSettingsModal');
            const content = document.getElementById('globalSettingsContent');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function renderGlobalAvatarSelection() {
    const grid = document.getElementById('avatarGrid');
    if(!grid) return;
    
    // --- DÉBUT DU CORRECTIF DE SÉCURITÉ ---
    // On s'assure que la liste est bien un Tableau (Array), sinon on la répare
    let safeUnlocks = ['fa-dragon']; // Valeur par défaut
    
    if (Array.isArray(userUnlockedAvatars)) {
        safeUnlocks = userUnlockedAvatars;
    } else if (typeof userUnlockedAvatars === 'string') {
        try {
            safeUnlocks = JSON.parse(userUnlockedAvatars);
        } catch (e) {
            console.warn("Erreur lecture avatars, utilisation défaut.");
        }
    }
    // --------------------------------------

    // Map inversée pour trouver le niveau requis
    const iconToLevel = {};
    for (const [lvl, icon] of Object.entries(levelRewards)) {
        iconToLevel[icon] = lvl;
    }

    grid.innerHTML = availableAvatars.map(icon => {
        // On utilise notre liste sécurisée 'safeUnlocks'
        const isUnlocked = safeUnlocks.includes(icon);
        const isSelected = icon === userAvatar;
        
        if (isUnlocked) {
            // CAS 1 : DÉBLOQUÉ
            const activeClass = isSelected 
                ? 'bg-white text-black border-white shadow-[0_0_15px_rgba(255,255,255,0.5)]' 
                : 'bg-[#151515] text-gray-600 border-white/5 hover:bg-white/10 hover:text-gray-300';
            
            return `
                <button onclick="userAvatar = '${icon}'; renderGlobalAvatarSelection(); playSound('click');" class="aspect-square rounded-xl border ${activeClass} flex items-center justify-center transition-all duration-300 text-lg group relative" title="Choisir">
                    <i class="fa-solid ${icon}"></i>
                    ${isSelected ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border border-black"></div>' : ''}
                </button>
            `;
        } else {
            // CAS 2 : BLOQUÉ
            const requiredLevel = iconToLevel[icon] || "?";
            return `
                <div class="aspect-square rounded-xl border border-white/5 bg-black/40 text-gray-800 flex flex-col items-center justify-center cursor-not-allowed group relative overflow-hidden" title="Niveau ${requiredLevel} requis">
                    <i class="fa-solid fa-lock text-xs mb-1"></i>
                    <span class="text-[8px] font-mono font-bold text-gray-600">LVL ${requiredLevel}</span>
                    <i class="fa-solid ${icon} absolute opacity-10 text-4xl transform scale-150 rotate-12 pointer-events-none"></i>
                </div>
            `;
        }
    }).join('');
}


        function updateSettingPreview(dateStr) {
    if (!dateStr) {
        document.getElementById('settingDaysLeft').innerText = "--";
        return;
    }

    const target = new Date(dateStr);
    const today = new Date();
    
    // Calcul de la différence en millisecondes
    const diffTime = target - today;
    // Conversion en jours (arrondi au supérieur)
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    const el = document.getElementById('settingDaysLeft');
    
    if (el) {
        if (diffDays < 0) {
            el.innerText = "0";
            el.className = "text-3xl font-mono font-black text-gray-500"; // Gris si passé
        } else {
            el.innerText = diffDays;
            // Rouge si urgence (< 30 jours), sinon Blanc
            el.className = diffDays <= 30 
                ? "text-3xl font-mono font-black text-red-500 animate-pulse" 
                : "text-3xl font-mono font-black text-white";
        }
    }
}

        function saveGlobalSettings() {
    const name = document.getElementById('settingName').value.trim();
    const alias = document.getElementById('settingAlias').value.trim();
    
    // Mise à jour Profil
    userName = name;
    userAlias = alias || "Docteur";

    // Mise à jour Date Concours
    const date = document.getElementById('settingDate').value;
    if (date) {
        userExamDate = date; // On met à jour la variable globale
        updateCountdownDisplay(date);
    }

    // Mise à jour Clé API
    const key = document.getElementById('settingKey').value.trim();
    if (key) {
        userApiKey = key;
        localStorage.setItem('ultimed_apiKey', key); // On garde la clé en local par sécurité/facilité
    }
    
    // Son
    const soundEnabled = document.getElementById('settingSoundToggle').checked;
    audioSystem.enabled = soundEnabled;
    localStorage.setItem('ultimed_sound_enabled', soundEnabled);

    // Avatar Dino
    const dinoIcon = document.getElementById('dinoIcon');
    dinoIcon.className = `fa-solid ${userAvatar} text-6xl text-gray-500 transition-colors duration-300`;

    updateGreetingDisplay();

    // SAUVEGARDE FINALE DANS LE CLOUD
    saveData();

    showToast("Configuration enregistrée !", "success");
    closeGlobalSettings();
}

// --- CHANGEMENT DE MOT DE PASSE ---
function updateUserPassword() {
    const newPass = document.getElementById('settingNewPassword').value;
    const user = auth.currentUser;

    // Vérifications de base
    if (!user) {
        showToast("Vous devez être connecté.", "error");
        return;
    }
    
    if (!newPass || newPass.length < 6) {
        showToast("Le mot de passe doit contenir au moins 6 caractères.", "error");
        playSound('error');
        return;
    }

    // Mise à jour via Firebase
    // Note : Firebase demande une "connexion récente" pour cette action sensible.
    user.updatePassword(newPass).then(() => {
        // Succès
        playSound('success');
        showToast("Mot de passe modifié avec succès !", "success");
        document.getElementById('settingNewPassword').value = ""; // Vider le champ
    }).catch((error) => {
        // Gestion des erreurs
        playSound('error');
        if (error.code === 'auth/requires-recent-login') {
            showToast("Par sécurité, veuillez vous déconnecter et vous reconnecter avant de changer le mot de passe.", "error");
        } else {
            showToast("Erreur : " + error.message, "error");
        }
    });
}

        function updateGreetingDisplay() {
    const hour = new Date().getHours();
    const greeting = hour >= 18 || hour < 5 ? "Bonsoir" : "Bonjour";
    const targetName = userName || userAlias;
    
    // 1. Mise à jour du titre principal
    const greetingEl = document.getElementById('greetingDisplay');
    if(greetingEl) greetingEl.innerText = `${greeting}, ${targetName}.`;
    
    // 2. Mise à jour de l'icône du logo (Header Gauche)
    const navIcon = document.getElementById('navbarIcon');
    if(navIcon) navIcon.className = `fa-solid ${userAvatar} text-3xl text-white relative z-10 group-hover:scale-110 transition-transform`;

    // 3. Mise à jour du Menu Profil (Header Droite)
    const headerUserIcon = document.getElementById('headerUserIcon');
    if(headerUserIcon) headerUserIcon.className = `fa-solid ${userAvatar} text-lg group-hover:scale-110 transition-transform`;
    
    const menuUserName = document.getElementById('menuUserName');
    if(menuUserName) menuUserName.innerText = targetName;

    // --- 4. CORRECTION : SYNCHRONISATION DE LA CRÉATURE DU TIMER ---
    const dinoIcon = document.getElementById('dinoIcon');
    if (dinoIcon) {
        // On détermine si la créature doit dormir ou être éveillée selon l'état du timer
        // Note : isTimerRunning est votre variable globale
        const animationState = (typeof isTimerRunning !== 'undefined' && isTimerRunning) ? '' : 'animate-dino-sleep';
        
        // On force la mise à jour de l'icône avec le bon avatar
        dinoIcon.className = `fa-solid ${userAvatar} text-6xl text-gray-500 transition-colors duration-300 ${animationState}`;
    }
    // ---------------------------------------------------------------
}

function updateCountdownDisplay(dateStr) {
    if(!dateStr) return;
    const examDate = new Date(dateStr);
    const today = new Date();
    const diffTime = examDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    const displayEl = document.getElementById('countdownDisplay');
    const miniDateEl = document.getElementById('targetDateMini');

    const options = { day: 'numeric', month: 'short', year: 'numeric' };
    if(miniDateEl) miniDateEl.innerText = examDate.toLocaleDateString('fr-FR', options);
    
    // Base de style commune
    const baseStyle = "font-display font-black text-lg leading-none tracking-wide digit-scroll drop-shadow-md transition-colors duration-300";

    if (diffDays < 0) {
        displayEl.innerText = "Terminé";
        displayEl.className = `text-gray-500 ${baseStyle}`;
    } else if (diffDays === 0) {
         displayEl.innerText = "JOUR J";
         displayEl.className = `text-red-500 animate-pulse ${baseStyle}`;
    } else {
        displayEl.innerText = diffDays;
        
        if (diffDays <= 30) { 
            // URGENCE (< 30 jours) : Rouge Vif
            displayEl.className = `text-red-500 ${baseStyle}`;
        } else { 
            // NORMAL : Orange (au lieu de Jaune)
            displayEl.className = `text-orange-400 ${baseStyle}`;
        }
    }
}

        // Cette fonction doit être EN DEHORS de updateCountdownDisplay
        function trackResourceView(itemId, type) {
            if (!sessionViewedResources[itemId]) {
                sessionViewedResources[itemId] = [];
            }
            if (!sessionViewedResources[itemId].includes(type)) {
                sessionViewedResources[itemId].push(type);
            }
        }

// --- TIMER ANIMATION & LOGIQUE ---

let timerTargetSeconds = 0;

// --- NOUVELLE LOGIQUE OBJECTIF (INTERACTIVE) ---

// 1. Ouvrir / Fermer le panneau
function toggleGoalPanel() {
playSound('click');
    const panel = document.getElementById('goalControlPanel');
    const btn = document.getElementById('goalDisplayBtn');
    
    if (panel.classList.contains('invisible')) {
        // Ouvrir
        panel.classList.remove('invisible', 'opacity-0', '-translate-y-2');
        btn.classList.add('border-blue-500'); // Active state
    } else {
        // Fermer
        panel.classList.add('invisible', 'opacity-0', '-translate-y-2');
        btn.classList.remove('border-blue-500');
    }
}

// Fermer le panneau si on clique ailleurs
document.addEventListener('click', (e) => {
    const panel = document.getElementById('goalControlPanel');
    const btn = document.getElementById('goalDisplayBtn');
    // On vérifie que les éléments existent pour éviter les erreurs si on est sur une autre vue
    if (panel && btn && !panel.contains(e.target) && !btn.contains(e.target)) {
        panel.classList.add('invisible', 'opacity-0', '-translate-y-2');
        btn.classList.remove('border-blue-500');
    }
});

// 2. Mise à jour via le Slider
function updateGoalFromInput(minutes) {
    const mins = parseInt(minutes) || 0;
    
    // 1. Mise à jour du Slider
    const slider = document.getElementById('goalSlider');
    if (slider) slider.value = mins;

    // 2. Mise à jour de l'affichage texte
    const manual = document.getElementById('goalInputManual');
    if (manual) {
        // J'ai ajouté 'tracking-tighter' dans les deux cas
        if (mins === 0) {
            manual.value = "Libre";
            manual.className = "w-28 bg-black/20 border border-white/5 rounded-lg py-1.5 px-0 text-center text-gray-500 text-xs font-bold tracking-tighter focus:outline-none cursor-default flex-shrink-0";
        } else {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            manual.value = `${h} h ${m.toString().padStart(2, '0')} min`;
            manual.className = "w-28 bg-black/20 border border-white/5 rounded-lg py-1.5 px-0 text-center text-blue-400 text-xs font-bold tracking-tighter focus:outline-none cursor-default flex-shrink-0";
        }
    }

    // 3. Application de l'objectif
    applyGoal(mins);
}

function setPresetGoal(minutes) {
    playSound('click');
    // On utilise la fonction principale pour tout mettre à jour d'un coup
    updateGoalFromInput(minutes);
    
    // Fermer le panneau après un clic sur un preset (sauf désactiver)
    if (minutes > 0) setTimeout(toggleGoalPanel, 300);
}

// 4. Fonction centrale d'application
function applyGoal(minutes) {
    // On récupère les éléments, mais on ne touchera pas à displayEl pour le texte
    const msg = document.getElementById('timerMessage');
    const barContainer = document.getElementById('timerProgressBarContainer');

    if (minutes <= 0) {
        // Désactivation
        timerTargetSeconds = 0;
        
        // On cache juste la barre de progression et le message du bas
        if(barContainer) barContainer.classList.add('hidden');
        if(msg) msg.style.opacity = '0';
        
    } else {
        // Activation
        timerTargetSeconds = minutes * 60;
        
        // ON NE MODIFIE PLUS L'AFFICHAGE DU BOUTON ICI
        // Le texte "Libre" ou la durée restera caché par la classe "hidden" du HTML
        
        // On met à jour uniquement la barre de progression et le message sous le timer
        updateTimerUI(timerTargetSeconds);
    }
}

function updateTimerUI(targetSecs) {
    const barContainer = document.getElementById('timerProgressBarContainer');
    const msg = document.getElementById('timerMessage');

    if (targetSecs > 0) {
        barContainer.classList.remove('hidden');
        // Conversion inverse pour affichage propre (ex: 1h 30min)
        const h = Math.floor(targetSecs / 3600);
        const m = Math.floor((targetSecs % 3600) / 60);
        let label = "Objectif : ";
        if (h > 0) label += `${h}h `;
        if (m > 0) label += `${m}min`;
        
        msg.innerText = label;
        msg.style.opacity = '1';
        if (!isTimerRunning) dinoSpeak(`Cible verrouillée : ${label}.`, 'info');
    } else {
        barContainer.classList.add('hidden');
        msg.style.opacity = '0';
    }
    updateTimerDisplay();
}

function triggerChronoAnimation() {
            const overlay = document.getElementById('chronoStartOverlay');
            if(!overlay) return;
            
            // --- AJOUT : Mise à jour de l'icône avec l'avatar du profil ---
            const icon = overlay.querySelector('i');
            if (icon) {
                // On conserve les styles (couleur cyan, taille, effet neon) et on injecte userAvatar
                icon.className = `fa-solid ${userAvatar} text-5xl text-cyan-400 drop-shadow-[0_0_15px_rgba(34,211,238,0.8)] animate-pulse`;
            }

            playSound('chronoStart');

            overlay.classList.remove('hidden');
            // Petit délai pour laisser le temps au navigateur d'afficher le bloc avant de changer l'opacité
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
            }, 10);

            setTimeout(() => {
                overlay.classList.add('opacity-0');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 700);
            }, 2500);
        }

        // 2. Animation du Dinosaure (Clic)
// Liste étendue de messages motivants
const motivationMessages = [
    "Tu as le potentiel d'un Major. Au travail !",
    "La douleur de la discipline ou la douleur du regret. Choisis.",
    "Une heure de focus maintenant, c'est une place gagnée demain.",
    "Respire un bon coup. On y retourne.",
    "Ne regarde pas le sommet, regarde la prochaine marche.",
    "Ton futur toi te remerciera pour cette session.",
    "Pas d'excuses. Juste des résultats.",
    "La médecine s'apprend par la répétition. Encore une fois !",
    "Concentre-toi. Tu es plus fort que ta distraction."
];

function triggerDinoJump() {
    const dinoWrapper = document.getElementById('dinoWrapper');
    const dinoZzz = document.getElementById('dinoZzz');
    
    // 1. Si le chrono tourne
    if (isTimerRunning) {
        dinoSpeak("Je surveille le chrono. Reste concentré !", 'info');
        return;
    }

    // 2. Sinon, on réveille le dino
    dinoZzz.classList.add('opacity-0');
    
    // Choix message
    const msg = motivationMessages[Math.floor(Math.random() * motivationMessages.length)];
    
    // On fait parler le dino (en mode info/bleu)
    dinoSpeak(msg, 'info');
    playSound('creature');

    // Particules
    for (let i = 0; i < 3; i++) {
        createDiamondParticle(dinoWrapper);
    }
}

// Fonctions utilitaires pour la bulle
function showBubble() {
    const bubble = document.getElementById('dinoSpeechBubble');
    bubble.classList.remove('hidden');
    // Petit délai pour permettre la transition CSS d'opacité
    setTimeout(() => {
        bubble.classList.remove('opacity-0', 'translate-y-2');
    }, 10);
}

function hideBubble() {
    const bubble = document.getElementById('dinoSpeechBubble');
    bubble.classList.add('opacity-0', 'translate-y-2');
    setTimeout(() => {
        bubble.classList.add('hidden');
    }, 300);
}
        function createDiamondParticle(parent) {
            const particle = document.createElement('i');
            particle.className = `fa-solid fa-gem text-cyan-300 diamond-particle`;
            const leftOffset = (Math.random() - 0.5) * 50; 
            particle.style.left = `calc(50% + ${leftOffset}px)`;
            particle.style.top = '-10px';
            particle.style.animationDelay = Math.random() * 0.2 + 's';
            parent.appendChild(particle);
            setTimeout(() => { particle.remove(); }, 1200);
        }

        function getDinoVisuals() {
            if (seconds >= 21600) return { color: 'text-red-500 drop-shadow-[0_0_30px_rgba(239,68,68,1)]', glow: 'rgba(239, 68, 68, 0.6)', hex: '#ef4444' };
            if (seconds >= 14400) return { color: 'text-cyan-400 drop-shadow-[0_0_25px_rgba(34,211,238,0.9)]', glow: 'rgba(34, 211, 238, 0.5)', hex: '#22d3ee' };
            if (seconds >= 7200) return { color: 'text-purple-500 drop-shadow-[0_0_20px_rgba(168,85,247,0.8)]', glow: 'rgba(168, 85, 247, 0.4)', hex: '#a855f7' };
            if (seconds >= 3600) return { color: 'text-yellow-400 drop-shadow-[0_0_15px_rgba(250,204,21,0.7)]', glow: 'rgba(250, 204, 21, 0.3)', hex: '#facc15' };
            return { color: 'text-blue-400', glow: 'rgba(59, 130, 246, 0.2)', hex: '#3b82f6' };
        }

        function updateDinoVisuals() {
            const dino = document.getElementById('dinoIcon');
            const glow = document.getElementById('timerGlow');
            const visuals = getDinoVisuals();

            const animationClass = dino.classList.contains('fa-beat') ? 'fa-beat' : 'animate-pulse';
            dino.className = `fa-solid ${userAvatar} ${animationClass} text-6xl transition-all duration-500 ${visuals.color}`;

            const scale = 1 + (seconds / 21600) * 0.5; 
            glow.style.backgroundColor = visuals.glow;
            glow.style.transform = `scale(${scale})`;
            glow.style.opacity = Math.min(1, 0.3 + (seconds / 3600) * 0.1);
        }

        function toggleTimer() {
playSound('click');
            const btn = document.getElementById('timerBtn');
            const icon = document.getElementById('timerIcon');
            const glow = document.getElementById('timerGlow');
            const dinoIcon = document.getElementById('dinoIcon');
            const dinoZzz = document.getElementById('dinoZzz');
            
            if(isTimerRunning) {
                clearInterval(timerInterval);
                icon.classList.remove('fa-pause'); icon.classList.add('fa-play');
                btn.classList.remove('animate-button-pulse');
                glow.classList.remove('scale-100', 'opacity-100'); glow.classList.add('scale-50', 'opacity-0');
                glow.style = ''; 
                document.getElementById('timerDisplay').classList.remove('timer-active');
                
                dinoIcon.className = `fa-solid ${userAvatar} text-6xl text-gray-500 transition-colors duration-300 animate-dino-sleep`;
                dinoZzz.classList.remove('hidden');
            } else {
                if (seconds === 0) {
                    triggerChronoAnimation();
                }
                timerInterval = setInterval(() => { seconds++; updateTimerDisplay(); updateDinoVisuals(); checkTimerMilestones(); }, 1000);
                icon.classList.remove('fa-play'); icon.classList.add('fa-pause');
                btn.classList.add('animate-button-pulse');
                glow.classList.remove('scale-50', 'opacity-0'); glow.classList.add('scale-100', 'opacity-100');
                document.getElementById('timerDisplay').classList.add('timer-active');
                
                updateDinoVisuals();
                dinoZzz.classList.add('hidden');
            }
            isTimerRunning = !isTimerRunning;
        }

        function resetTimer() {
     playSound('click');
     clearInterval(timerInterval); 
     isTimerRunning = false; 
     seconds = 0; 

     updateTimerDisplay(); 

     const btn = document.getElementById('timerBtn');
     const icon = document.getElementById('timerIcon');
     const glow = document.getElementById('timerGlow');
     const dinoIcon = document.getElementById('dinoIcon');
     const dinoZzz = document.getElementById('dinoZzz');
     const display = document.getElementById('timerDisplay');

     icon.classList.remove('fa-pause'); icon.classList.add('fa-play');
     btn.classList.remove('animate-button-pulse');
     glow.classList.remove('scale-100', 'opacity-100'); glow.classList.add('scale-50', 'opacity-0');
     glow.style = ''; 
     display.classList.remove('timer-active', 'text-green-400');
     
     dinoIcon.className = `fa-solid ${userAvatar} text-6xl text-gray-500 transition-colors duration-300`;
     dinoZzz.classList.remove('hidden');
}

        function updateTimerDisplay() {
    const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
    const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    
    // Affichage Numérique
    const display = document.getElementById('timerDisplay');
    if (seconds >= 3600) {
        display.innerText = `${hrs}:${mins}:${secs}`;
        display.classList.replace('text-6xl', 'text-5xl');
    } else {
        display.innerText = `${mins}:${secs}`;
        display.classList.replace('text-5xl', 'text-6xl');
    }

    // --- LOGIQUE BOUTON FINIR (CLIGNOTE APRÈS 1 MIN) ---
    const finishBtn = document.getElementById('finishBtn');
    
    if (seconds >= 60) { // Seulement après 1 minute !
        finishBtn.disabled = false;
        finishBtn.classList.remove('opacity-30', 'cursor-not-allowed', 'scale-90');
        // Ajout de l'animation de clignotement
        finishBtn.classList.add('animate-pulse-glow'); 
    } else {
        finishBtn.disabled = true;
        finishBtn.classList.add('opacity-30', 'cursor-not-allowed', 'scale-90');
        // Retrait de l'animation
        finishBtn.classList.remove('animate-pulse-glow');
    }
    // ----------------------------------------------------

    // Barre de progression & Cercle
    const progressBar = document.getElementById('timerProgressBar');
    const playCircle = document.getElementById('playBtnProgress');
    
    if (timerTargetSeconds > 0) {
        const pct = Math.min((seconds / timerTargetSeconds) * 100, 100);
        progressBar.style.width = `${pct}%`;
        const offset = 188 - (188 * pct) / 100;
        playCircle.style.strokeDashoffset = offset;

        if (pct >= 100) {
            progressBar.classList.replace('bg-blue-500', 'bg-green-500');
            progressBar.classList.add('shadow-[0_0_15px_rgba(34,197,94,0.8)]');
            playCircle.style.stroke = '#22c55e';
            display.classList.add('text-green-400', 'drop-shadow-[0_0_10px_rgba(34,197,94,0.8)]');
        } else {
             progressBar.classList.replace('bg-green-500', 'bg-blue-500');
             progressBar.classList.remove('shadow-[0_0_15px_rgba(34,197,94,0.8)]');
             playCircle.style.stroke = '#3b82f6';
             display.classList.remove('text-green-400', 'drop-shadow-[0_0_10px_rgba(34,197,94,0.8)]');
        }
    } else {
        playCircle.style.strokeDashoffset = 188;
    }
}

function finishSession() {
    if (seconds < 60) {
        showToast("Session trop courte (< 1 min).", "info");
        return;
    }

    if (isTimerRunning) toggleTimer(); 

    const minutes = Math.floor(seconds / 60);
    // XP basée sur le temps (5 XP / min)
    let xpGain = minutes * 5; 
    let bonusMsg = "";

    // Bonus si l'objectif est atteint
    if (timerTargetSeconds > 0 && seconds >= timerTargetSeconds) {
        const bonus = 100; 
        xpGain += bonus;
        bonusMsg = "Objectif atteint (+100 XP)";
        playSound('mastery');
    } else {
        playSound('success');
    }

    addXP(xpGain, `Session ${minutes} min`);
    showSessionReport(minutes, xpGain, bonusMsg);
    resetTimer();
}

function showSessionReport(minutes, xp, bonus) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast border-l-4 border-blue-500 flex flex-col gap-1 items-start py-4`;
    toast.style.background = "linear-gradient(135deg, rgba(15,23,42,0.95), rgba(30,58,138,0.9))";
    
    toast.innerHTML = `
        <div class="flex items-center gap-3 w-full border-b border-white/10 pb-2 mb-1">
            <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400">
                <i class="fa-solid fa-stopwatch"></i>
            </div>
            <div>
                <h4 class="text-white font-bold text-sm uppercase tracking-wide">Session Terminée</h4>
                <span class="text-blue-300 text-xs font-mono">${new Date().toLocaleTimeString()}</span>
            </div>
        </div>
        <div class="w-full space-y-1 pl-11">
            <div class="flex justify-between text-gray-300 text-sm">
                <span>Durée :</span> <span class="text-white font-bold">${minutes} min</span>
            </div>
            <div class="flex justify-between text-gray-300 text-sm">
                <span>XP Gagnée :</span> <span class="text-yellow-400 font-bold">+${xp} XP</span>
            </div>
            ${bonus ? `<div class="text-xs text-green-400 font-bold mt-1"><i class="fa-solid fa-check"></i> ${bonus}</div>` : ''}
        </div>
    `;
    
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'toastSlide 0.3s ease-in reverse forwards';
        setTimeout(() => toast.remove(), 300);
    }, 6000); // Reste 6 secondes
}

        function checkTimerMilestones() {
            const milestones = [3600, 7200, 14400, 21600];

            if (milestones.includes(seconds)) {
                showFocusMilestone(motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]);
                
                const dinoIcon = document.getElementById('dinoIcon');
                const visuals = getDinoVisuals(); 
                
                dinoIcon.className = `fa-solid ${userAvatar} fa-beat text-6xl ${visuals.color} transition-all duration-300`;
                
                const timerFlame = document.getElementById('timerFlame');
                timerFlame.style.backgroundColor = visuals.hex;
                timerFlame.style.opacity = '0.1';
                timerFlame.classList.remove('hidden');

                triggerScreenParticles(visuals.hex);
                
                setTimeout(() => { 
                    if(isTimerRunning) updateDinoVisuals(); 
                    timerFlame.classList.add('hidden');
                }, 3000);
            } 
            else if (seconds % 20 === 0 && seconds > 0) {
                const dino = document.getElementById('dinoWrapper');
                dino.classList.add('animate-dino-bounce');
                setTimeout(() => dino.classList.remove('animate-dino-bounce'), 1000);
            }
        }

        function triggerScreenParticles(colorHex) {
            const flash = document.createElement('div');
            flash.className = 'screen-flash';
            flash.style.backgroundColor = colorHex || '#3b82f6';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 600);

            for(var i=0; i<40; i++) { 
                var p = document.createElement('div'); p.classList.add('particle');
                p.style.left = Math.random() * 100 + 'vw'; p.style.top = Math.random() * 100 + 'vh';
                p.style.backgroundColor = colorHex || '#3b82f6'; 
                p.style.boxShadow = `0 0 10px ${colorHex || '#3b82f6'}`;
                p.style.animationDuration = (Math.random() * 1.5 + 0.5) + 's';
                document.body.appendChild(p); setTimeout(() => p.remove(), 2000);
            }

            const shock = document.createElement('div'); 
            shock.className = 'shockwave-ring';
            shock.style.borderColor = colorHex || '#3b82f6'; 
            document.getElementById('shockwaveContainer').appendChild(shock); 
            setTimeout(() => shock.remove(), 1000);
        }

        function showFocusMilestone(quote) {
             const overlay = document.getElementById('focusOverlay');
             document.getElementById('focusQuote').innerText = quote;
             overlay.classList.remove('hidden'); void overlay.offsetWidth; overlay.classList.remove('opacity-0');
             setTimeout(() => { overlay.classList.add('opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 1000); }, 2500);
        }

        // --- TODO LOGIC ---
        function addTodo() {
    const input = document.getElementById('todoInput');
    const val = input.value.trim();
    if(val) {
        var foundId = null;
        // On essaie de trouver un ID dans le texte (ex: "Réviser le 154")
        const match = val.match(/(\d+)/);
        if (match) {
              const possibleId = match[1];
              // On vérifie que cet ID existe vraiment dans la base
              if (rawItems.find(i => i.id === possibleId)) foundId = possibleId;
        }
        
        // Ajout au Todo
        userTodos.push({ text: val, done: false, id: Date.now(), linkedItemId: foundId });

        // --- SYNCHRONISATION CALENDRIER (AJOUT) ---
        if (foundId) {
            const todayKey = new Date().toISOString().split('T')[0];
            if (!userPlanning[todayKey]) userPlanning[todayKey] = [];
            
            if (!userPlanning[todayKey].includes(foundId)) {
                userPlanning[todayKey].push(foundId);
            }
        }
        // ------------------------------------------
        
        input.value = '';
        saveData();
        renderTodos();
        
        // Rafraîchissement Calendrier
        if (!document.getElementById('calendarView').classList.contains('hidden')) {
            renderCalendar();
            if (selectedCalendarDate === todayKey && foundId) renderDayDetails(todayKey);
        }
    }
}
        
function addToTodos(id, title) {
    // 1. Vérification doublon
    const exists = userTodos.some(t => t.linkedItemId === id);
    
    if (exists) {
        playSound('error');
        showToast("Cet item est déjà dans vos objectifs.", "info");
        return;
    }

    // 2. Ajout liste "To-Do"
    userTodos.push({
        text: `Item ${id} - ${title}`,
        done: false,
        id: Date.now(),
        linkedItemId: id
    });

    // 3. Synchro Calendrier (Aujourd'hui)
    const todayKey = new Date().toISOString().split('T')[0];
    if (!userPlanning[todayKey]) userPlanning[todayKey] = [];
    
    if (!userPlanning[todayKey].includes(id)) {
        userPlanning[todayKey].push(id);
    }

    // 4. Sauvegarde
    saveData();
    
    // 5. Mises à jour visuelles
    renderTodos(); // Met à jour la liste latérale
    render();      // <--- C'EST ICI : Met à jour le bouton sur la carte (Gris -> Bleu)
    
    // Met à jour le calendrier s'il est ouvert
    if (!document.getElementById('calendarView').classList.contains('hidden')) {
        renderCalendar();
        if (selectedCalendarDate === todayKey) renderDayDetails(todayKey);
    }
    
    // 6. Feedback
    playSound('success');
    showToast(`Item ${id} ajouté aux objectifs !`, "success");
    
    // Animation panneau latéral
    const todoPanel = document.querySelector('#todoList').parentElement;
    todoPanel.classList.add('ring-2', 'ring-blue-500', 'ring-opacity-50');
    setTimeout(() => todoPanel.classList.remove('ring-2', 'ring-blue-500', 'ring-opacity-50'), 500);
}

        function addSpecificTodo(id, title) {
    // Création du Todo
    userTodos.push({ 
        text: `Item ${id} - ${title.substring(0, 25)}...`, 
        done: false, 
        id: Date.now(), 
        linkedItemId: id 
    });

    // --- SYNCHRONISATION CALENDRIER (AJOUT) ---
    const todayKey = new Date().toISOString().split('T')[0];
    if (!userPlanning[todayKey]) userPlanning[todayKey] = [];
    
    if (!userPlanning[todayKey].includes(id)) {
        userPlanning[todayKey].push(id);
    }
    // ------------------------------------------

    // Nettoyage UI
    document.getElementById('todoInput').value = '';
    document.getElementById('autocompleteList').classList.add('hidden');
    
    // Sauvegarde
    saveData();
    renderTodos();
    
    // Rafraîchissement Calendrier si ouvert
    if (!document.getElementById('calendarView').classList.contains('hidden')) {
        renderCalendar();
        if (selectedCalendarDate === todayKey) renderDayDetails(todayKey);
    }

    showToast('Objectif ajouté au planning', 'success');
}

        function toggleTodo(id) {
    const todo = userTodos.find(t => t.id === id);
    
    if (!todo) {
        console.error("Objectif ID introuvable lors du basculement:", id);
        return;
    }
    
    // 1. Bascule de l'état visuel
    todo.done = !todo.done; 

    // 2. LOGIQUE CENTRALE (Calcul et attribution)
    if (todo.linkedItemId) {
        const itemId = todo.linkedItemId;
        
        // Initialisation de Sécurité des compteurs
        if (!userVues[itemId]) userVues[itemId] = 0;
        if (!userStatus[itemId]) userStatus[itemId] = null;
        if (!userXPClaimed) userXPClaimed = {};
        if (!userXPClaimed[itemId]) userXPClaimed[itemId] = {};

        if (todo.done) {
            // --- CAS : TÂCHE ACCOMPLIE (+1 Point / Vue) ---
            
            // A. Incrémentation
            userVues[itemId]++;
            
            // B. Mise à jour du Statut (Automatique)
            let justLeveledUp = false;

            if (userVues[itemId] === 1 && !userStatus[itemId]) {
                userStatus[itemId] = 'lu';
                addXP(50, '1er passage (Objectif)');
                justLeveledUp = true;
            }
            else if (userVues[itemId] === 6 && userStatus[itemId] !== 'maitrise') {
                userStatus[itemId] = 'maitrise';
                addXP(200, 'Maîtrise (Objectif)');
                showCelebration();
                justLeveledUp = true;
            }
            else if (userVues[itemId] === 10) {
                userStatus[itemId] = 'legendaire'; // Mise à jour interne du statut pour le fun
                addXP(1000, 'LÉGENDAIRE (Objectif)');
                showLegendaryCelebration();
                justLeveledUp = true;
            } 
            
            if (!justLeveledUp) {
                addXP(20, 'Objectif validé');
            }

            // C. Ajout au Calendrier
            trackHistory(itemId); 
            playSound('success');

        } else {
            // --- CAS : DÉCOCHAGE (Undo / -1 Point) ---
            
            if (userVues[itemId] > 0) userVues[itemId]--;
            
            // Rétrogradation des statuts
            if (userVues[itemId] === 0) userStatus[itemId] = null;
            else if (userVues[itemId] < 6 && userStatus[itemId] === 'maitrise') userStatus[itemId] = 'lu';
            
            // Retrait du calendrier
            const todayKey = new Date().toISOString().split('T')[0];
            if (userHistory[todayKey]) {
                userHistory[todayKey] = userHistory[todayKey].filter(x => x !== itemId);
                if (userHistory[todayKey].length === 0) delete userHistory[todayKey];
            }
        }
    } else {
        // Tâche manuelle
        if(todo.done) {
            addXP(10, 'Tâche terminée');
            playSound('click');
        }
    }
    
    // 3. SAUVEGARDE
    saveData();
    
    // 4. MISE À JOUR VISUELLE COMPLÈTE (Chaine de rendu)
    buildCourses();      // Reconstruit l'objet 'courses' avec les nouvelles vues/statuts
    renderTodos();       // Met à jour la liste latérale
    render();            // Met à jour la grille (cartes Lu/Maîtrisé)
    updateStats();       // Met à jour les cercles de stats
    
    // Mise à jour Calendrier (pour voir le point vert ou sa suppression)
    const calView = document.getElementById('calendarView');
    if (calView && !calView.classList.contains('hidden')) {
        renderCalendar();
        const todayKey = new Date().toISOString().split('T')[0];
        if (typeof selectedCalendarDate !== 'undefined' && selectedCalendarDate === todayKey) {
            renderDayDetails(todayKey);
        }
    }
}
        
function toggleTodoFromCard(id, title) {
    // On cherche si l'objectif existe déjà pour cet Item
    const existingTodo = userTodos.find(t => t.linkedItemId === id);

    if (existingTodo) {
        // CAS 1 : IL EXISTE DÉJÀ -> ON LE SUPPRIME
        // On utilise la fonction deleteTodo qu'on a déjà corrigée
        deleteTodo(existingTodo.id);
    } else {
        // CAS 2 : IL N'EXISTE PAS -> ON L'AJOUTE
        addToTodos(id, title);
    }
}

        function deleteTodo(id) {
    // 1. On trouve l'objectif avant de le supprimer pour avoir son ID d'item
    const todoToDelete = userTodos.find(t => t.id === id);
    
    if (todoToDelete) {
        // --- SYNCHRO SUPPRESSION CALENDRIER ---
        // Si cet objectif est lié à un Item (ex: Item 154)
        if (todoToDelete.linkedItemId) {
            const todayKey = new Date().toISOString().split('T')[0];
            
            // On vérifie s'il est dans le planning d'aujourd'hui
            if (userPlanning[todayKey]) {
                // On le retire du tableau du jour
                userPlanning[todayKey] = userPlanning[todayKey].filter(itemId => itemId !== todoToDelete.linkedItemId);
                
                // Si le tableau est vide, on nettoie la clé
                if (userPlanning[todayKey].length === 0) delete userPlanning[todayKey];
            }
        }
        // --------------------------------------

        // 2. Suppression de la liste des objectifs
        userTodos = userTodos.filter(t => t.id !== id);
        
        // 3. Sauvegarde
        saveData(); 

        // 4. Mises à jour visuelles
        renderTodos(); // Met à jour la liste latérale
        render();      // <--- IMPORTANT : Remet le bouton de la carte en GRIS (+)
        
        // Met à jour le calendrier s'il est ouvert (retire le point bleu)
        if (!document.getElementById('calendarView').classList.contains('hidden')) {
            renderCalendar();
            const todayKey = new Date().toISOString().split('T')[0];
            if (selectedCalendarDate === todayKey) renderDayDetails(todayKey);
        }
        
        playSound('click');
        showToast("Objectif supprimé (Planning mis à jour)", "info");
    }
}

        function renderTodos() {
            const list = document.getElementById('todoList');
            
            list.innerHTML = userTodos.map(t => {
                // Est-ce que cet objectif est lié à une fiche item ?
                const isLinked = t.linkedItemId ? true : false;
                
                // Configuration du clic et du style
                // On appelle la nouvelle fonction 'goToDashboardItem' au lieu de 'openItemDetail'
const clickAction = isLinked ? `onclick="goToDashboardItem('${t.linkedItemId}')"` : '';
                const cursorClass = isLinked ? 'cursor-pointer hover:text-blue-400 transition-colors' : '';
                const tooltip = isLinked ? 'title="Ouvrir la fiche de révision"' : '';

                return `
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition group">
                    
                    <button onclick="toggleTodo(${t.id})" class="w-5 h-5 rounded border ${t.done ? 'bg-green-500 border-green-500 text-black' : 'border-gray-500 text-transparent'} flex items-center justify-center transition flex-shrink-0">
                        <i class="fa-solid fa-check text-xs"></i>
                    </button>
                    
                    <span ${clickAction} ${tooltip} class="text-sm ${t.done ? 'text-gray-500 line-through' : 'text-white'} flex-grow font-medium truncate ${cursorClass}">
                        ${t.text}
                    </span>
                    
                    <button onclick="deleteTodo(${t.id})" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition flex-shrink-0">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                </div>
            `;
            }).join('');
            
            if(userTodos.length === 0) list.innerHTML = '<div class="text-center text-gray-600 text-xs mt-10 italic">Sélectionnez vos priorités.</div>';
        }

        // --- MAIN APP LOGIC ---
        function buildCourses() {
            courses = rawItems.map(item => {
                const attached = userResources.filter(r => r.itemId === item.id);
                const status = userStatus[item.id] || null;
                const vues = userVues[item.id] || 0; 
                return { id: item.id, item: item.id, title: item.t, matiere: item.m, videoLink: attached.find(r => r.type === 'video')?.link, audioLink: attached.find(r => r.type === 'audio')?.link, flashLink: attached.find(r => r.type === 'flash')?.link, ficheLink: attached.find(r => r.type === 'fiche')?.link, status: status, vues: vues };
            });
        }
        
	function incrementVues(itemId) {
    // 1. Incrémentation
    userVues[itemId] = (userVues[itemId] || 0) + 1;
    
    addXP(15, 'Révision ajoutée'); 
    let needsFullRender = false;
    let message = `Vue #${userVues[itemId]} enregistrée`;

    // 2. Passage automatique en "LU" (Dès la 1ère vue)
    if (userStatus[itemId] !== 'lu' && userStatus[itemId] !== 'maitrise') {
        userStatus[itemId] = 'lu';
        addXP(50, 'Nouveau cours Lu');
        needsFullRender = true;
        message = "Marqué comme LU + Vue ajoutée";
    }

    // --- MODIFICATION ICI : SEUIL DE MAÎTRISE À 6 ---
    const MAX_VUES_FOR_MAITRISE = 6; 
    
    // Si on atteint exactement 6 vues (et qu'on n'était pas déjà maîtrisé)
    if (userVues[itemId] === MAX_VUES_FOR_MAITRISE && userStatus[itemId] !== 'maitrise') {
        userStatus[itemId] = 'maitrise';
        addXP(200, 'Maîtrise (6 vues)');
        showCelebration(); // Animation Or
        needsFullRender = true;
        message = `Item ${itemId} MAÎTRISÉ !`;
    }
    // ------------------------------------------------

    // Passage en LÉGENDAIRE (Toujours à 10 vues)
    if (userVues[itemId] === 10) {
        addXP(1000, 'EXPERTISE LÉGENDAIRE');
        showLegendaryCelebration(); // Animation Violette
        needsFullRender = true;
        message = `Item ${itemId} : NIVEAU MAX ATTEINT !`;
    }

    // 5. Sauvegarde
    saveData();
    trackHistory(itemId); // Ajout au calendrier

    // 6. Mise à jour visuelle
    if (needsFullRender) {
        buildCourses(); 
        render();       
    } else {
        const vuesContainer = document.getElementById(`vues-container-${itemId}`);
        if(vuesContainer) {
            // On remplace le HTML pour éviter les bugs d'affichage
            vuesContainer.outerHTML = getVuesBarHTML(userVues[itemId], itemId);
        }
    }

    playSound('click');
    showToast(message, needsFullRender ? 'success' : 'info');
}

        function resetVues(itemId) {
    // 1. Reset des compteurs
    userVues[itemId] = 0;
    
    // 2. Reset du statut (Retour à la case départ)
    userStatus[itemId] = null; 

    // 3. Sauvegarde
    saveData();

    // 4. Mise à jour visuelle COMPLÈTE
    // On doit recharger la grille car la COULEUR de la carte doit changer (Gris)
    // On ne peut pas se contenter de mettre à jour les barres ici.
    buildCourses();
    render();

    // 5. Feedback
    playSound('click');
    showToast('Compteur et statut réinitialisés.', 'info');
}

function updateStats() {
            const total = rawItems.length;
            const totalLu = Object.values(userStatus).filter(s => s === 'lu' || s === 'maitrise').length;
            const totalMaitrise = Object.values(userStatus).filter(s => s === 'maitrise').length;
            
            // Mise à jour des cercles
            const pctLu = Math.round((totalLu / total) * 100);
            const pctMaitrise = Math.round((totalMaitrise / total) * 100);
            
            document.getElementById('countLu').innerText = totalLu; 
            document.getElementById('pctLu').innerText = pctLu + '%'; 
            document.getElementById('ringLu').setAttribute('stroke-dasharray', `${pctLu}, 100`);
            
            document.getElementById('countMaitrise').innerText = totalMaitrise; 
            document.getElementById('pctMaitrise').innerText = pctMaitrise + '%'; 
            document.getElementById('ringMaitrise').setAttribute('stroke-dasharray', `${pctMaitrise}, 100`);
            
            // Calcul par matière
            const subjects = {};
            rawItems.forEach(i => { 
                if(!subjects[i.m]) subjects[i.m] = { total: 0, done: 0 }; 
                subjects[i.m].total++; 
                if(userStatus[i.id] === 'maitrise') subjects[i.m].done++; 
            });
            
            const sortedSubjects = Object.entries(subjects)
                .map(([name, stats]) => { return { name, pct: Math.round((stats.done / stats.total) * 100), ...stats }; })
                .sort((a, b) => b.pct - a.pct);
            
            // --- GÉNÉRATION DES CARTES AVEC GLOW ---
            document.getElementById('subjectProgressContainer').innerHTML = sortedSubjects.map(s => {
                const style = matiereConfig[s.name] || defaultConfig;
                
                // 1. On récupère le code RGB de la matière (ex: "239, 68, 68" pour Rouge)
                const rgb = getMatiereColorValue(style.color);
                
                // 2. On crée une ombre portée (glow) dynamique
                // On retire les espaces dans le RGB pour que la classe Tailwind fonctionne bien
                const glowClass = `hover:shadow-[0_0_20px_rgba(${rgb.replace(/ /g, '')},0.4)]`;
                const borderClass = `hover:border-${style.color}-500/50`;

                return `
                <div onclick="playSound('subjectClick'); filterByMatiere('${s.name}')" class="min-w-[140px] bg-[#111] border border-white/5 rounded-xl p-3 cursor-pointer transition-all duration-300 group ${glowClass} ${borderClass} hover:-translate-y-1">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fa-solid ${style.icon} text-${style.color}-400"></i>
                        <span class="text-xs font-bold text-white">${s.pct}%</span>
                    </div>
                    <p class="text-[10px] font-bold uppercase text-gray-400 truncate mb-1 group-hover:text-white transition">${s.name}</p>
                    <div class="w-full h-1 bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full bg-${style.color}-500" style="width: ${s.pct}%"></div>
                    </div>
                </div>`;
            }).join('');

            renderSuggestions();
        }
        
        // --- SUGGESTIONS LOGIC ---
        function getTodayKey() {
            return new Date().toISOString().slice(0, 10);
        }

        function saveDailySuggestionState() {
    saveData();
}

        function generateNewSuggestions() {
    const todoCourses = courses.filter(c => !userStatus[c.id]);
    const newSuggestions = [];
    const suggestionsCount = Math.min(6, todoCourses.length);
    
    // (Logique de sélection aléatoire inchangée...)
    const usedIndices = new Set();
    for (let i = 0; i < suggestionsCount; i++) {
        let randomIndex;
        do {
            randomIndex = Math.floor(Math.random() * todoCourses.length);
        } while (usedIndices.has(randomIndex));
        usedIndices.add(randomIndex);
        const item = todoCourses[randomIndex];
        const config = matiereConfig[item.matiere] || defaultConfig;
        newSuggestions.push({
            id: item.id,
            title: item.title,
            matiere: item.matiere, 
            theme: item.matiere || "Général",
            icon: config.icon
        });
    }

    currentSuggestions = newSuggestions;
    dailySuggestionsDone = {}; // Reset des validations
    currentSuggestions.forEach(s => { dailySuggestionsDone[s.id] = false; });
    
    saveData(); // Sauvegarde Cloud immédiate
    
    showToast(`Nouvelles suggestions générées.`, 'info');
}

        // --- UPDATED SUGGESTION HTML GENERATION ---
        function getSuggestionCardHTML(c) {
            const courseInfo = courses.find(item => item.id === c.id);
            if (!courseInfo) return '';
            const isDone = dailySuggestionsDone[c.id];

            const searchAction = `playSound('whoosh'); filterByMatiere('${courseInfo.matiere}'); document.getElementById('searchInput').value = '${c.id}'; render(); window.scrollTo({top: document.getElementById('filterBar').offsetTop - 100, behavior: 'smooth'});`;
            
            return `
                <div class="bg-black/20 border border-white/5 hover:border-orange-500/30 backdrop-blur-sm rounded-2xl p-4 cursor-pointer transition-all duration-300 group flex flex-col justify-between h-full suggestion-card hover:-translate-y-1 hover:bg-black/30 ${isDone ? 'done' : ''}" data-item-id="${c.id}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-white/5 flex items-center justify-center">
                                <i class="fa-solid ${c.icon} text-orange-400 text-[10px]"></i>
                            </div>
                            <span class="text-[10px] font-bold text-gray-400 uppercase truncate max-w-[100px]">${c.theme}</span>
                        </div>
                    </div>
                    
                    <div onclick="${searchAction}" class="flex-grow mb-4">
                        <p class="text-sm text-white font-bold leading-snug line-clamp-2 group-hover:text-orange-400 transition-colors">${courseInfo.title}</p>
                        <div class="mt-2 text-[10px] text-gray-500 font-mono border border-white/5 inline-block px-1.5 py-0.5 rounded">ITEM ${c.id}</div>
                    </div>

                    <div class="mt-auto pt-3 border-t border-white/5 flex justify-between items-center">
                        <button onclick="toggleSuggestionDone('${c.id}')" class="w-full py-2 rounded-xl border flex items-center justify-center gap-2 transition-all duration-300 ${isDone ? 'bg-green-500 border-green-500 text-black font-bold shadow-[0_0_15px_rgba(34,197,94,0.4)]' : 'border-white/10 bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white'}">
                            <i class="fa-solid ${isDone ? 'fa-check-circle' : 'fa-circle'} text-sm"></i>
                            <span class="text-xs font-bold uppercase tracking-wide">${isDone ? 'Fait' : 'Valider'}</span>
                        </button>
                    </div>
                </div>
            `;
        }

function toggleSuggestionDone(itemId) {
    // 1. Vérification si déjà fait
    if (dailySuggestionsDone[itemId]) {
        showToast("Suggestion déjà validée pour aujourd'hui.", 'info'); 
        playSound('click'); 
        return; 
    }

    // 2. Vérification des ressources manquantes
    const attached = userResources.filter(r => r.itemId === itemId);
    const viewedTypes = sessionViewedResources[itemId] || [];
    const requiredTypes = ['video', 'audio', 'flash', 'fiche'];
    const missingTypes = [];

    requiredTypes.forEach(type => {
        if (attached.some(r => r.type === type) && !viewedTypes.includes(type)) {
            missingTypes.push(type);
        }
    });

    if (missingTypes.length > 0) {
        const labels = { video: 'la Vidéo', audio: 'l\'Audio', flash: 'le Flash', fiche: 'la Fiche' };
        const missingNames = missingTypes.map(t => labels[t]).join(', ');
        dinoSpeak(`Pas si vite ! Tu dois d'abord consulter : ${missingNames}.`, 'error');
        
        const card = document.querySelector(`.suggestion-card[data-item-id="${itemId}"]`);
        if(card) {
            card.classList.add('validation-error', 'animate-shake');
            setTimeout(() => card.classList.remove('validation-error', 'animate-shake'), 1000);
        }
        return; 
    }

    // 3. SUCCÈS (Validation)
    dailySuggestionsDone[itemId] = true;
    
    // --- LOGIQUE INTELLIGENTE : STATUT & VUES ---
    
    if (!userStatus[itemId]) {
        // CAS A : Jamais Lu -> On initialise
        userStatus[itemId] = 'lu';
        userVues[itemId] = 1; // 1ère vue
        addXP(50, 'Statut Lu activé'); 
    } else {
        // CAS B : Déjà Lu -> On ajoute un point de lecture
        userVues[itemId] = (userVues[itemId] || 0) + 1;
        
        // Vérification des paliers (Exactement comme le bouton +)
        if (userVues[itemId] === 6 && userStatus[itemId] !== 'maitrise') {
            userStatus[itemId] = 'maitrise';
            addXP(200, 'Maîtrise atteinte (6 vues) !');
            showCelebration(); // Animation Or
        }
        if (userVues[itemId] === 10) {
            addXP(1000, 'EXPERTISE LÉGENDAIRE (10 vues) !');
            showLegendaryCelebration(); // Animation Violette
        }
    }
    // --------------------------------------------------

    addXP(30, 'Suggestion validée');
    playSound('success'); 
    
    // 4. Sauvegardes et Mises à jour
    saveData(); 
    
    renderSuggestions(false); // Met à jour les cartes de suggestion
    
    // Met à jour le tableau de bord global (pour voir les nouvelles vues/statuts)
    buildCourses();
    render();
    updateStats();
    
    // 5. Vérification Exceptionnel
    if (dailySuggestionsDone[itemId]) {
        checkAllSuggestionsDone();
    }
}

function checkAllSuggestionsDone() {
    if (currentSuggestions.length > 0 && currentSuggestions.every(s => dailySuggestionsDone[s.id])) {
    setTimeout(() => {
        addXP(500, 'Exceptionnel !'); // BONUS MASSIF
        
        // NOUVEL APPEL : Utilise le type 'GRAND_CHELEM'
        showCelebration('GRAND_CHELEM'); 
        
        tryUnlockNewAvatar(); 
    }, 500); 
}
}
        function showUnlockToast(icon) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            // Design doré/spécial pour le déblocage
            toast.className = `toast border-l-4 border-gold-500 flex items-center gap-4`;
            toast.style.background = "linear-gradient(135deg, rgba(20,20,20,0.95), rgba(50,40,10,0.9))";
            
            toast.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-gold-500/20 flex items-center justify-center border border-gold-500 text-gold-400">
                    <i class="fa-solid ${icon} text-lg animate-bounce"></i>
                </div>
                <div>
                    <h4 class="text-gold-400 font-bold text-xs uppercase tracking-wide">Nouvel Avatar !</h4>
                    <span class="text-white text-sm">Vérifiez votre profil.</span>
                </div>
            `;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toastSlide 0.3s ease-in reverse forwards';
                setTimeout(() => toast.remove(), 300);
            }, 5000); // Reste affiché plus longtemps (5s)
        }      

function showCelebrationSuggestions() {
    const overlay = document.getElementById('celebrationOverlay');
    const celebrationContent = document.getElementById('celebrationContent');
    
    // Réinitialisation des classes pour relancer l'anim si besoin
    overlay.classList.add('hidden');
    overlay.classList.remove('opacity-100');
    overlay.classList.add('opacity-0');
    celebrationContent.classList.add('scale-0');

    // Mise à jour du texte
    document.querySelector('#celebrationOverlay h2').innerText = 'VICTOIRE !';
    document.querySelector('#celebrationOverlay span').innerText = 'Suggestions du jour complétées';
    
    // Gestion des icônes (Affiche le trophée, cache les autres)
    document.getElementById('iconCrown').classList.add('hidden'); 
    document.getElementById('iconDragon').classList.add('hidden'); 
    document.getElementById('iconTrophy').classList.remove('hidden'); 

    // Force le redessin du navigateur (Reflow)
    void overlay.offsetWidth;

    // Affichage
    overlay.classList.remove('hidden');
    
		playSound('refresh');

    requestAnimationFrame(() => {
            overlay.classList.remove('opacity-0');
            overlay.classList.add('active'); 
            celebrationContent.classList.remove('scale-0');
    });
    
    // Masquage automatique après 3.5 secondes
    setTimeout(() => {
        overlay.classList.remove('active');
        overlay.classList.add('opacity-0');
        celebrationContent.classList.add('scale-0');
        setTimeout(() => overlay.classList.add('hidden'), 500);
    }, 3500);
}

        function renderSuggestions(forceRefresh = false) {
    const container = document.getElementById('suggestionList');
    const block = document.getElementById('suggestionBlock');

    // 1. LOGIQUE DE GÉNÉRATION
    // On ne génère de nouvelles suggestions QUE si :
    // - L'utilisateur a cliqué sur le bouton "Rafraîchir" (forceRefresh = true)
    // - OU la liste actuelle est vide (ex: premier lancement d'un nouveau compte)
    if (forceRefresh) {
        generateNewSuggestions();
        playSound('refresh'); 
    } else if (currentSuggestions.length === 0) {
        generateNewSuggestions();
    }
    
    // 2. LOGIQUE D'AFFICHAGE
    if (currentSuggestions.length > 0) {
        // On affiche les cartes
        container.innerHTML = currentSuggestions.map(getSuggestionCardHTML).join('');
        block.classList.remove('hidden');
    } else {
        // Cas particulier : Plus rien à suggérer ou tout est fini
        if (courses.filter(c => !userStatus[c.id]).length === 0) {
            // Tout le programme est fini !
            block.classList.add('hidden');
            container.innerHTML = `<div class="col-span-full text-center py-6 text-green-500 font-bold">Bravo ! Tous les items sont soit "Lu" soit "Maîtrisé".</div>`;
        } else {
            // Erreur ou liste vide temporaire
            container.innerHTML = `<div class="col-span-full text-center py-6 text-gray-500">Aucune suggestion disponible pour le moment. Essayez de <span class="font-bold cursor-pointer hover:text-white transition" onclick="renderSuggestions(true)">Rafraîchir</span>.</div>`;
            block.classList.remove('hidden');
        }
    }
}

        // --- UPDATED VUES COUNTER ---
	function getVuesBarHTML(vues, itemId) {
    const maxVues = 10;
    const progress = Math.min(vues, maxVues);
    const isLegendary = vues >= 10; 

    const circles = Array(maxVues).fill(0).map((_, index) => {
        const isLit = index < progress;
        
        // --- MODIFICATION ICI : ZONE OR À PARTIR DU 6ÈME CERCLE ---
        // Index 0 à 4 (5 premiers cercles) = Vert
        // Index 5 à 9 (5 derniers cercles) = Or
        const isGoldZone = index >= 5; 
        // ----------------------------------------------------------

        let colorClass = 'bg-white/10 scale-75'; 

        if (isLit) {
            if (isLegendary) {
                colorClass = 'bg-fuchsia-500 shadow-[0_0_10px_rgba(217,70,239,0.9)] scale-110';
            } else if (isGoldZone) {
                colorClass = 'bg-yellow-400 shadow-[0_0_8px_rgba(250,204,21,0.9)] scale-100';
            } else {
                colorClass = 'bg-green-500 shadow-[0_0_6px_rgba(34,197,94,0.7)] scale-100';
            }
        }
        return `<div class="w-2 h-2 rounded-full transition-all duration-500 ${colorClass}"></div>`;
    }).join('');
    
    return `
        <div id="vues-container-${itemId}" class="w-full flex items-center gap-3">
            <div class="flex items-center gap-2 flex-shrink-0">
                
                <button onclick="incrementVues('${itemId}')" class="w-8 h-8 rounded-full border border-white/10 text-gray-500 hover:text-green-400 hover:border-green-500 hover:bg-green-500/10 hover:shadow-[0_0_15px_rgba(74,222,128,0.3)] flex items-center justify-center backdrop-blur-md transition-all duration-300 group/add" title="Ajouter une vue">
                    <i class="fa-solid fa-plus text-xs group-hover/add:scale-110 transition-transform"></i>
                </button>
                
                <button onclick="resetVues('${itemId}')" class="w-8 h-8 rounded-full border border-white/10 text-gray-500 hover:text-red-400 hover:border-red-500 hover:bg-red-500/10 hover:shadow-[0_0_15px_rgba(248,113,113,0.3)] flex items-center justify-center backdrop-blur-md transition-all duration-300 group/reset" title="Réinitialiser">
                    <i class="fa-solid fa-rotate-left text-xs group-hover/reset:-rotate-90 transition-transform"></i>
                </button>

            </div>
            <div class="flex flex-grow items-center justify-between h-5 ml-2 px-1 cursor-help" title="Progression : ${vues}/10">
                ${circles}
            </div>
        </div>
    `;
}

        function getCardHTML(c) {
    const style = matiereConfig[c.matiere] || defaultConfig;
    
    // Gestion des classes de la carte (Bordure/Fond)
    let statusClass = '';
    if (c.vues >= 10) statusClass = 'status-legendaire';
    else if (c.status === 'maitrise') statusClass = 'status-maitrise';
    else if (c.status === 'lu') statusClass = 'status-lu';

    const isMaitrise = c.status === 'maitrise';
    const isLu = c.status === 'lu' || isMaitrise;
    
    // Vérifier si l'item est DÉJÀ dans les objectifs
    const isInTodos = userTodos.some(t => t.linkedItemId === c.id && !t.done);
    const todoBtnClass = isInTodos 
        ? "text-blue-400 border-blue-500/50 bg-blue-500/10 shadow-[0_0_10px_rgba(59,130,246,0.3)]" 
        : "text-gray-500 border-white/5 hover:text-blue-400 hover:bg-blue-500/10 hover:border-blue-500/50";

    // Couleur du titre au survol
    let hoverTitleClass = 'group-hover:text-blue-400'; 
    if (c.vues >= 10) hoverTitleClass = 'group-hover:text-fuchsia-400 group-hover:drop-shadow-[0_0_8px_rgba(232,121,249,0.8)]'; 
    else if (c.status === 'maitrise') hoverTitleClass = 'group-hover:text-yellow-400 group-hover:drop-shadow-[0_0_8px_rgba(250,204,21,0.6)]';
    else if (c.status === 'lu') hoverTitleClass = 'group-hover:text-green-400 group-hover:drop-shadow-[0_0_8px_rgba(74,222,128,0.6)]';

    // --- NOUVEAU DESIGN DES BOUTONS MÉDIAS ---
    const btn = (link, type, icon, color) => {
        if (link) {
            // RESSOURCE DISPO : Bouton coloré avec lueur interne
            const activeIcon = type === 'video' ? 'fa-play' : 
                             type === 'audio' ? 'fa-music' : 
                             type === 'flash' ? 'fa-bolt' : 'fa-eye';

            return `<div class="relative group/btn">
                <button onclick="trackResourceView('${c.id}', '${type}'); openPlayer('${link}', '${type}', '${c.title.replace(/'/g, "&apos;")}')" 
                        class="w-10 h-10 rounded-xl border flex items-center justify-center transition-all duration-300 transform hover:scale-110 active:scale-95 text-${color}-400 border-${color}-500/30 bg-${color}-500/10 hover:bg-${color}-500/20 hover:shadow-[0_0_15px_rgba(var(--color-${color}-500),0.4)] backdrop-blur-md" 
                        title="Lire ${type}">
                    <i class="fa-solid ${activeIcon} text-sm filter drop-shadow-[0_0_3px_rgba(0,0,0,0.5)]"></i>
                </button>
                <button onclick="removeResource('${c.id}', '${type}')" class="absolute -top-1.5 -right-1.5 w-4 h-4 bg-red-500 text-white rounded-full text-[8px] flex items-center justify-center opacity-0 group-hover/btn:opacity-100 transition-all hover:scale-125 shadow-md cursor-pointer z-10">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>`;
        } else {
            // PAS DE RESSOURCE : Bouton fantôme discret
            return `<button onclick="openModalForItem('${c.id}', '${type}')" 
                            class="w-10 h-10 rounded-xl border border-white/5 bg-white/[0.02] text-gray-700 hover:text-gray-400 hover:border-white/10 hover:bg-white/5 flex items-center justify-center transition-all duration-300 group/empty" 
                            title="Ajouter ${type}">
                <i class="fa-solid ${icon} text-xs opacity-30 group-hover/empty:opacity-100 transition-opacity"></i>
            </button>`;
        }
    }
    
    const tutorBtn = `<button onclick="startRevisionChat('${c.id}', '${c.title.replace(/'/g, "&apos;")}')" class="w-8 h-8 rounded-full border border-indigo-500/30 bg-indigo-500/5 text-indigo-400/70 hover:text-white hover:bg-indigo-500/40 flex items-center justify-center transition-all hover:scale-110 hover:shadow-[0_0_15px_rgba(99,102,241,0.3)]" title="Tuteur IA">
        <i class="fa-solid fa-microchip text-[10px]"></i>
    </button>`;

    const titleContent = `<span>${c.title}</span>`;

    return `
        <div onclick="if(!event.target.closest('button')) openItemDetail('${c.id}')" 
             class="card-cinema rounded-2xl flex flex-col ${statusClass} h-full relative group overflow-hidden cursor-pointer hover:border-white/20 transition-all duration-500 hover:shadow-2xl">
            
            <div class="absolute top-3 left-3 z-20 flex items-center gap-2">
                <div onclick="event.stopPropagation(); jumpToMatiere('${c.matiere}')" 
                     class="w-8 h-8 rounded-full bg-${style.color}-500/10 flex items-center justify-center border border-${style.color}-500/20 shadow-lg cursor-pointer hover:scale-110 hover:bg-${style.color}-500/30 transition-all duration-300 group/icon backdrop-blur-sm"
                     title="Filtrer : ${c.matiere}">
                    <i class="fa-solid ${style.icon} text-${style.color}-400 text-xs group-hover/icon:text-white transition-colors"></i>
                </div>
                <span class="text-[9px] font-black bg-black/40 border border-white/5 px-2 py-1 rounded-full text-gray-300 backdrop-blur-md">ITEM ${c.item}</span>
            </div>
            
            <div class="absolute top-3 right-3 z-20 flex gap-1.5">
                <button onclick="event.stopPropagation(); toggleTodoFromCard('${c.id}', '${c.title.replace(/'/g, "&apos;")}')" 
            class="w-8 h-8 rounded-full border ${todoBtnClass} flex items-center justify-center backdrop-blur-md transition-all duration-300 group/cal" 
            title="${isInTodos ? 'Retirer des objectifs' : 'Ajouter aux objectifs'}">
        
        <i class="fa-solid ${isInTodos ? 'fa-calendar-minus' : 'fa-calendar-plus'} text-xs group-hover/cal:scale-110 transition-transform"></i>
    
    </button>

                <button onclick="event.stopPropagation(); toggleStatus('${c.id}', 'lu')" 
                        class="w-8 h-8 rounded-full border flex items-center justify-center backdrop-blur-md transition-all duration-300 ${
                            c.status === 'lu' ? 'bg-green-500 border-green-500 text-black shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 
                            'border-white/10 bg-black/20 text-gray-600 hover:text-green-400 hover:border-green-500/50'
                        }" 
                        title="Marquer comme Lu">
                    <i class="fa-solid fa-check text-xs"></i>
                </button>
		
		<button onclick="event.stopPropagation(); toggleStatus('${c.id}', 'maitrise')" 
                        class="w-8 h-8 rounded-full border flex items-center justify-center backdrop-blur-md transition-all duration-300 ${
                            c.status === 'maitrise' ? 'bg-yellow-500 border-yellow-500 text-black shadow-[0_0_10px_rgba(234,179,8,0.5)]' : 
                            'border-white/10 bg-black/20 text-gray-600 hover:text-yellow-400 hover:border-yellow-500/50'
                        }" 
                        title="Marquer comme Maîtrisé">
                    <i class="fa-solid fa-trophy text-xs"></i>
                </button>


            </div>


            <div class="p-5 z-10 flex-grow pt-14 flex flex-col">
                
                <div class="mb-3 pr-2 min-h-[3.5rem] flex items-start">
                    <h3 class="text-gray-200 font-bold text-lg leading-tight line-clamp-2 ${hoverTitleClass} transition-all duration-300 tracking-tight">${titleContent}</h3>
                </div>
                
                <div class="mt-auto my-4">
                    <div class="bg-white/[0.02] border border-white/5 rounded-2xl py-2 px-3 flex justify-between items-center backdrop-blur-sm hover:bg-white/[0.04] hover:border-white/10 transition-all duration-500 group/deck shadow-inner">
                        ${btn(c.videoLink, 'video', 'fa-video', 'red')}
                        <div class="w-px h-4 bg-white/5"></div>
                        ${btn(c.audioLink, 'audio', 'fa-headphones', 'yellow')}
                        <div class="w-px h-4 bg-white/5"></div>
                        ${btn(c.flashLink, 'flash', 'fa-bolt', 'purple')}
                        <div class="w-px h-4 bg-white/5"></div>
                        ${btn(c.ficheLink, 'fiche', 'fa-file-pdf', 'blue')}
                    </div>
                </div>

                <div class="flex items-end justify-between gap-3 pt-2 border-t border-white/5">
                    <div class="flex-grow">
                        ${getVuesBarHTML(c.vues, c.id)}
                    </div>
                    <div class="pl-2 border-l border-white/5">
                        ${tutorBtn}
                    </div>
                </div>
            </div>
        </div>`;
}
        
function render() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const matiere = document.getElementById('matiereFilter').value;
            const status = currentStatusFilter; 
            
            const header = document.getElementById('subjectHeader');
            const container = document.getElementById('subjectIconContainer');
            const icon = document.getElementById('subjectIcon');
            const title = document.getElementById('subjectTitle');
            
            // Toujours afficher le header maintenant
            header.classList.remove('hidden');

            // --- GESTION DU HEADER ---
            if(matiere !== 'all') {
                // CAS 1 : UNE MATIÈRE EST SÉLECTIONNÉE
                const style = matiereConfig[matiere] || defaultConfig;
                
                title.innerText = matiere;
                
                // Récupération couleur RGB
                const rgb = getMatiereColorValue(style.color);
                
                // Lueur colorée intense
                container.style.boxShadow = `0 0 40px -10px rgba(${rgb}, 0.5), inset 0 0 20px rgba(${rgb}, 0.2)`;
                container.style.borderColor = `rgba(${rgb}, 0.5)`;
                container.style.backgroundColor = `rgba(${rgb}, 0.1)`; 

                // Icône colorée
                icon.className = `fa-solid ${style.icon} text-3xl text-${style.color}-400 drop-shadow-[0_0_15px_rgba(${rgb},0.8)]`;

            } else { 
                // CAS 2 : VUE GÉNÉRALE (TOUS LES ITEMS)
                title.innerText = "Programme R2C";
                
                // Lueur blanche/grise neutre et élégante
                container.style.boxShadow = `0 0 40px -10px rgba(255, 255, 255, 0.1), inset 0 0 20px rgba(255, 255, 255, 0.05)`;
                container.style.borderColor = `rgba(255, 255, 255, 0.1)`;
                container.style.backgroundColor = `rgba(255, 255, 255, 0.02)`;

                // Icône livre générique
                icon.className = `fa-solid fa-book-medical text-3xl animate-spectral`;
            }
            // ------------------------------------------------

            const filtered = courses.filter(c => {
                const matchS = c.title.toLowerCase().includes(search) || c.item.toString().includes(search);
                const matchM = matiere === 'all' || c.matiere === matiere;
                
                let matchSt = true;
                if(status === 'lu') matchSt = c.status === 'lu' || c.status === 'maitrise';
                else if(status === 'maitrise') matchSt = c.status === 'maitrise';
                else if(status === 'todo') matchSt = !c.status;

                return matchS && matchM && matchSt;
            });

            document.getElementById('coursesGrid').innerHTML = filtered.map(getCardHTML).join('');
            if(filtered.length === 0) document.getElementById('emptyState').classList.remove('hidden');
            else document.getElementById('emptyState').classList.add('hidden');
        }

        // --- UTILS ---
// --- GESTION MUSIQUE D'AMBIANCE ---

// 1. Initialisation
function initMusicPlayer() {
    audioSystem.mainAudio.volume = audioSystem.musicVolume;
    audioSystem.mainAudio.addEventListener('ended', playNextTrackStandard);

    [audioSystem.layer1, audioSystem.layer2, audioSystem.layer3].forEach(layer => {
        layer.volume = audioSystem.musicVolume;
        layer.addEventListener('ended', handleLayerEnded);
    });
    
    // Note: On ne charge plus de thème par défaut ici pour permettre l'aléatoire au premier clic
}

// 2. Gestionnaire de fin de piste
function handleLayerEnded() {
    audioSystem.layersFinished++;
    if (audioSystem.layersFinished >= audioSystem.activeLayersCount) {
        if (audioSystem.currentTheme === 'theme2') playRandomLayeredTheme2();
        else if (audioSystem.currentTheme === 'theme3') playDramaLogic();
    }
}

// 3. Charger un thème
function loadTheme(themeName) {
    stopAllMusic();
    audioSystem.currentTheme = themeName;
    audioSystem.playlist = audioSystem.themes[themeName];
    
    updateThemeVisuals(); // Met à jour l'icône active

    if (audioSystem.isPlaying) {
        startMusicLogic();
    }
}

// 4. Mise à jour visuelle des boutons de thème
function updateThemeVisuals() {
    const themes = ['theme1', 'theme2', 'theme3', 'theme4'];
    
    themes.forEach(t => {
        const btn = document.getElementById('btn-' + t);
        if(btn) {
            if (t === audioSystem.currentTheme) {
                // Thème Actif : Pulsation + Bordure blanche marquée
                btn.classList.add('animate-pulse', 'ring-2', 'ring-white/50', 'scale-110');
                btn.style.opacity = "1";
            } else {
                // Thème Inactif : Reset
                btn.classList.remove('animate-pulse', 'ring-2', 'ring-white/50', 'scale-110');
                btn.style.opacity = "0.7";
            }
        }
    });
}

// 5. Démarrer la logique
function startMusicLogic() {
    audioSystem.isPlaying = true;
    const theme = audioSystem.currentTheme;
    
    if (theme === 'theme1' || theme === 'theme4') playTrackStandard(0);
    else if (theme === 'theme2') playRandomLayeredTheme2();
    else if (theme === 'theme3') playDramaLogic();
    
    updateMusicUI();
}

// 6. Logique Standard (Thèmes 1 et 4)
let currentStandardIndex = 0;
function playTrackStandard(index) {
    if (index >= audioSystem.playlist.length) index = 0;
    currentStandardIndex = index;
    audioSystem.mainAudio.src = audioSystem.playlist[index];
    audioSystem.mainAudio.play().catch(e => {});
}
function playNextTrackStandard() { playTrackStandard(currentStandardIndex + 1); }

// 7. Logique Thème 2 (Épique)
function playRandomLayeredTheme2() {
    const list = audioSystem.playlist;
    audioSystem.layersFinished = 0;
    audioSystem.activeLayersCount = 2; 
    let idx1 = Math.floor(Math.random() * list.length);
    let idx2 = idx1;
    while (idx2 === idx1) idx2 = Math.floor(Math.random() * list.length);
    audioSystem.layer1.src = list[idx1];
    audioSystem.layer2.src = list[idx2];
    audioSystem.layer3.src = ""; 
    audioSystem.layer1.play().catch(e => {});
    setTimeout(() => { audioSystem.layer2.play().catch(e => {}); }, 500);
}

// 8. Logique Thème 3 (Drama)
function playDramaLogic() {
    const melodies = audioSystem.playlist;
    audioSystem.layersFinished = 0;
    const randomMelodyIndex = Math.floor(Math.random() * melodies.length);
    const selectedMelody = melodies[randomMelodyIndex];
    const types = ['ST', 'BP', 'UT'];
    for (let i = types.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [types[i], types[j]] = [types[j], types[i]];
    }
    const rand = Math.random();
    let countToPlay = 3;
    if (rand < 0.33) countToPlay = 1;
    else if (rand < 0.66) countToPlay = 2;
    audioSystem.activeLayersCount = countToPlay;
    audioSystem.layer1.src = ""; audioSystem.layer2.src = ""; audioSystem.layer3.src = "";
    if (countToPlay >= 1) audioSystem.layer1.src = selectedMelody[types[0]];
    if (countToPlay >= 2) audioSystem.layer2.src = selectedMelody[types[1]];
    if (countToPlay >= 3) audioSystem.layer3.src = selectedMelody[types[2]];
    if (audioSystem.layer1.src) audioSystem.layer1.play().catch(e => {});
    if (audioSystem.layer2.src) audioSystem.layer2.play().catch(e => {});
    if (audioSystem.layer3.src) audioSystem.layer3.play().catch(e => {});
}

// 9. Stop Total
function stopAllMusic() {
    audioSystem.mainAudio.pause(); audioSystem.mainAudio.currentTime = 0;
    audioSystem.layer1.pause(); audioSystem.layer1.currentTime = 0;
    audioSystem.layer2.pause(); audioSystem.layer2.currentTime = 0;
    audioSystem.layer3.pause(); audioSystem.layer3.currentTime = 0;
}

// 10. Play / Pause global (MODIFIÉ POUR ALÉATOIRE)
function togglePlayPause() {
    if (audioSystem.isPlaying) {
        // PAUSE
        if (audioSystem.currentTheme === 'theme1' || audioSystem.currentTheme === 'theme4') audioSystem.mainAudio.pause();
        else { audioSystem.layer1.pause(); audioSystem.layer2.pause(); audioSystem.layer3.pause(); }
        audioSystem.isPlaying = false;
        showToast("Musique en pause", "info");
    } else {
        // PLAY
        
        // --- CHOIX ALÉATOIRE AU PREMIER LANCEMENT ---
        if (!audioSystem.currentTheme) {
            const keys = Object.keys(audioSystem.themes);
            const randTheme = keys[Math.floor(Math.random() * keys.length)];
            
            // On définit manuellement pour éviter l'appel récursif
            audioSystem.currentTheme = randTheme;
            audioSystem.playlist = audioSystem.themes[randTheme];
            
            // Petit message sympa
            const names = { 'theme1': 'Focus', 'theme2': 'Épique', 'theme3': 'Drama', 'theme4': 'Nature' };
            showToast(`Thème aléatoire : ${names[randTheme]}`, "success");
        }
        
        updateThemeVisuals(); // Illumine le bouton choisi

        // Logique de lancement standard
        const theme = audioSystem.currentTheme;
        if (theme === 'theme1' || theme === 'theme4') {
            if (!audioSystem.mainAudio.src) startMusicLogic();
            else audioSystem.mainAudio.play();
        } else {
            if (!audioSystem.layer1.src) startMusicLogic();
            else {
                if (audioSystem.layer1.src) audioSystem.layer1.play();
                if (audioSystem.layer2.src) audioSystem.layer2.play();
                if (audioSystem.layer3.src) audioSystem.layer3.play();
            }
        }
        audioSystem.isPlaying = true;
        showToast("Lecture en cours 🎵", "success");
    }
    updateMusicUI();
}

// 11. Changement de Thème
function setMusicTheme(themeName) {
    // Si c'est déjà ce thème qui joue, on ne fait rien pour éviter de couper
    if (audioSystem.currentTheme === themeName && audioSystem.isPlaying) {
        showToast("Ce thème joue déjà.", "info");
        return;
    }

    // 1. Charger la configuration du thème
    loadTheme(themeName);
    
    // 2. --- MODIFICATION ICI : FORCER LE DÉMARRAGE ---
    // On ignore l'état précédent (pause/play), on lance la musique direct
    startMusicLogic();
    audioSystem.isPlaying = true;
    
    // 3. Feedback Visuel
    const names = { 'theme1': 'Focus', 'theme2': 'Épique', 'theme3': 'Drama', 'theme4': 'Nature' };
    showToast(`Lecture : ${names[themeName]} 🎵`, "success");
    updateMusicUI();
}

// 12. UI (Menu)
function toggleMusicMenu() {
    const menu = document.getElementById('musicMenuOptions');
    const mainBtn = document.getElementById('mainMusicBtn');
    const mainIcon = document.getElementById('mainMusicIcon');
    const viz = document.getElementById('musicVisualizer');

    const isOpen = !menu.classList.contains('pointer-events-none');

    if (isOpen) {
        menu.classList.add('opacity-0', 'translate-x-10', 'pointer-events-none', 'scale-95');
        mainIcon.classList.replace('fa-xmark', 'fa-music');
        mainBtn.classList.remove('border-purple-500', 'shadow-[0_0_20px_rgba(168,85,247,0.4)]');
        if (audioSystem.isPlaying) {
            mainIcon.classList.add('hidden');
            viz.classList.remove('hidden');
            viz.classList.add('flex');
        }
    } else {
        menu.classList.remove('opacity-0', 'translate-x-10', 'pointer-events-none', 'scale-95');
        viz.classList.add('hidden');
        viz.classList.remove('flex');
        mainIcon.classList.remove('hidden');
        mainIcon.classList.replace('fa-music', 'fa-xmark');
        mainBtn.classList.add('border-purple-500', 'shadow-[0_0_20px_rgba(168,85,247,0.4)]');
        playSound('click');
    }
}

function updateMusicUI() {
    const miniIcon = document.getElementById('miniPlayIcon');
    if (audioSystem.isPlaying) {
        miniIcon.classList.replace('fa-play', 'fa-pause');
    } else {
        miniIcon.classList.replace('fa-pause', 'fa-play');
    }
}

// Init
initMusicPlayer();

/**
 * Baisse le volume progressivement puis coupe le son
 * @param {HTMLAudioElement} audio - L'objet audio à couper
 * @param {number} fadeDuration - Durée du fondu en ms (ex: 3000 pour 3s)
 */
function fadeOutAndStop(audio, fadeDuration) {
    if (!audio || audio.paused) return;

    const originalVolume = audio.volume;
    const stepTime = 50; // Mise à jour toutes les 50ms
    const steps = fadeDuration / stepTime;
    const volumeStep = originalVolume / steps;

    const fadeInterval = setInterval(() => {
        // Protection : si le volume est suffisant, on baisse
        if (audio.volume > volumeStep) {
            audio.volume -= volumeStep;
        } else {
            // FIN : on coupe tout
            clearInterval(fadeInterval);
            audio.volume = 0;
            audio.pause();
            audio.currentTime = 0;
            
            // IMPORTANT : On remet le volume pour la prochaine utilisation
            audio.volume = originalVolume; 
        }
    }, stepTime);
}

// Lancer l'init au démarrage (sans jouer, car le navigateur bloque l'autoplay)
initMusicPlayer();

// --- LOGIQUE CARROUSEL IMMERSIF ---

// 1. Génération des cartes (Appelé au démarrage)
function initSubjectCarousel() {
    const track = document.getElementById('subjectCarouselTrack');
    const matieres = Object.keys(matiereConfig).sort();
    
    // 1. Carte "TOUT"
    // MODIFICATION ICI : Icône fa-book-medical (Programme R2C)
    let html = `
        <div onclick="selectMatiereFromCarousel('all')" class="flex-shrink-0 w-24 h-32 bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl flex flex-col items-center justify-center gap-3 cursor-pointer hover:bg-white/10 hover:scale-105 hover:border-white/30 transition-all duration-300 group shadow-lg">
            <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-white/20 transition">
                <i class="fa-solid fa-book-medical text-gray-400 group-hover:text-white text-lg"></i>
            </div>
            <span class="text-[9px] font-bold text-gray-400 uppercase tracking-wider text-center group-hover:text-white">Tout</span>
        </div>
    `;

    // 2. Les Matières
    html += matieres.map(m => {
        const conf = matiereConfig[m];
        return `
        <div onclick="selectMatiereFromCarousel('${m}')" class="flex-shrink-0 w-24 h-32 bg-white/5 backdrop-blur-xl border border-white/5 hover:border-${conf.color}-500/50 rounded-2xl flex flex-col items-center justify-center gap-2 cursor-pointer transition-all duration-300 hover:scale-110 hover:-translate-y-1 hover:shadow-[0_10px_30px_-10px_rgba(0,0,0,0.8)] group relative overflow-hidden">
            
            <div class="absolute inset-0 bg-gradient-to-b from-${conf.color}-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            
            <i class="fa-solid ${conf.icon} text-2xl text-${conf.color}-500/70 group-hover:text-${conf.color}-400 transition-all duration-300 relative z-10 group-hover:scale-110"></i>
            
            <span class="text-[8px] font-bold text-gray-400 group-hover:text-white text-center px-1 leading-tight uppercase tracking-wide relative z-10 transition-colors">
                ${m.replace('Médecine ', '').replace('Chirurgie ', '').substring(0, 12)}
            </span>
        </div>
        `;
    }).join('');

    track.innerHTML = html;
}

// 2. Basculer entre Vue Statique et Vue Carrousel
function toggleSubjectCarousel() {
        playSound('subjectClick');

    const staticView = document.getElementById('staticHeaderContent');
    const carouselContainer = document.getElementById('subjectCarouselContainer');
    const track = document.getElementById('subjectCarouselTrack');
    const backdrop = document.getElementById('carouselBackdrop');

    // Génération si vide
    if (track.children.length === 0) initSubjectCarousel();

    const isOpen = !carouselContainer.classList.contains('pointer-events-none');

    if (isOpen) {
        // FERMETURE
        carouselContainer.classList.add('opacity-0', 'pointer-events-none');
        staticView.classList.remove('opacity-0', 'pointer-events-none', 'scale-90');
        if(backdrop) backdrop.classList.add('opacity-0', 'pointer-events-none');
    } else {
        // OUVERTURE
        staticView.classList.add('opacity-0', 'pointer-events-none', 'scale-90');
        carouselContainer.classList.remove('opacity-0', 'pointer-events-none');
        if(backdrop) backdrop.classList.remove('opacity-0', 'pointer-events-none');
        
    }
}

// 3. Sélection et Fermeture
function selectMatiereFromCarousel(matiere) {
    toggleSubjectCarousel(); // Ferme le menu
    
    // Applique le filtre
    const select = document.getElementById('matiereFilter');
    select.value = matiere;
    handleFilterChange(select);
    
    handleFilterChange(select);
    playSound('subjectClick');
}

// Fonction pour fermer la fiche d'item et revenir à la vue globale
function closeItemDetailAndGoHome() {
    // On ferme la vue détaillée (ce qui révèle le dashboard)
    closeItemDetail(); 
    
    // On appelle la fonction de nettoyage et de rendu
    resetView();      
    
    playSound('subjectClick');
}

/* --- GESTION NOTES PLEIN ÉCRAN --- */
function saveDashboardNotes() {
    const preview = document.getElementById('quickNotesPreview');
    const content = preview.innerHTML;
    const placeholder = document.getElementById('emptyNotePlaceholder');

    // 1. Mise à jour de la variable globale
    userSubjectNotes[currentNotesMatiere] = content;

    // 2. Gestion du placeholder
    if (content.trim() === "" || content === "<br>") {
        if(placeholder) placeholder.classList.remove('hidden');
    } else {
        if(placeholder) placeholder.classList.add('hidden');
    }

    // 3. Sauvegarde Cloud (avec Debounce pour ne pas spammer)
    if (window.dashboardSaveTimeout) clearTimeout(window.dashboardSaveTimeout);
    
    window.dashboardSaveTimeout = setTimeout(() => {
        saveData();
        // Indicateur visuel discret
        const ind = document.getElementById('saveIndicator');
        if(ind) {
            ind.style.opacity = '1';
            setTimeout(() => ind.style.opacity = '0', 1000);
        }
    }, 1000); // Sauvegarde 1 seconde après la dernière frappe
}

function openFullScreenNotes() {
    const modal = document.getElementById('fullScreenNotesModal');
    const contentBox = document.getElementById('fullScreenNotesContent');
    const editor = document.getElementById('fullScreenEditor');
    const preview = document.getElementById('quickNotesPreview');

    // 1. Configurer le titre et l'icône selon la matière actuelle
    const config = getNotesMatiereConfig(currentNotesMatiere);
    document.getElementById('fsNoteTitle').innerText = config.name;
    
    // Icone et Couleur du header
    const iconEl = document.getElementById('fsNoteIcon');
    const iconBg = document.getElementById('fsNoteIconBg');
    iconEl.className = `fa-solid ${config.icon} text-xl text-${config.color}-400`;
    iconBg.className = `w-12 h-12 rounded-xl bg-${config.color}-500/10 border border-${config.color}-500/20 flex items-center justify-center`;

    // 2. Charger le contenu HTML complet
    // On récupère le contenu depuis la variable globale
    const savedContent = userSubjectNotes[currentNotesMatiere] || "";
    editor.innerHTML = savedContent;

    // 3. Afficher la modale
    modal.classList.remove('hidden');
    // Animation d'entrée
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        contentBox.classList.remove('scale-95');
        contentBox.classList.add('scale-100');
    }, 10);
    
    // Focus sur l'éditeur
    editor.focus();
    playSound('whoosh');
}

function closeFullScreenNotes() {
    playSound('whoosh');
    const modal = document.getElementById('fullScreenNotesModal');
    const contentBox = document.getElementById('fullScreenNotesContent');
    
    // Animation de sortie
    modal.classList.add('opacity-0');
    contentBox.classList.remove('scale-100');
    contentBox.classList.add('scale-95');
    
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);

    // Mise à jour de l'aperçu dans le dashboard
    updateDashboardPreview();
}

function saveFullScreenContent() {
    const content = document.getElementById('fullScreenEditor').innerHTML;
    
    // 1. Mise à jour variable globale
    userSubjectNotes[currentNotesMatiere] = content;
    
    // 2. Sauvegarde Cloud
    saveData();
    
    // 3. Indicateur visuel "Sauvegardé" dans la modale
    const ind = document.getElementById('fsSaveIndicator');
    ind.style.opacity = '1';
    // Debounce pour l'indicateur
    if(window.fsSaveTimeout) clearTimeout(window.fsSaveTimeout);
    window.fsSaveTimeout = setTimeout(() => ind.style.opacity = '0', 1000);
}

// Fonction de formatage (identique à celle des items, adaptée pour la modale)
function formatFullNote(command, value = null) {
    document.execCommand(command, false, value);
    document.getElementById('fullScreenEditor').focus();
    saveFullScreenContent(); // Sauvegarde immédiate après formatage
}

function updateDashboardPreview() {
    const preview = document.getElementById('quickNotesPreview');
    const placeholder = document.getElementById('emptyNotePlaceholder');
    
    if(!preview) return;

    const content = userSubjectNotes[currentNotesMatiere] || "";
    
    // Mise à jour du contenu
    preview.innerHTML = content;

    // Gestion du placeholder
    if (!content || content.trim() === "") {
        if(placeholder) placeholder.classList.remove('hidden');
    } else {
        if(placeholder) placeholder.classList.add('hidden');
    }
}

// --- JAUGE DE DIFFICULTÉ ---

// A. Helper pour mapper le niveau à un texte/couleur
function getDifficultyConfig(level) {
    const lvl = parseInt(level);
    // On retourne l'RGB pour le halo et la bordure
    if (lvl <= 1) return { label: "Très Facile", color: "#4ade80", class: "text-green-400", rgb: "74, 222, 128" }; 
    if (lvl === 2) return { label: "Facile", color: "#a3e635", class: "text-lime-400", rgb: "166, 209, 63" };      
    if (lvl === 3) return { label: "Normale", color: "#facc15", class: "text-yellow-400", rgb: "250, 204, 21" };    
    if (lvl === 4) return { label: "Difficile", color: "#fb923c", class: "text-orange-400", rgb: "251, 146, 60" };  
    return { label: "Extrême", color: "#ef4444", class: "text-red-500", rgb: "239, 68, 68" };                       
}

// B. Mise à jour de l'affichage (durant le drag)
function updateDifficultyDisplay(level) {
    const labelEl = document.getElementById('difficultyLevelLabel');
    const sliderEl = document.getElementById('difficultySlider');
    const containerEl = document.getElementById('difficultyGaugeContainer');
    const glowEl = document.getElementById('difficultyGlow');
    const config = getDifficultyConfig(level);
    
    // 1. Mise à jour du texte et du curseur
    if(labelEl) {
        labelEl.innerText = `${level} - ${config.label}`;
        labelEl.className = `text-xs font-bold font-mono transition-colors duration-300 ${config.class}`;
    }
    if(sliderEl) {
        sliderEl.style.setProperty('--thumb-color', config.color);
    }
    
    // 2. Application du style Glassmorphism Coloré
    if(containerEl) {
        // Bordure colorée (50% de la couleur dynamique)
        containerEl.style.borderColor = `rgba(${config.rgb}, 0.5)`; 
    }
    if(glowEl) {
        // Halo de fond coloré
        glowEl.style.backgroundColor = `rgba(${config.rgb}, 1)`; 
    }
}

// C. Fonction principale de sauvegarde
function setDifficulty(level) {
    const itemId = currentItemId; // On utilise l'ID de l'item actuellement ouvert
    const levelInt = parseInt(level);
    if(!itemId || levelInt < 1 || levelInt > 5) return;

    userItemDifficulty[itemId] = levelInt;
    saveData(); // Sauvegarde les données
    renderDifficultySelector(itemId); // Réinitialise l'affichage après sauvegarde
    playSound('click');
}

// D. Fonction de rendu du sélecteur (injecte le range input)
function renderDifficultySelector(itemId) {
    const currentLevel = userItemDifficulty[itemId] || 3; 
    const container = document.getElementById('difficultySelector');
    
    // On injecte le slider avec la classe CSS personnalisée "range-slider"
    if(!container.querySelector('input[type="range"]')) {
         container.innerHTML = `
            <input type="range" id="difficultySlider" min="1" max="5" step="1" value="${currentLevel}" 
                   oninput="updateDifficultyDisplay(this.value)" 
                   onchange="setDifficulty(this.value)"
                   class="range-slider">
        `;
    }

    // On force la mise à jour visuelle initiale (très important ici)
    updateDifficultyDisplay(currentLevel);
}

function dinoSpeak(message, type = 'info') {
    const bubble = document.getElementById('dinoSpeechBubble');
    const text = document.getElementById('dinoSpeechText');
    const title = bubble.querySelector('h4'); 
    const triangle = bubble.querySelector('div'); 
    const dinoIcon = document.getElementById('dinoIcon');

    // 1. Mettre le texte
    text.innerText = message;

    // 2. Changer le Style
    if (type === 'error') {
        // MODE ERREUR (Rouge)
        // CORRECTION ICI : 'mb-6' (Juste milieu)
        bubble.className = "absolute bottom-full mb-6 left-1/2 -translate-x-1/2 w-64 p-4 rounded-2xl bg-red-900/90 backdrop-blur-xl border border-red-500/50 shadow-[0_0_30px_-5px_rgba(239,68,68,0.4)] transition-all duration-300 z-30";
        
        triangle.className = "absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-red-900/90 backdrop-blur-xl border-r border-b border-red-500/50 rotate-45";
        title.className = "text-red-400 font-display font-black text-xs uppercase tracking-widest mb-1 drop-shadow-md flex items-center gap-2";
        title.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Attention !';
        
        dinoIcon.className = `fa-solid ${userAvatar} text-6xl text-red-500 transition-all duration-300 animate-shake`;
        playSound('error');
    } else {
        // MODE NORMAL (Bleu)
        // CORRECTION ICI : 'mb-6' (Juste milieu)
        bubble.className = "absolute bottom-full mb-6 left-1/2 -translate-x-1/2 w-64 p-4 rounded-2xl bg-slate-900/80 backdrop-blur-xl border border-cyan-500/30 shadow-[0_0_30px_-5px_rgba(6,182,212,0.2)] transition-all duration-300 z-30";
        
        triangle.className = "absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-slate-900/80 backdrop-blur-xl border-r border-b border-cyan-500/30 rotate-45";
        title.className = "text-cyan-400 font-display font-black text-xs uppercase tracking-widest mb-1 drop-shadow-md flex items-center gap-2";
        title.innerHTML = '<i class="fa-solid fa-star"></i> Magic creature';
        
        dinoIcon.className = `fa-solid ${userAvatar} text-6xl text-cyan-400 transition-all duration-300 dino-woke`;
    }

    // 3. Afficher
    bubble.classList.remove('hidden');
    setTimeout(() => {
        bubble.classList.remove('opacity-0', 'translate-y-2');
    }, 10);

    // 4. Cacher automatiquement
    if (window.dinoTimeout) clearTimeout(window.dinoTimeout);
    window.dinoTimeout = setTimeout(() => {
        bubble.classList.add('opacity-0', 'translate-y-2');
        
        if (!isTimerRunning) {
            dinoIcon.className = `fa-solid ${userAvatar} text-6xl text-gray-500 transition-colors duration-500 animate-dino-sleep`;
            const zzz = document.getElementById('dinoZzz');
            if(zzz) zzz.classList.remove('opacity-0');
        }
        setTimeout(() => {
            bubble.classList.add('hidden');
        }, 300);
    }, 4000);
}

function goToDashboardItem(itemId) {
    // 1. Retour au Dashboard (on cache le reste)
    document.getElementById('itemDetailView').classList.add('hidden');
    document.getElementById('calendarView').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('hidden');
    document.getElementById('filterBar').classList.remove('hidden');

    // 2. Simulation de la recherche
    document.getElementById('searchInput').value = itemId;
    
    // 3. Reset du filtre matière (pour être sûr de trouver l'item peu importe sa matière)
    const filterSelect = document.getElementById('matiereFilter');
    filterSelect.value = 'all';
    
    // Mise à jour visuelle du filtre (icône)
    const icon = document.getElementById('filterIcon');
    if(icon) icon.className = "fa-solid fa-filter text-gray-400 group-hover:text-white text-xs transition-colors duration-300";
    updateGlobalGlow('Général'); // Reset couleur fond

    // 4. Affichage et Scroll
    render();
    
    setTimeout(() => {
        const filterBar = document.getElementById('filterBar');
        if(filterBar) filterBar.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);

    playSound('whoosh');
}

// --- GESTION DU MENU HEADER ---
function toggleUserMenu() {
    const menu = document.getElementById('dropdownMenuBody');
    
    if (menu.classList.contains('invisible')) {
        // OUVERTURE
        menu.classList.remove('invisible');
        // Petit délai pour l'animation CSS
        setTimeout(() => {
            menu.classList.remove('opacity-0', 'scale-95');
            menu.classList.add('opacity-100', 'scale-100');
        }, 10);
        playSound('click');
    } else {
        // FERMETURE
        menu.classList.remove('opacity-100', 'scale-100');
        menu.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            menu.classList.add('invisible');
        }, 200);
    }
}

// Fermer le menu si on clique en dehors
document.addEventListener('click', (e) => {
    const menuContainer = document.getElementById('userMenuDropdown');
    const menuBody = document.getElementById('dropdownMenuBody');
    
    // Si le menu est ouvert ET que le clic n'est pas dans le conteneur du menu
    if (menuBody && !menuBody.classList.contains('invisible') && !menuContainer.contains(e.target)) {
        toggleUserMenu(); // On ferme
    }
});

// --- GESTION DU TEXTE RICHE ---
function formatText(command, value = null) {
    // Cette commande native applique le style à la sélection actuelle
    document.execCommand(command, false, value);
    
    // On remet le focus sur la zone de texte pour continuer à écrire
    const editor = document.getElementById('detailNotesArea');
    editor.focus();
    
    // On force la sauvegarde immédiate
    saveCurrentNotes();
}

function saveCurrentNotes() {
    if(!currentItemId) return;
    
    // Note : On sauvegarde innerHTML (le code HTML avec les couleurs) au lieu de value
    const content = document.getElementById('detailNotesArea').innerHTML;
    userItemNotes[currentItemId] = content;
    saveData();
    
    // Indicateur visuel
    const ind = document.getElementById('noteSaveIndicator');
    ind.style.opacity = '1';
    setTimeout(() => ind.style.opacity = '0', 1000);
}

function saveCurrentErrors() {
    if(!currentItemId) return;
    const content = document.getElementById('detailErrorsArea').innerHTML;
    userItemErrors[currentItemId] = content;
    saveData();
}

// --- GESTION DES LIENS PERSONNALISÉS ---

function openLinkModal() {
    const modal = document.getElementById('linkModal');
    document.getElementById('linkName').value = '';
    document.getElementById('linkUrl').value = '';
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modal.querySelector('.glass-panel').classList.remove('scale-95');
        modal.querySelector('.glass-panel').classList.add('scale-100');
    }, 10);
    document.getElementById('linkName').focus();
}

function closeLinkModal() {
    const modal = document.getElementById('linkModal');
    modal.classList.add('opacity-0');
    modal.querySelector('.glass-panel').classList.remove('scale-100');
    modal.querySelector('.glass-panel').classList.add('scale-95');
    setTimeout(() => modal.classList.add('hidden'), 300);
}

function saveCustomLink() {
    const name = document.getElementById('linkName').value.trim();
    let url = document.getElementById('linkUrl').value.trim();
    
    if (name && url) {
        if (!url.startsWith('http')) url = 'https://' + url;
        
        userLinks.push({ name, url });
        // localStorage.setItem... <-- Plus besoin de ça si on sauvegarde dans le cloud
        
        saveData(); // <--- AJOUT ESSENTIEL
        
        renderHeaderLinks();
        closeLinkModal();
        playSound('success');
        showToast('Raccourci ajouté !', 'success');
    } else {
        playSound('error');
        showToast('Veuillez remplir les champs.', 'error');
    }
}

function deleteLink(index) {
    if(confirm('Supprimer ce raccourci ?')) {
        userLinks.splice(index, 1);
        
        saveData(); // <--- AJOUT ESSENTIEL
        
        renderHeaderLinks();
        playSound('click');
    }
}

function renderHeaderLinks() {
    const container = document.getElementById('customLinksContainer');
    if (!container) return;
    
    // Palette de couleurs (Cycle)
    const colors = ['blue', 'emerald', 'purple', 'amber', 'pink', 'cyan', 'rose', 'indigo'];

    container.innerHTML = userLinks.map((link, index) => {
        // 1. Couleur cyclique
        const c = colors[index % colors.length];
        
        // 2. Première lettre en majuscule
        const letter = link.name ? link.name.charAt(0).toUpperCase() : "?";

        return `
        <div class="relative group">
            <a href="${link.url}" target="_blank" onclick="playSound('click')" 
               class="flex items-center gap-2 bg-${c}-900/20 px-3 py-1.5 rounded-lg border border-${c}-500/20 hover:bg-${c}-900/40 hover:border-${c}-500/40 transition" 
               title="${link.name}">
                
                <span class="font-display font-black text-xs text-${c}-400 group-hover:text-${c}-300">
                    ${letter}
                </span>

                <span class="text-xs font-bold text-${c}-100/80 group-hover:text-white uppercase max-w-[100px] truncate">
                    ${link.name}
                </span>
            </a>
            
            <button onclick="deleteLink(${index})" class="absolute -top-1.5 -right-1.5 w-4 h-4 bg-red-500 text-white rounded-full text-[8px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-md hover:scale-110">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
    `}).join('');
}

function toggleSoundPreview(checkbox) {
            const icon = document.getElementById('soundIconSettings');
            const bg = document.getElementById('soundIconBg');
            
            if (checkbox.checked) {
                icon.className = "fa-solid fa-volume-high";
                bg.className = "w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center transition-colors";
                // Petit bruit pour confirmer que le son marche
                // (On force playSound ici car audioSystem.enabled n'est pas encore sauvegardé)
                const testSound = audioSystem.sounds['click'];
                if(testSound) { testSound.currentTime=0; testSound.volume=0.2; testSound.play().catch(()=>{}); }
            } else {
                icon.className = "fa-solid fa-volume-xmark";
                bg.className = "w-10 h-10 rounded-full bg-gray-700/50 text-gray-500 flex items-center justify-center transition-colors";
            }
        }

function startTutorial() {
    const driver = window.driver.js.driver;
    
    const driverObj = driver({
        showProgress: true,
        animate: true,
        allowClose: true,
        // Boutons simplifiés pour éviter les bugs d'affichage d'icônes dans les boutons
        nextBtnText: 'Suivant',
        prevBtnText: 'Retour',
        doneBtnText: 'C\'est parti !',
        
        // --- C'EST ICI QUE LA CORRECTION SE FAIT ---
        // Cette fonction s'exécute à chaque étape pour injecter l'icône proprement
        onPopoverRendered: (popover, { state }) => {
            const step = state.activeStep;
            // Si l'étape a une icône définie
            if (step && step.popover && step.popover.icon) {
                const titleEl = popover.wrapper.querySelector('.driver-popover-title');
                
                // On vérifie si l'icône n'est pas déjà là (pour éviter les doublons)
                if (titleEl && !titleEl.querySelector('i')) {
                    // On crée l'icône et on l'insère au début du titre
                    const iconHtml = `<i class="${step.popover.icon}" style="margin-right: 12px;"></i>`;
                    titleEl.insertAdjacentHTML('afterbegin', iconHtml);
                }
            }
        },

        steps: [
            { 
                element: '#greetingDisplay', 
                popover: { 
                    title: 'Bienvenue Docteur', // Titre propre (sans HTML)
                    icon: 'fa-solid fa-hand-sparkles', // L'icône est définie ici
                    description: 'Voici <b>Ultimed</b>, votre cockpit de guerre pour la R2C. Oubliez les fichiers Excel. Ici, on optimise votre temps de cerveau disponible.', 
                    side: "bottom", 
                    align: 'start' 
                } 
            },
            { 
                element: '#xpDisplay', 
                popover: { 
                    title: 'Gamification R2C', 
                    icon: 'fa-solid fa-chart-line',
                    description: 'La médecine est un marathon. <br><br>Gagnez de l\'<b>XP</b> à chaque item lu ou maîtrisé. Montez de niveau pour débloquer des avatars exclusifs.', 
                    side: "left", 
                    align: 'start' 
                } 
            },
            { 
                element: '#dinoWrapper', 
                popover: { 
                    title: 'Mode Focus', 
                    icon: 'fa-solid fa-stopwatch',
                    description: 'Cliquez sur <b>Play</b> pour lancer un chronomètre de travail. <br><br>Le Dragon veille : il vous encouragera lors de vos pauses.', 
                    side: "right", 
                    align: 'center' 
                } 
            },
            { 
                element: '#todoInput', 
                popover: { 
                    title: 'Objectifs Tactiques', 
                    icon: 'fa-solid fa-bullseye',
                    description: 'Ne commencez pas sans plan. <br>Tapez ici vos priorités (ex: "Item 154") pour créer une liste d\'attaque immédiate.', 
                    side: "top", 
                    align: 'start' 
                } 
            },
            { 
                element: '#coursesGrid', 
                popover: { 
                    title: 'Vos Items', 
                    icon: 'fa-solid fa-layer-group',
                    description: 'Le cœur du réacteur.<br><br>✅ <b>Coche :</b> Marquer comme "Lu".<br>🏆 <b>Trophée :</b> Marquer comme "Maîtrisé".<br>📂 <b>Clic :</b> Ouvrir la fiche détaillée.', 
                    side: "top", 
                    align: 'center' 
                } 
            },
            { 
                element: '#filterBar', 
                popover: { 
                    title: 'Navigation Rapide', 
                    icon: 'fa-solid fa-filter',
                    description: 'Un trou de mémoire ? Utilisez la barre de recherche pour retrouver un cours instantanément, ou filtrez par matière via l\'icône.', 
                    side: "bottom", 
                    align: 'center' 
                } 
            }
        ],
        onDestroyStarted: () => {
            localStorage.setItem('ultimed_tutorial_seen', 'true');
            playSound('success'); 
            driverObj.destroy();
        },
    });

    driverObj.drive();
}

        function populateFilters() { const select = document.getElementById('matiereFilter'); const matieres = [...new Set(rawItems.map(i => i.m))].sort(); select.innerHTML = '<option value="all">Toutes</option>' + matieres.map(m => `<option value="${m}">${m}</option>`).join(''); }

	function toggleStatus(id, type) {
    // Initialisation sécurité
    if (!userXPClaimed[id]) userXPClaimed[id] = {};

    // 1. GESTION DE LA BASCULE (TOGGLE)
    if (type === 'maitrise' && userStatus[id] === 'maitrise') {
        userStatus[id] = 'lu'; // Si on décoche Maîtrisé, on retombe sur Lu par sécurité
    } else {
        // Si on clique sur le statut déjà actif, on l'enlève (null), sinon on l'applique
        userStatus[id] = userStatus[id] === type ? null : type;
    }

    // 2. --- NOUVEAU : INCRÉMENTATION AUTOMATIQUE ---
    // Si un statut est actif (donc ce n'est pas une suppression)
    if (userStatus[id]) {
        // A. On ajoute 1 vue
        userVues[id] = (userVues[id] || 0) + 1;
        
        // B. On ajoute à l'historique du calendrier (point vert sur la date d'aujourd'hui)
        trackHistory(id);

        // C. Vérification : Passage en LÉGENDAIRE (10 vues)
        if (userVues[id] === 10) {
            addXP(1000, 'EXPERTISE LÉGENDAIRE (10 vues)');
            showLegendaryCelebration();
        }
    }
    // -----------------------------------------------

    // 3. GESTION DE L'XP (Première fois seulement)
    if (userStatus[id] === 'lu' && !userXPClaimed[id].lu) {
        addXP(50, 'Cours Lu (1ère fois)');
        playSound('success');
        userXPClaimed[id].lu = true;
    }
    else if (userStatus[id] === 'maitrise' && !userXPClaimed[id].maitrise) {
    // 1. On trouve le titre de l'item AVANT d'appeler la fonction
    const itemTitle = rawItems.find(i => i.id === id)?.t || "Item inconnu";
    
    addXP(200, 'Cours Maîtrisé (1ère fois)');
    
    // 2. On lance l'animation en passant le type et le titre (data)
    if (userVues[id] !== 10) {
        showCelebration('MASTERY', itemTitle);
    }
    
    userXPClaimed[id].maitrise = true;
}

    // 4. SAUVEGARDE ET RENDU
    saveData();
    buildCourses(); // Indispensable pour redessiner la barre de points
    updateStats();
    render();
}        

	function playSound(type) {
            if (!audioSystem.enabled) return;
            const sound = audioSystem.sounds[type];
            if (sound) {
                sound.currentTime = 0;
                sound.volume = 0.14;
                sound.play().catch(e => console.log("Audio bloqué par le navigateur"));
            }
        }

// --- GESTION DES ERREURS (MODE FLASHCARDS) ---

function openErrorModal() {
    playSound('click');
    const modal = document.getElementById('errorModal');
    if(!currentItemId) return;

    renderErrorCards(); // Affiche les cartes
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modal.querySelector('.glass-panel').classList.remove('scale-95');
        modal.querySelector('.glass-panel').classList.add('scale-100');
    }, 10);
    
    document.getElementById('newErrorInput').focus();
}

function closeErrorModal() {
    const modal = document.getElementById('errorModal');
    modal.classList.add('opacity-0');
    modal.querySelector('.glass-panel').classList.remove('scale-100');
    modal.querySelector('.glass-panel').classList.add('scale-95');
    setTimeout(() => modal.classList.add('hidden'), 300);
}

function addErrorCard() {
    const input = document.getElementById('newErrorInput');
    const text = input.value.trim();
    
    if (text && currentItemId) {
        // Initialisation si vide
        if (!Array.isArray(userItemErrors[currentItemId])) {
            userItemErrors[currentItemId] = [];
        }
        
        // Ajout au début de la liste
        userItemErrors[currentItemId].unshift(text);
        saveData();
        
        input.value = '';
        renderErrorCards();
        updateErrorButtonLabel(); // Met à jour le compteur sur le bouton du dashboard
        playSound('click');
    }
}

function removeErrorCard(index) {
    if (currentItemId && userItemErrors[currentItemId]) {
        userItemErrors[currentItemId].splice(index, 1);
        saveData();
        renderErrorCards();
        updateErrorButtonLabel();
        playSound('error'); // Petit bruit de suppression
    }
}

function renderErrorCards() {
    const container = document.getElementById('errorCardsGrid');
    const emptyState = document.getElementById('emptyErrorState');
    
    // Récupération des erreurs (Gestion rétroactive si c'était du texte avant)
    let errors = userItemErrors[currentItemId];
    
    if (typeof errors === 'string') {
        // Migration automatique : Si c'était du texte, on le met dans un tableau
        errors = [errors];
        userItemErrors[currentItemId] = errors;
    }
    if (!errors) errors = [];

    container.innerHTML = '';

    if (errors.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }

    container.classList.remove('hidden');
    emptyState.classList.add('hidden');

    container.innerHTML = errors.map((err, index) => `
        <div class="group relative bg-[#1a1a1a] border border-red-500/20 p-4 rounded-xl hover:border-red-500/50 transition-all hover:-translate-y-1 shadow-md aspect-square flex flex-col">
            
            <button onclick="removeErrorCard(${index})" class="absolute top-2 right-2 w-6 h-6 rounded-lg bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition opacity-0 group-hover:opacity-100 z-10">
                <i class="fa-solid fa-times text-xs"></i>
            </button>

            <div class="flex-grow overflow-y-auto custom-scrollbar pr-1 mt-2 mb-4">
                <p class="text-red-100 text-xs md:text-sm font-medium leading-relaxed break-words text-center flex items-center justify-center min-h-full">
                    ${err}
                </p>
            </div>
            
            <div class="absolute bottom-2 right-3 text-[9px] text-red-500/30 font-mono select-none">#${index + 1}</div>
        </div>
    `).join('');
}

function updateErrorButtonLabel() {
    if(!currentItemId) return;
    
    // Récupération des erreurs
    let errors = userItemErrors[currentItemId];
    let count = 0;
    
    if (Array.isArray(errors)) count = errors.length;
    else if (typeof errors === 'string' && errors.length > 0) count = 1;

    const label = document.getElementById('errorCountLabel');
    
    if(label) {
        if (count > 0) {
            // Affiche SEULEMENT le chiffre
            label.innerText = count; 
            // Affiche la pastille
            label.classList.remove('hidden'); 
        } else {
            // Cache la pastille s'il n'y a pas d'erreur
            label.classList.add('hidden'); 
        }
    }
}
        /* --- MODE OR (MAÎTRISE) --- */
function showCelebration(type, data = null) {
    const overlay = document.getElementById('celebrationOverlay');
    const content = document.getElementById('celebrationContent');
    const titleEl = document.querySelector('#celebrationOverlay h2');
    const subtitleEl = document.querySelector('#celebrationOverlay span');
    
    const dragon = document.getElementById('iconDragon');
    const crown = document.getElementById('iconCrown');
    const trophy = document.getElementById('iconTrophy');
    const ring = document.getElementById('celebrationRing');
    const glow = document.getElementById('celebrationGlow');

    // --- 1. DÉFINITION DU THÈME ET DU CONTENU ---
    let title = 'VICTOIRE !';
    let subtitle = 'Félicitations';
    let iconToShow = dragon; 
    
    // Définitions de couleurs de base
    let baseColor = 'yellow';
    let fromColor = 'yellow-200';
    let toColor = 'yellow-600';
    let ringClass = 'border-yellow-500/30 animate-gold-pulse';
    let glowColor = 'rgba(250, 204, 21, 0.2)';

    // Réinitialisation des icônes
    [dragon, crown, trophy].forEach(el => el.classList.add('hidden'));

    if (type === 'LEVELUP') {
        // --- THÈME VERT (Level Up) ---
        title = 'NIVEAU UP !';
        subtitle = `Vous êtes maintenant Niveau ${userLevel} !`;
        iconToShow = dragon; 
        
        // Nouvelle palette verte
        baseColor = 'green';
        fromColor = 'green-200';
        toColor = 'green-600';
        ringClass = 'border-green-500/30 animate-pulse-fast'; // Utilisation d'une animation plus simple
        glowColor = 'rgba(34, 197, 94, 0.3)';
        
        // --- NOUVELLE LIGNE : COLORATION DU DRAGON ---
        // On remplace le style par défaut par le Vert
        dragon.className = `fa-solid ${userAvatar} text-[180px] text-green-400 drop-shadow-[0_0_20px_rgba(34,197,94,0.8)] relative z-10`;
        // On s'assure que la couronne est cachée pour le Level Up simple
        crown.classList.add('hidden');
        
        playSound('levelUp');
    } else if (type === 'MASTERY') {
        // CÉLÉBRATION MAÎTRISE D'ITEM (Trophée / Dragon avec Couronne)
        title = 'MAÎTRISÉ !';
        subtitle = `L'item "${data}" est validé.`; 
        iconToShow = trophy;
        crown.classList.add('hidden'); // S'assure que la couronne ne reste pas
        iconToShow.classList.remove('hidden');
        playSound('mastery');
    } else if (type === 'GRAND_CHELEM') {
        // Exceptionnel reste en Or
        title = 'EXCEPTIONNEL !';
        subtitle = 'Toutes les suggestions du jour sont complétées';
        iconToShow = trophy;
        iconToShow.classList.remove('hidden');
        playSound('mastery');
    }
    
    // --- 2. APPLICATION DES STYLES DYNAMIQUES ---
    
    // Application du titre avec la couleur choisie
    titleEl.innerText = title;
    titleEl.className = `text-6xl md:text-8xl font-display font-black text-transparent bg-clip-text bg-gradient-to-b from-${fromColor} to-${toColor} tracking-widest uppercase drop-shadow-2xl py-4 leading-normal`;
    
    // Application du sous-titre
    subtitleEl.innerText = subtitle;
    subtitleEl.className = `text-${baseColor}-500/80 font-mono text-sm uppercase tracking-[0.4em]`;

    // CERCLE & GLOW
    if(ring) ring.className = `absolute inset-0 rounded-full border-2 ${ringClass} scale-150`;
    if(glow) glow.className = `absolute inset-0 bg-${baseColor}-500/20 blur-[120px] rounded-full`;
    
    // Style de l'icône principale (Dragon ou Trophée)
    iconToShow.classList.remove('hidden');
    
    // 3. AFFICHAGE ET TIMING
    overlay.classList.remove('hidden');
    void overlay.offsetWidth;
    requestAnimationFrame(() => {
        overlay.classList.remove('opacity-0');
        overlay.classList.add('active'); 
        content.classList.remove('scale-0');
    });

    // Masquage automatique
    setTimeout(() => {
        overlay.classList.remove('active');
        overlay.classList.add('opacity-0');
        content.classList.add('scale-0');
        setTimeout(() => overlay.classList.add('hidden'), 500);
    }, 2500); 
}

/* --- MODE VIOLET (LÉGENDAIRE) --- */
function showLegendaryCelebration() {
    const overlay = document.getElementById('celebrationOverlay');
    const content = document.getElementById('celebrationContent');
    const title = document.querySelector('#celebrationOverlay h2');
    const subtitle = document.querySelector('#celebrationOverlay span');
    
    const dragon = document.getElementById('iconDragon');
    const crown = document.getElementById('iconCrown');
    const trophy = document.getElementById('iconTrophy');
    const ring = document.getElementById('celebrationRing');
    const glow = document.getElementById('celebrationGlow');

    playSound('levelUp');

    // 1. TEXTES EN VIOLET
    title.innerText = 'LÉGENDAIRE';
    title.className = "text-6xl md:text-8xl font-display font-black text-transparent bg-clip-text bg-gradient-to-b from-fuchsia-300 to-purple-600 tracking-widest uppercase drop-shadow-[0_0_35px_rgba(192,38,211,0.9)] py-4 leading-normal";
    
    subtitle.innerText = '10 Vues - Expertise Absolue';
    subtitle.className = "text-fuchsia-300 font-mono text-sm uppercase tracking-[0.4em]";

    // 2. ICÔNES EN VIOLET
    dragon.className = "fa-solid fa-dragon text-[180px] text-fuchsia-500 drop-shadow-[0_0_50px_rgba(192,38,211,0.8)] relative z-10 fa-beat";
    dragon.classList.remove('hidden');

    crown.className = "fa-solid fa-crown text-6xl text-purple-300 absolute -top-16 left-1/2 transform -translate-x-1/2 animate-bounce z-20 drop-shadow-[0_0_20px_rgba(168,85,247,1)]";
    crown.classList.remove('hidden');
    
    trophy.classList.add('hidden');

    // 3. CERCLE & GLOW EN VIOLET (CORRECTION ICI)
    // On utilise 'animate-purple-pulse' que nous venons d'ajouter dans Tailwind
    if(ring) ring.className = "absolute inset-0 rounded-full border-4 border-fuchsia-500/50 animate-purple-pulse scale-150";
    if(glow) glow.className = "absolute inset-0 bg-fuchsia-600/40 blur-[120px] rounded-full";

    // 4. AFFICHAGE
    overlay.classList.remove('hidden');
    void overlay.offsetWidth;
    requestAnimationFrame(() => {
            overlay.classList.remove('opacity-0');
            overlay.classList.add('active'); 
            content.classList.remove('scale-0');
    });
    setTimeout(() => {
        overlay.classList.remove('active');
        overlay.classList.add('opacity-0');
        content.classList.add('scale-0');
        setTimeout(() => {
            overlay.classList.add('hidden');
        }, 500);
    }, 3500);
}

	function anchorToFilterBar() {
    const targetElement = document.getElementById('subjectHeader');
    
    if (targetElement) {
        // Timeout pour attendre que le DOM se stabilise après le rendu de la grille
        setTimeout(() => {
            // Calcule la position verticale de l'en-tête
            const targetPosition = targetElement.offsetTop;
            
            // Défilement : targetPosition - 90px
            // L'offset de 90px est calculé pour placer l'élément juste sous le header fixe (h-20 ≈ 80px)
            window.scrollTo({
                top: targetPosition - 90, 
                behavior: 'smooth'
            });
        }, 200); // Délai stable de 200ms
    }
}

        function filterByMatiere(m) { 
            document.getElementById('matiereFilter').value = m; 
            handleFilterChange(document.getElementById('matiereFilter')); 
            render(); 
            window.scrollTo({top: document.getElementById('filterBar').offsetTop - 100, behavior: 'smooth'}); 
        }

        function resetView() { 
    const dashboard = document.getElementById('dashboardView');
    const calendar = document.getElementById('calendarView');
    const detail = document.getElementById('itemDetailView');
    const filterBar = document.getElementById('filterBar');

    // --- FIX : FORCER L'AFFICHAGE DU DASHBOARD ---
    if(dashboard) dashboard.classList.remove('hidden');
    if(calendar) calendar.classList.add('hidden');
    if(detail) detail.classList.add('hidden');
    if(filterBar) filterBar.classList.remove('hidden');
    // ----------------------------------------------

    // Réinitialisation des filtres
    document.getElementById('matiereFilter').value = 'all'; 
    handleFilterChange(document.getElementById('matiereFilter')); // Ceci met à jour le glow et l'icône
    
    document.getElementById('searchInput').value = ''; 
    currentStatusFilter = 'all'; 
    
    render(); // Rendu final
    window.scrollTo(0,0); 
    playSound('whoosh');
}

function trackHistory(itemId) {
    const today = new Date().toISOString().split('T')[0];
    if (!userHistory[today]) userHistory[today] = [];
    
    if (!userHistory[today].includes(itemId)) {
        userHistory[today].push(itemId);
        localStorage.setItem('ultimed_history', JSON.stringify(userHistory));
        // On met à jour le streak si le calendrier est ouvert
        if(!document.getElementById('calendarView').classList.contains('hidden')) {
            renderCalendar();
        }
    }
}

// --- NOUVELLE LOGIQUE DE RESET ---

// 1. Ouvre la fenêtre d'avertissement
function resetProgress() {
    const modal = document.getElementById('resetConfirmModal');
    modal.classList.remove('hidden');
    
    // Animation d'entrée
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modal.querySelector('.glass-panel').classList.remove('scale-95');
        modal.querySelector('.glass-panel').classList.add('scale-100');
    }, 10);
    
    playSound('error'); // Petit son dramatique à l'ouverture
}

// 2. Ferme la fenêtre
function closeResetModal() {
    const modal = document.getElementById('resetConfirmModal');
    modal.classList.add('opacity-0');
    modal.querySelector('.glass-panel').classList.remove('scale-100');
    modal.querySelector('.glass-panel').classList.add('scale-95');
    setTimeout(() => modal.classList.add('hidden'), 300);
}

// 3. EXÉCUTE LE NETTOYAGE (L'ancienne logique)
function executeFullReset() {
    // 1. RAZ des variables en mémoire
    userStatus = {};
    userTodos = [];
    userVues = {};
    userXP = 0;
    userLevel = 0;
    userResources = [];
    userItemNotes = {};
    userItemDifficulty = {};
    userItemErrors = {};
    userLinks = [];
    userHistory = {}; 
    userPlanning = {};
    userSubjectNotes = {};
    dailySuggestionsDone = {};
    currentSuggestions = [];

    // Profil par défaut
    userName = "";
    userAlias = "Docteur";
    userAvatar = "fa-dragon";
    userUnlockedAvatars = ['fa-dragon'];

    // 2. RAZ du LocalStorage (Nettoyage complet)
    // On garde juste la clé API pour ne pas embêter l'utilisateur
    const savedKey = localStorage.getItem('ultimed_apiKey');
    localStorage.clear();
    if(savedKey) localStorage.setItem('ultimed_apiKey', savedKey);

    // 3. RAZ de Firebase (Sauvegarde d'un objet vide/par défaut)
    saveData(); 

    // 4. Mise à jour visuelle
    updateGreetingDisplay();
    document.getElementById('countdownDisplay').innerText = "---";
    const targetDateMini = document.getElementById('targetDateMini');
    if(targetDateMini) targetDateMini.innerText = "Non défini";
    
    if(typeof renderHeaderLinks === 'function') renderHeaderLinks();
    
    buildCourses(); 
    render();
    updateStats();
    renderTodos();
    if (typeof updateXPDisplay === 'function') updateXPDisplay();
    
    // Reset Calendrier UI
    if (typeof renderCalendar === 'function') {
        currentCalendarDate = new Date();
        renderCalendar();
        document.getElementById('dayItemsList').innerHTML = '<div class="text-center text-gray-600 text-xs italic mt-10">Rien de prévu ni de fait.</div>';
    }
    
    // Relancer les suggestions
    renderSuggestions(true);

    // Fermeture des modales
    closeResetModal();
    closeGlobalSettings();
    
    playSound('whoosh'); 
    showToast("Système entièrement réinitialisé (Cloud & Local).", "success");
}

        // --- MODALS & PLAYER ---
        const addModal = document.getElementById('addModal');
        const playerModal = document.getElementById('playerModal');
        const aiModal = document.getElementById('aiModal'); 

        function openGeneralModal() { addModal.classList.remove('hidden'); addModal.classList.add('flex'); document.getElementById('modalTitle').innerText = 'Ajouter'; document.getElementById('itemInputGroup').classList.remove('hidden'); document.getElementById('typeInputGroup').classList.remove('hidden'); document.getElementById('targetItem').value = ''; document.getElementById('newLink').value = '';             
document.getElementById('newLink').focus(); 
        }

        function closeModal() { addModal.classList.add('hidden'); addModal.classList.remove('flex'); }

function openModalForItem(id, type) { 
   playSound('click');
    addModal.classList.remove('hidden'); 
    addModal.classList.add('flex'); 
    
    document.getElementById('targetItem').value = id; 
    
    const radios = document.getElementsByName('resType'); 
    for(const r of radios) if(r.value === type) r.checked = true; 
    
    document.getElementById('modalTitle').innerText = `Ajouter ${type.toUpperCase()}`; 
    document.getElementById('itemInputGroup').classList.add('hidden'); 
    document.getElementById('typeInputGroup').classList.add('hidden'); 
    
    // --- AJOUT ICI : RESET DU NOM ---
    document.getElementById('resourceName').value = ''; 
    // --------------------------------
    
    document.getElementById('newLink').value = ''; 
    document.getElementById('newLink').focus(); 
}

        function closeAiModal() { 
            aiModal.classList.add('hidden');
            aiModal.classList.remove('flex');
            document.getElementById('tutorChatInterface').classList.add('hidden');
            document.getElementById('aiContent').classList.add('hidden');
        }

        function convertToEmbed(url) {
            if (url.includes('drive.google.com')) return url.replace(/\/view.*/, '/preview').replace(/\/edit.*/, '/preview').replace(/\/file\/d\/(.*?)\/.*/, '/file/d/$1/preview');
            if (url.includes('youtube.com') || url.includes('youtu.be')) { var videoId = url.split('v=')[1]; if(!videoId && url.includes('youtu.be')) videoId = url.split('/').pop(); if(videoId) { const ampersandPosition = videoId.indexOf('&'); if(ampersandPosition != -1) videoId = videoId.substring(0, ampersandPosition); return `https://www.youtube.com/embed/${videoId}`; } }
            return url;
        }

        function openPlayer(link, type, title) {
addXP(10, `Lecture ${type}`);
            playerModal.classList.remove('hidden'); playerModal.classList.add('flex'); void playerModal.offsetWidth; playerModal.classList.remove('opacity-0', 'scale-95');
            document.getElementById('playerTitle').innerText = title || "Lecture";
            const container = document.getElementById('playerContainer'); const wrapper = document.getElementById('playerWrapper'); const loader = document.getElementById('playerLoader');
            const oldIframe = container.querySelector('iframe, audio'); if(oldIframe) oldIframe.remove();
            
            wrapper.className = "bg-[#111] border border-white/10 rounded-2xl shadow-2xl relative overflow-hidden flex flex-col transition-all duration-500 ease-out"; 

            loader.classList.remove('hidden');
            
            if (type === 'video' || type === 'flash') wrapper.classList.add('w-full', 'max-w-6xl', 'aspect-video');
            else if (type === 'audio') wrapper.classList.add('w-full', 'max-w-2xl', 'h-64');
            else if (type === 'fiche') wrapper.classList.add('w-full', 'max-w-[95vw]', 'h-[95vh]');

            const embedUrl = convertToEmbed(link);
            if (type === 'audio' && (link.endsWith('.mp3') || link.endsWith('.wav'))) {
                 container.insertAdjacentHTML('beforeend', `<div class="absolute inset-0 flex items-center justify-center gap-1 opacity-20 pointer-events-none">${Array(20).fill('<div class="bar"></div>').join('')}</div><audio controls autoplay class="w-3/4 z-10 relative"><source src="${link}" type="audio/mpeg">Votre navigateur ne supporte pas l'audio.</audio>`);
                 loader.classList.add('hidden');
            } else {
                 container.insertAdjacentHTML('beforeend', `<iframe src="${embedUrl}" class="w-full h-full border-none opacity-0 transition-opacity duration-700 relative z-10" allow="autoplay; fullscreen" allowfullscreen onload="this.classList.remove('opacity-0'); document.getElementById('playerLoader').classList.add('hidden');"></iframe>`);
            }
        }

        function closePlayer() {
            playerModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => { playerModal.classList.add('hidden'); playerModal.classList.remove('flex'); const container = document.getElementById('playerContainer'); const oldIframe = container.querySelector('iframe, audio'); if(oldIframe) oldIframe.remove(); }, 300);
        }

        function attachResource() {
    const id = document.getElementById('targetItem').value; 
    var type = 'video'; 
    document.getElementsByName('resType').forEach(r => { if(r.checked) type = r.value; }); 
    const link = document.getElementById('newLink').value;
    
    // --- AJOUT : RÉCUPÉRATION DU NOM ---
    const nameVal = document.getElementById('resourceName').value.trim();
    // -----------------------------------

    if(id && link) { 
        // On sauvegarde le nom. S'il est vide, on ne met rien (le système devinera un nom plus tard)
        userResources.push({ 
            itemId: id, 
            type, 
            link, 
            name: nameVal, // Nouveau champ
            addedAt: Date.now() 
        }); 
        
        saveData(); 
        
        buildCourses(); 
        render(); 

        if (currentItemId === id && !document.getElementById('itemDetailView').classList.contains('hidden')) {
            renderDetailResources(id);
            if(!document.getElementById('resourceListModal').classList.contains('hidden')) {
                openResourceListModal(id, type);
            }
        }

        closeModal(); 
        playSound('success');
        showToast('Ressource ajoutée', 'success');
    } else {
        playSound('error');
        showToast('Le lien est obligatoire', 'error');
    }
}

function openResourceListModal(itemId, type) {
    playSound('click');
    const modal = document.getElementById('resourceListModal');
    const container = document.getElementById('resListContainer');
    const title = document.getElementById('resListTitle');
    const icon = document.getElementById('resListIcon');
    const addBtn = document.getElementById('resListAddBtn');
    
    const typesConfig = {
        video: { label: 'Vidéos', icon: 'fa-video', color: 'red' },
        audio: { label: 'Audios', icon: 'fa-headphones', color: 'yellow' },
        flash: { label: 'Flashcards', icon: 'fa-bolt', color: 'purple' },
        fiche: { label: 'Fiches PDF', icon: 'fa-file-pdf', color: 'blue' }
    };
    const conf = typesConfig[type];

    title.innerText = `Bibliothèque ${conf.label}`;
    title.className = `text-xl font-display font-bold text-${conf.color}-400 flex items-center gap-3`;
    icon.className = `fa-solid ${conf.icon}`;
    
    addBtn.onclick = () => { closeResourceListModal(); openModalForItem(itemId, type); };
    addBtn.className = `w-full py-3 rounded-xl bg-${conf.color}-600 hover:bg-${conf.color}-500 text-white font-bold text-sm shadow-lg flex items-center justify-center gap-2 transition-transform hover:scale-105 active:scale-95`;

    const resources = userResources.filter(r => r.itemId === itemId && r.type === type);

    if (resources.length === 0) {
        container.innerHTML = `<div class="text-center py-8 text-gray-500 italic">Aucune ressource de ce type.</div>`;
    } else {
        container.innerHTML = resources.map((res, index) => {
            // Nom par défaut
            let displayName = res.name;
            if (!displayName) {
                try {
                    const urlObj = new URL(res.link);
                    displayName = urlObj.hostname.replace('www.', '') + (urlObj.pathname.length > 1 ? urlObj.pathname.substring(0, 15) + '...' : '');
                } catch(e) { displayName = `Ressource #${index + 1}`; }
            }

            // On échappe les guillemets pour éviter les bugs HTML
            const safeLink = res.link.replace(/'/g, "\\'");
            const safeName = displayName.replace(/'/g, "&apos;");

            return `
            <div class="bg-white/5 border border-white/10 hover:border-${conf.color}-500/50 rounded-xl p-3 flex items-center gap-3 group transition-all">
                
                <div class="w-10 h-10 rounded-lg bg-${conf.color}-500/20 text-${conf.color}-400 flex items-center justify-center font-bold text-sm flex-shrink-0">
                    ${index + 1}
                </div>
                
                <div class="flex-grow overflow-hidden">
                    
                    <div id="display-mode-${index}" class="cursor-pointer" onclick="closeResourceListModal(); openPlayer('${safeLink}', '${type}', '${safeName}')">
                        <div class="text-sm font-bold text-gray-200 group-hover:text-white truncate">${displayName}</div>
                        <div class="text-[10px] text-gray-500 truncate font-mono">${res.link}</div>
                    </div>

                    <div id="edit-mode-${index}" class="hidden flex items-center gap-2">
                        <input type="text" id="input-rename-${index}" value="${safeName}" 
                               class="w-full bg-[#111] border border-blue-500 rounded px-2 py-1 text-xs text-white focus:outline-none"
                               onkeydown="if(event.key === 'Enter') saveRenamedResource(${index}, '${itemId}', '${type}', '${safeLink}')">
                        
                        <button onclick="saveRenamedResource(${index}, '${itemId}', '${type}', '${safeLink}')" class="w-6 h-6 rounded bg-green-600 text-white flex items-center justify-center hover:bg-green-500">
                            <i class="fa-solid fa-check text-xs"></i>
                        </button>
                    </div>

                </div>

                <div id="actions-${index}" class="flex gap-1">
                    <button onclick="enableRenaming(${index})" class="w-8 h-8 rounded-lg hover:bg-blue-500/20 text-gray-600 hover:text-blue-400 flex items-center justify-center transition" title="Renommer">
                        <i class="fa-solid fa-pen text-xs"></i>
                    </button>

                    <button onclick="deleteSpecificResource('${itemId}', '${type}', '${safeLink}')" class="w-8 h-8 rounded-lg hover:bg-red-500/20 text-gray-600 hover:text-red-500 flex items-center justify-center transition" title="Supprimer">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                </div>

            </div>`;
        }).join('');
    }

    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modal.querySelector('.glass-panel').classList.remove('scale-95');
        modal.querySelector('.glass-panel').classList.add('scale-100');
    }, 10);
}

// Active le mode édition pour une ligne précise
function enableRenaming(index) {
    // 1. Masquer l'affichage et les boutons d'action
    document.getElementById(`display-mode-${index}`).classList.add('hidden');
    document.getElementById(`actions-${index}`).classList.add('hidden');
    
    // 2. Afficher le champ d'édition
    const editDiv = document.getElementById(`edit-mode-${index}`);
    editDiv.classList.remove('hidden');
    
    // 3. Mettre le focus dans l'input automatiquement
    const input = document.getElementById(`input-rename-${index}`);
    input.focus();
    input.select(); // Sélectionne tout le texte pour écraser rapidement
}

// Sauvegarde le nouveau nom
function saveRenamedResource(index, itemId, type, link) {
    const input = document.getElementById(`input-rename-${index}`);
    const newName = input.value.trim();
    
    if (newName) {
        // On trouve la ressource correspondante dans le tableau
        // Note : On utilise filter comme dans l'affichage pour être sûr de l'ordre, 
        // ou findIndex avec les critères exacts
        const resource = userResources.find(r => r.itemId === itemId && r.type === type && r.link === link);
        
        if (resource) {
            resource.name = newName;
            saveData(); // Sauvegarde Cloud
            
            // On rafraîchit la liste pour revenir au mode affichage
            openResourceListModal(itemId, type);
            playSound('click');
        }
    }
}

function closeResourceListModal() {
    const modal = document.getElementById('resourceListModal');
    modal.classList.add('opacity-0');
    modal.querySelector('.glass-panel').classList.remove('scale-100');
    modal.querySelector('.glass-panel').classList.add('scale-95');
    setTimeout(() => modal.classList.add('hidden'), 300);
}

function deleteSpecificResource(itemId, type, link) {
    if(confirm("Supprimer cette ressource précise ?")) {
        // On cherche l'index exact pour ne supprimer que celle-ci (au cas où doublon de lien)
        const index = userResources.findIndex(r => r.itemId === itemId && r.type === type && r.link === link);
        if (index > -1) {
            userResources.splice(index, 1);
            saveData();
            // Rafraîchir la liste sans fermer la modale
            openResourceListModal(itemId, type);
            // Rafraîchir le fond
            renderDetailResources(itemId);
        }
    }
}

function removeResource(id, type) {
            openConfirmModal(() => {
                 // 1. Suppression de la donnée
                 userResources = userResources.filter(r => !(r.itemId === id && r.type === type));
                 saveData();
                 
                 // 2. Mise à jour du tableau de bord
                 buildCourses();
                 render();
                 
                 // --- AJOUT : MISE À JOUR VUE DÉTAILLÉE ---
                 // Si on est sur la page de l'item concerné, on rafraîchit la liste
                 if (currentItemId === id && !document.getElementById('itemDetailView').classList.contains('hidden')) {
                     renderDetailResources(id);
                 }
                 // -----------------------------------------

                 // 3. Feedback
                 playSound('error'); // Petit son de suppression
                 showToast('Ressource supprimée', 'info');
            });
        }
        
function addXP(amount, reason) {
    userXP += amount;
    
    // Calcul du niveau (1000 XP par niveau)
    // Note: On utilise Math.floor tout court pour commencer au niveau 0
    const newLevel = Math.floor(userXP / 1000);
    
    saveData();
    updateXPDisplay();
    
    // Si on monte de niveau
    if (newLevel > userLevel) {
        userLevel = newLevel;
        
        // 1. Feedback de base
        playSound('levelUp'); 
        showCelebration('LEVELUP'); 
        showToast(`NIVEAU ${userLevel} ATTEINT !`, 'success');
    } 
    
    // --- VERIFICATION RETROACTIVE DES RECOMPENSES ---
    // On vérifie tous les niveaux de 1 jusqu'au niveau actuel
    // Comme ça, si vous êtes déjà niveau 3, vous récupérez le Chat (2) et le Poisson (3) d'un coup.
    for (let lvl = 1; lvl <= userLevel; lvl++) {
        const rewardIcon = levelRewards[lvl];
        
        if (rewardIcon) {
            // Si l'avatar n'est pas encore dans votre liste
            if (!userUnlockedAvatars.includes(rewardIcon)) {
                userUnlockedAvatars.push(rewardIcon);
                localStorage.setItem('ultimed_unlocked_avatars', JSON.stringify(userUnlockedAvatars));
                
                // Notification de déblocage (avec un petit délai pour ne pas spammer si on en gagne plusieurs)
                setTimeout(() => {
                    playSound('success'); 
                    showUnlockToast(rewardIcon); 
                }, 2000 + (lvl * 500)); // Délai progressif
            }
        }
    }
    // ------------------------------------------------

    if (newLevel <= userLevel) {
        // Feedback simple si pas de montée de niveau
        showToast(`+${amount} XP : ${reason}`, 'info');
    }
}

function updateXPDisplay() {
    const xpEl = document.getElementById('xpDisplay');
    const lvlEl = document.getElementById('lvlDisplay');
    const barEl = document.getElementById('xpBar');
    
    if(xpEl && lvlEl && barEl) {
        xpEl.innerText = userXP;
        lvlEl.innerText = userLevel;
        
        // Calcul pourcentage barre (ex: 1250 XP -> on est à 250/1000 du niveau 2)
        const progress = (userXP % 1000) / 10; // /1000 * 100
        barEl.style.width = `${progress}%`;
    }
}

        // --- AI FEATURE 1: FLASHCARD SYNTHESIS ---
        async function generateFlashcard(item, title) {
            const modal = document.getElementById('playerModal');
            const playerTitle = document.getElementById('playerTitle');
            const container = document.getElementById('playerContainer');
            const loader = document.getElementById('playerLoader');
            const wrapper = document.getElementById('playerWrapper');
            
            if (!userApiKey) {
                showToast("Veuillez configurer votre clé API Google Gemini dans les paramètres.", "info");
                openGlobalSettings();
                return;
            }

            playerTitle.innerText = `Synthèse IA pour Item ${item} - ${title}`;
            modal.classList.remove('hidden', 'opacity-0', 'scale-95');
            modal.classList.add('flex');
            loader.classList.remove('hidden');
            
            container.innerHTML = '';
            
            wrapper.className = "bg-[#111] border border-white/10 rounded-2xl shadow-2xl relative overflow-hidden flex flex-col transition-all duration-500 ease-out w-full max-w-4xl h-[80vh]";

            const systemPrompt = "Tu es un assistant de révision médicale ultra-concis. Ton rôle est de synthétiser les informations d'un item du programme R2C. Fournis une synthèse structurée pour une révision rapide.";
            const userQuery = `Synthétise l'Item R2C ${item}: "${title}". Produis un format idéal pour des flashcards : un paragraphe de résumé et une liste à puces des 5 à 7 points clés à connaître. Réponds uniquement en Markdown.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur de génération IA. Le modèle n'a pas pu produire de réponse.";

                const contentHtml = marked.parse(text);
                container.insertAdjacentHTML('beforeend', `<div class="p-6 overflow-y-auto w-full h-full flashcard-content">${contentHtml}</div>`);
                
                loader.classList.add('hidden');

            } catch (e) {
                loader.classList.add('hidden');
                container.innerHTML = `<div class="p-6 text-red-400">Erreur lors de la connexion à l'IA ou de la génération : ${e.message}. Vérifiez votre clé API ou le réseau.</div>`;
                showToast("Erreur IA. Voir modal pour les détails.", "error");
            }
        }

        // --- AI FEATURE : REVISION TUTOR CHAT ---

function startRevisionChat(item, title) {
            const modal = document.getElementById('aiModal');
            const chatInterface = document.getElementById('tutorChatInterface');
            const contentArea = document.getElementById('aiContent');
            const chatHistoryDiv = document.getElementById('chatHistory');

            if (!userApiKey) {
                showToast("Veuillez configurer votre clé API Google Gemini dans les paramètres.", "info");
                openGlobalSettings();
                return;
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('aiModalTitle').innerHTML = `<i class="fa-solid fa-microchip text-purple-400"></i> Tuteur: ${title}`;
            
            contentArea.classList.add('hidden');
            chatInterface.classList.remove('hidden');
            document.getElementById('aiLoading').classList.remove('hidden'); 

            chatHistory = [];
            chatHistoryDiv.innerHTML = '';
            
            // --- MODIFICATION DU PROMPT DE SECURITÉ ---
            currentRevisionContext = `
            Tu es un tuteur expert pour la préparation des ECN/EDN (R2C) en France.
            Sujet : Item ${item} - "${title}".
            
            RÈGLES ABSOLUES :
            1. Tes réponses doivent être basées UNIQUEMENT sur les recommandations françaises officielles (HAS, Collèges des enseignants, CNGE, etc.).
            2. Si une notion diffère entre la pratique internationale et le consensus français R2C, précise bien : "Selon le référentiel français...".
            3. Si tu as un doute ou si le sujet est controversé, demande à l'étudiant de vérifier dans son collège.
            4. Sois concis, pédagogique et bienveillant.
            
            Commence par demander à l'étudiant s'il veut un quiz, un résumé des points clés, ou s'il veut coller une partie de son cours pour que tu l'interroges dessus.
            `;
            // -------------------------------------------

            generateAIResponse([], true);
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            addMessageToChat(msg, 'user');
            input.value = '';
            
            chatHistory.push({ role: "user", parts: [{ text: msg }] });

            const loadingId = addLoadingBubble();
            
            await generateAIResponse(chatHistory, false, loadingId);
        }

        async function generateAIResponse(history, isInit = false, loadingId = null) {
            
            const contents = [
                { role: "user", parts: [{ text: currentRevisionContext }] }, 
                ...history
            ];

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`;
            
            if (!userApiKey) {
                if(loadingId) {
                    const loadingEl = document.getElementById(loadingId);
                    if(loadingEl) loadingEl.remove();
                }
                showToast("Clé API manquante.", "error");
                document.getElementById('aiLoading').classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ 
                        contents: contents, 
                        tools: [{ "google_search": {} }] 
                    }) 
                }); 

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur de réponse. (Vérifiez la clé API ou le réseau.)";

                if(loadingId) {
                    const loadingEl = document.getElementById(loadingId);
                    if(loadingEl) loadingEl.remove();
                }
                document.getElementById('aiLoading').classList.add('hidden');

                addMessageToChat(responseText, 'ai');
                
                chatHistory.push({ role: "model", parts: [{ text: responseText }] });
                
            } catch (e) {
                if(loadingId) {
                    const loadingEl = document.getElementById(loadingId);
                    if(loadingEl) loadingEl.remove();
                }
                document.getElementById('aiLoading').classList.add('hidden');
                addMessageToChat("Erreur de connexion : " + e.message, 'ai');
                showToast("Erreur de connexion IA", "error");
            }
        }

        function addMessageToChat(text, sender) {
            const div = document.getElementById('chatHistory');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender === 'user' ? 'chat-user' : 'chat-ai'}`;
            bubble.innerHTML = marked.parse(text); 
            div.appendChild(bubble);
            div.scrollTop = div.scrollHeight;
        }

        function addLoadingBubble() {
            const div = document.getElementById('chatHistory');
            const id = 'loading-' + Date.now();
            const bubble = document.createElement('div');
            bubble.id = id;
            bubble.className = `chat-bubble chat-ai animate-pulse`;
            bubble.innerHTML = '...';
            div.appendChild(bubble);
            div.scrollTop = div.scrollHeight;
            return id;
        }

        // --- FONCTIONS DE PARTAGE (EXPORT/IMPORT) ---

        /* --- EXPORTATEUR CLOUD (GÉNÈRE UN FICHIER PROPRE) --- */
async function exportData() {
    const user = firebase.auth().currentUser;
    if (!user) {
        alert("Erreur : Vous devez être connecté pour exporter vos données.");
        return;
    }

    // Petit effet visuel sur le bouton cliqué (s'il existe)
    const btn = document.activeElement; 
    const originalText = btn ? btn.innerText : "Exporter";
    if (btn && btn.tagName === 'BUTTON') {
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Création...';
    }

    try {
        console.log("📦 Récupération des données depuis le Cloud...");
        
        // 1. On récupère les données fraîches depuis Firebase
        const doc = await db.collection('users').doc(user.uid).get();
        
        let finalData = {};

        if (doc.exists) {
            // Si on a des données Cloud, on les prend (C'est la source la plus fiable)
            finalData = doc.data().userData;
        } else {
            // Secours : Si pas de Cloud, on prend les variables locales actuelles
            console.warn("⚠️ Pas de données Cloud trouvées, export de la mémoire locale.");
            finalData = {
                xp: userXP,
                status: userStatus,
                vues: userVues,
                history: userHistory,
                planning: userPlanning,
                resources: userResources,
                item_notes: userItemNotes,
                subject_notes: userSubjectNotes,
                item_difficulty: userItemDifficulty,
                item_errors: userItemErrors,
                xp_claimed: userXPClaimed,
                unlocked_avatars: userUnlockedAvatars,
                user_name: userName,
                user_alias: userAlias,
                exam_date: userExamDate
            };
        }

        // 2. Ajout de métadonnées (Pour savoir quand le fichier a été fait)
        finalData.export_date = new Date().toISOString();
        finalData.app_version = "0.81";

        // 3. Génération du fichier
        const dataStr = JSON.stringify(finalData, null, 2); // null, 2 pour rendre le fichier lisible par un humain
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        
        // 4. Téléchargement
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", url);
        
        // Nom du fichier avec la date du jour (ex: UltiMed_Backup_2023-11-27.json)
        const dateStr = new Date().toISOString().slice(0, 10);
        downloadAnchorNode.setAttribute("download", `UltiMed_Backup_${dateStr}.json`);
        
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        showToast("Fichier de sauvegarde généré !", "success");
        playSound('success');

    } catch (error) {
        console.error("Erreur d'exportation :", error);
        alert("Une erreur est survenue lors de l'exportation : " + error.message);
    } finally {
        // On remet le texte du bouton
        if (btn && btn.tagName === 'BUTTON') {
            btn.innerHTML = originalText;
        }
    }
}

// --- NOUVELLES FONCTIONS DE GESTION MODALE ---

function closeImportModal() {
    const modal = document.getElementById('importConfirmModal');
    modal.classList.add('opacity-0');
    modal.querySelector('.glass-panel').classList.remove('scale-100');
    modal.querySelector('.glass-panel').classList.add('scale-95');
    pendingImportContent = null; // Nettoyer le contenu temporaire
    setTimeout(() => modal.classList.add('hidden'), 300);
}

// Fonction qui exécute l'importation après la confirmation utilisateur
/* --- IMPORTATEUR UNIVERSEL (COMPATIBLE TOUS FORMATS) --- */
async function executeImport(contentStr) {
    const user = firebase.auth().currentUser;
    if (!user) {
        alert("Erreur : Vous devez être connecté pour importer des données.");
        return;
    }

    // Afficher un chargement sur le bouton
    const btn = document.getElementById('confirmImportBtn');
    const oldText = btn.innerText;
    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Traitement...';

    try {
        const json = JSON.parse(contentStr);
        let data = {};
        let importType = "";

        // --- CAS 1 : Format "GOLDEN BACKUP" (Propre) ---
        // C'est le format que nous avons généré tout à l'heure
        if (json.xp !== undefined || json.userData) {
            console.log("📂 Format détecté : Moderne / Cloud");
            importType = "Moderne";
            // Si le fichier contient un wrapper "userData", on prend l'intérieur, sinon on prend le json direct
            data = json.userData || json;
        } 
        
        // --- CAS 2 : Format "LEGACY" (Ancien / Tablette) ---
        // C'est le format avec les "ultimed_"
        else {
            console.log("📂 Format détecté : Legacy (Ancien)");
            importType = "Legacy";
            
            // On convertit manuellement les vieilles clés vers le nouveau format
            data = {
                xp: parseInt(json.ultimed_xp || 0),
                user_name: json.ultimed_userName || "",
                user_alias: json.ultimed_userAlias || "Docteur",
                current_avatar: json.ultimed_userAvatar || "fa-dragon",
                exam_date: json.ultimed_examDate || "",
                
                // Parsing sécurisé des JSON Strings (les trucs avec des backslashes)
                status: safeParse(json.ultimed_status),
                vues: safeParse(json.ultimed_vues),
                history: safeParse(json.ultimed_history),
                planning: safeParse(json.ultimed_planning),
                unlocked_avatars: safeParse(json.ultimed_unlocked_avatars),
                item_notes: safeParse(json.ultimed_item_notes),
                item_difficulty: safeParse(json.ultimed_item_difficulty),
                item_errors: safeParse(json.ultimed_item_errors),
                xp_claimed: safeParse(json.ultimed_xp_claimed),
                
                // Gestion spéciale des ressources (parfois vides dans les vieux fichiers)
                resources: safeParse(json.ultimed_resources, []),
                todos: safeParse(json.ultimed_todos, []),
                
                // Reconstruction des notes de matières
                subject_notes: {},
                last_update: new Date().toISOString()
            };

            // Boucle spéciale pour récupérer les notes par matière (ex: ultimed_notes_Cardiologie)
            for (const key in json) {
                if (key.startsWith('ultimed_notes_') && key !== 'ultimed_notes_matiere') {
                    const matiere = key.replace('ultimed_notes_', '');
                    if (json[key] && json[key] !== "") {
                        data.subject_notes[matiere] = json[key];
                    }
                }
            }

            // Restauration des réglages locaux (LocalStorage)
            if(json.ultimed_sound_enabled) localStorage.setItem('ultimed_sound_enabled', json.ultimed_sound_enabled);
            if(json.ultimed_tutorial_seen) localStorage.setItem('ultimed_tutorial_seen', json.ultimed_tutorial_seen);
        }

        // --- ÉTAPE FINALE : ENVOI AU CLOUD ---
        console.log("📤 Envoi des données normalisées vers Firebase...");
        
        await db.collection('users').doc(user.uid).set({ userData: data }, { merge: true });
        
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Succès !';
        
        // Petit délai pour voir le succès
        setTimeout(() => {
            alert(`IMPORT RÉUSSI (${importType}) !\n\nVos données ont été mises à jour.\nLa page va se recharger.`);
            location.reload();
        }, 500);

    } catch (err) {
        console.error("Erreur d'importation :", err);
        alert("Le fichier semble corrompu ou invalide.\nErreur : " + err.message);
        btn.innerText = oldText; // Remet le texte normal en cas d'erreur
    }
}

// Petite fonction utilitaire pour éviter les crashs sur le JSON
function safeParse(value, fallback = {}) {
    try {
        if (!value) return fallback;
        if (typeof value === 'object') return value; // Déjà un objet
        return JSON.parse(value);
    } catch (e) {
        return fallback;
    }
}

// --- MODIFICATION DE importData ---
function importData(inputElement) {
    const file = inputElement.files[0];
    if (!file) return;

    const reader = new FileReader();
    
    // Une fois le fichier lu par le navigateur
    reader.onload = function(e) {
        // 1. On stocke le contenu (texte) dans la variable globale
        pendingImportContent = e.target.result;

        // 2. On ouvre la modale de confirmation
        const modal = document.getElementById('importConfirmModal');
        modal.classList.remove('hidden');
        
        // Animation d'entrée douce
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('.glass-panel').classList.remove('scale-95');
            modal.querySelector('.glass-panel').classList.add('scale-100');
        }, 10);
        
        // 3. On programme le bouton "Oui, Remplacer" pour lancer la nouvelle fonction magique
        const confirmBtn = document.getElementById('confirmImportBtn');
        
        // On nettoie les anciens clics pour éviter les doublons
        const newBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
        
        // On attache l'action au nouveau bouton
        newBtn.onclick = () => {
            // C'est ici qu'on appelle l'importateur universel qu'on vient de créer
            executeImport(pendingImportContent);
        };
    };
    
    // Lancement de la lecture
    reader.readAsText(file);
    
    // Réinitialiser l'input pour pouvoir réimporter le même fichier si besoin
    inputElement.value = ''; 
}

// --- MOTEUR CALENDRIER (V2 : PLANIFICATION) ---
        
        function toggleCalendarView() {
            const dashboard = document.getElementById('dashboardView');
            const calendar = document.getElementById('calendarView');
            const searchBar = document.getElementById('filterBar');
            
            if (calendar.classList.contains('hidden')) {
                dashboard.classList.add('hidden');
                if(searchBar) searchBar.classList.add('hidden');
                calendar.classList.remove('hidden');
                
                renderCalendar();
                // Sélectionne aujourd'hui par défaut
                selectDate(new Date().toISOString().split('T')[0]);
                
                playSound('whoosh');
            } else {
                calendar.classList.add('hidden');
                dashboard.classList.remove('hidden');
                if(searchBar) searchBar.classList.remove('hidden');
                playSound('whoosh');
            }
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
            playSound('click');
        }

function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const todayKey = new Date().toISOString().split('T')[0];
            
            document.getElementById('calMonthYear').innerText = 
                new Date(year, month).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const firstDayIndex = new Date(year, month, 1).getDay(); 
            const adjustedFirstDay = firstDayIndex === 0 ? 6 : firstDayIndex - 1; 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < adjustedFirstDay; i++) {
                grid.innerHTML += `<div class="h-24 bg-transparent"></div>`;
            }
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                
                const historyItems = userHistory[dateKey] || [];
                const plannedItems = userPlanning[dateKey] || [];
                
                // --- CALCULS PRÉLIMINAIRES ---
                const isPast = dateKey < todayKey;
                const isToday = dateKey === todayKey;
                const isSelected = dateKey === selectedCalendarDate;

                // Ce qui a été fait
                const doneCount = historyItems.length;
                
                // Ce qu'il reste à faire (Planifié - Fait)
                const remainingItems = plannedItems.filter(id => !historyItems.includes(id));
                const todoCount = remainingItems.length;

                // --- GESTION DES COULEURS DE FOND (HEATMAP) ---
                let bgClass = "bg-[#151515]"; // Défaut (Noir)
                let borderClass = "border-white/5"; 
                let textClass = "text-gray-400";

                // 1. PRIORITÉ À L'ACTION (VERT) : Si on a travaillé
                if (doneCount > 0) {
                    if (doneCount <= 2) bgClass = "bg-green-900/20 hover:bg-green-900/30";
                    else if (doneCount <= 5) bgClass = "bg-green-800/40 hover:bg-green-800/50";
                    else bgClass = "bg-green-600/40 hover:bg-green-600/50 shadow-[inset_0_0_15px_rgba(34,197,94,0.2)]";
                } 
                // 2. SINON, SI PRÉVU (BLEU) : Si on n'a rien fait mais qu'il y a du travail (Futur/Aujourd'hui)
                else if (todoCount > 0 && !isPast) {
                    if (todoCount <= 2) bgClass = "bg-blue-900/20 hover:bg-blue-900/30";
                    else if (todoCount <= 5) bgClass = "bg-blue-800/40 hover:bg-blue-800/50";
                    else bgClass = "bg-blue-600/40 hover:bg-blue-600/50 shadow-[inset_0_0_15px_rgba(59,130,246,0.2)]";
                }
                // 3. SINON, SI PASSÉ (ROUGE) : Journée vide ou ratée
                else if (isPast) {
                    bgClass = "bg-red-900/10 hover:bg-red-900/20";
                }

                // --- GESTION DES BORDURES (Navigation) ---
                if (isToday) { 
                    textClass = "text-blue-400 font-bold"; 
                    borderClass = "border-blue-500 border-2"; 
                } else if (isSelected) { 
                    borderClass = "border-white border-2"; 
                } else if (doneCount > 0) {
                    borderClass = "border-green-500/30"; 
                } else if (todoCount > 0 && !isPast) {
                    borderClass = "border-blue-500/30"; // Bordure bleue si planifié
                } else if (isPast) {
                    borderClass = "border-red-500/20"; 
                }

                // --- POINTS (INDICATEURS) ---
                let missedCount = isPast ? todoCount : 0; // Ratés
                let pendingCount = !isPast ? todoCount : 0; // À faire
                
                let dotsHTML = `<div class="absolute bottom-2 right-2 flex gap-1 flex-wrap justify-end max-w-[80%]">`;
                // Rouge (Raté)
                for(let i=0; i<Math.min(missedCount, 3); i++) dotsHTML += `<div class="w-1.5 h-1.5 rounded-full bg-red-500 shadow-[0_0_5px_rgba(239,68,68,0.8)]"></div>`;
                // Bleu (À faire)
                for(let i=0; i<Math.min(pendingCount, 3); i++) dotsHTML += `<div class="w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_5px_rgba(59,130,246,0.8)]"></div>`;
                // Vert (Fait)
                for(let i=0; i<Math.min(doneCount, 3); i++) dotsHTML += `<div class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.8)]"></div>`;
                dotsHTML += `</div>`;

                grid.innerHTML += `<div onclick="playSound('click'); selectDate('${dateKey}')" class="relative h-24 rounded-xl border ${borderClass} ${bgClass} p-2 transition-all duration-300 cursor-pointer flex flex-col justify-between group"><span class="text-sm ${textClass}">${d}</span>${dotsHTML}</div>`;
            }
        }

        function selectDate(dateKey) {
            selectedCalendarDate = dateKey;
            renderCalendar(); // Mise à jour bordure sélection
            renderDayDetails(dateKey);
        }

   function renderDayDetails(dateKey) {
            const list = document.getElementById('dayItemsList');
            const label = document.getElementById('selectedDateLabel');
            const dateObj = new Date(dateKey);
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            label.innerText = dateObj.toLocaleDateString('fr-FR', options);
            
            const historyItems = userHistory[dateKey] || [];
            const plannedItems = userPlanning[dateKey] || [];
            
            // --- LOGIQUE DE FILTRAGE ---
            // On ne garde dans le planning QUE ce qui n'est pas encore fait
            const itemsToDo = plannedItems.filter(id => !historyItems.includes(id));
            // ---------------------------

            const todayKey = new Date().toISOString().split('T')[0];
            const isPast = dateKey < todayKey;

            list.innerHTML = '';

            if (historyItems.length === 0 && itemsToDo.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-600 text-xs italic mt-10">Rien à afficher.</div>';
                return;
            }

            // 1. SECTION "À FAIRE" (Uniquement ce qui reste)
            if (itemsToDo.length > 0) {
                const sectionTitle = isPast ? "Non Fait / Raté" : "À Faire";
                const sectionColor = isPast ? "text-red-400" : "text-blue-400";
                const sectionIcon = isPast ? "fa-circle-xmark" : "fa-clock";

                list.innerHTML += `<div class="text-[10px] font-bold ${sectionColor} uppercase tracking-widest mb-2 mt-2 pl-1 flex items-center gap-2"><i class="fa-solid ${sectionIcon}"></i> ${sectionTitle}</div>`;
                
                list.innerHTML += itemsToDo.map((itemId) => {
                    const course = rawItems.find(i => i.id === itemId);
                    if (!course) return '';
                    const config = matiereConfig[course.m] || defaultConfig;

                    const borderClass = isPast ? 'border-red-500/20 hover:bg-red-500/5' : 'border-blue-500/20 hover:bg-blue-500/5';
                    const textClass = isPast ? 'text-red-400' : 'text-blue-400';
                    const bgIconClass = isPast ? 'bg-red-500/20 text-red-400' : `bg-${config.color}-500/20 text-${config.color}-400`;

                    // IMPORTANT : On retrouve l'index original pour la suppression
                    const originalIndex = plannedItems.indexOf(itemId);

                    return `
                        <div class="bg-[#111] border ${borderClass} p-3 rounded-xl flex items-center gap-3 transition group">
                            <div class="w-8 h-8 rounded-full ${bgIconClass} flex-shrink-0 flex items-center justify-center" onclick="openItemDetail('${itemId}')">
                                <i class="fa-solid ${config.icon} text-xs"></i>
                            </div>
                            
                            <div class="flex-grow cursor-pointer overflow-hidden" onclick="openItemDetail('${itemId}')">
                                <div class="text-[10px] ${textClass} font-bold uppercase truncate">Item ${itemId}</div>
                                <div class="text-xs text-white font-medium truncate group-hover:text-white transition-colors">${course.t}</div>
                            </div>

                            <button onclick="removePlanningItem('${dateKey}', ${originalIndex})" class="w-6 h-6 rounded-full hover:bg-red-500/20 text-gray-600 hover:text-red-500 flex items-center justify-center transition" title="Retirer du planning">
                                    <i class="fa-solid fa-times text-xs"></i>
                            </button>
                        </div>`;
                }).join('');
            }

            // 2. SECTION "TERMINÉ" (Historique)
            if (historyItems.length > 0) {
                list.innerHTML += `<div class="text-[10px] font-bold text-green-400 uppercase tracking-widest mb-2 mt-4 pl-1 flex items-center gap-2"><i class="fa-solid fa-check-circle"></i> Terminé</div>`;
                
                list.innerHTML += historyItems.map(itemId => {
                    const course = rawItems.find(i => i.id === itemId);
                    if (!course) return '';
                    const config = matiereConfig[course.m] || defaultConfig;
                    
                    return `
                        <div class="bg-[#111] border border-green-500/20 p-3 rounded-xl flex items-center gap-3 hover:bg-green-500/5 transition cursor-default group">
                            
                            <div class="w-8 h-8 rounded-full bg-${config.color}-500/20 flex-shrink-0 flex items-center justify-center text-${config.color}-400 opacity-50 group-hover:opacity-100 transition-opacity">
                                <i class="fa-solid ${config.icon} text-xs"></i>
                            </div>
                            
                            <div class="flex-grow overflow-hidden opacity-60 group-hover:opacity-100 transition-opacity">
                                <div class="text-[10px] text-green-500 font-bold uppercase truncate decoration-green-500/50 line-through group-hover:no-underline">Item ${itemId}</div>
                                <div class="text-xs text-gray-400 font-medium truncate group-hover:text-white transition-colors">${course.t}</div>
                            </div>
                            
                            <button onclick="undoHistoryItem('${dateKey}', '${itemId}')" class="w-8 h-8 rounded-full hover:bg-white/10 text-green-600 hover:text-yellow-400 flex items-center justify-center transition opacity-0 group-hover:opacity-100" title="Annuler / Remettre à faire">
                                <i class="fa-solid fa-rotate-left text-xs"></i>
                            </button>

                        </div>
                    `;
                }).join('');
            }
}

/* --- LOGIQUE HUB XP --- */
function openXPModal() {
    const modal = document.getElementById('xpModal');
    const content = document.getElementById('xpModalContent');
    
    // 1. Remplissage des données
    const currentLvlXP = userXP % 1000; // XP dans le niveau actuel
    const percent = (currentLvlXP / 1000) * 100;
    
    document.getElementById('xpModalLevel').innerText = userLevel;
    document.getElementById('xpModalProgressText').innerText = `${Math.floor(currentLvlXP)} / 1000 XP`;
    document.getElementById('xpModalBar').style.width = `${percent}%`;
    document.getElementById('xpModalMissing').innerText = Math.floor(1000 - currentLvlXP);
    
    // Stats
    const totalLu = Object.values(userStatus).filter(s => s === 'lu' || s === 'maitrise').length;
    const totalMaitrise = Object.values(userStatus).filter(s => s === 'maitrise').length;
    document.getElementById('xpModalLu').innerText = totalLu;
    document.getElementById('xpModalMaitrise').innerText = totalMaitrise;
    
    // Prochaine récompense
    const nextLvl = userLevel + 1;
    let rewardIcon = "fa-question";
    let rewardText = "Récompense mystère...";
    
    // On cherche la prochaine récompense définie
    // On parcourt les niveaux supérieurs pour trouver le prochain avatar
    let found = false;
    for(let l = nextLvl; l <= 50; l++) {
        if (levelRewards[l]) {
            rewardIcon = levelRewards[l];
            rewardText = `Avatar débloqué au niveau ${l}`;
            found = true;
            break;
        }
    }
    
    if (found) {
        document.getElementById('nextRewardIcon').className = `fa-solid ${rewardIcon} text-blue-400 text-2xl animate-bounce`;
        document.getElementById('nextRewardText').innerText = rewardText;
    } else {
        // Si tout est débloqué
        document.getElementById('nextRewardIcon').className = "fa-solid fa-crown text-gold-500 text-2xl";
        document.getElementById('nextRewardText').innerText = "Niveau Légendaire atteint !";
    }

    // 2. Affichage
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        content.classList.remove('scale-95');
        content.classList.add('scale-100');
    }, 10);
    playSound('whoosh');
}

function closeXPModal() {
    const modal = document.getElementById('xpModal');
    const content = document.getElementById('xpModalContent');
    modal.classList.add('opacity-0');
    content.classList.remove('scale-100');
    content.classList.add('scale-95');
    setTimeout(() => modal.classList.add('hidden'), 300);
}

/* --- LOGIQUE HUB CHRONOS --- */
function openCountdownModal() {
    const modal = document.getElementById('chronoModal');
    const content = document.getElementById('chronoModalContent');
    const dateInput = document.getElementById('modalDateInput');
    
    // 1. Initialisation des dates
    const today = new Date();
    let targetDate;

    // Détermine le début de l'année universitaire (1er Septembre précédent)
    let startYear = today.getFullYear();
    if (today.getMonth() < 8) { // Si on est entre Janvier (0) et Août (7)
        startYear--; // L'année a commencé l'année civile d'avant
    }
    const academicStart = new Date(startYear, 8, 1); // 1er Septembre (Mois 8)

    // 2. Gestion de la Date Cible (Concours)
    if (userExamDate) {
        dateInput.value = userExamDate;
        targetDate = new Date(userExamDate);
    } else {
        // Par défaut : 15 Juin de l'année de fin académique
        targetDate = new Date(startYear + 1, 5, 15); 
        dateInput.value = ""; // On laisse vide pour inciter à remplir
    }

    // 3. Calcul des Jours Restants (Grand Compteur)
    const diffTime = targetDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    const chronoElement = document.getElementById('chronoDays');
    if (userExamDate) {
        chronoElement.innerText = diffDays > 0 ? diffDays : "0";
        chronoElement.className = diffDays < 30 ? "text-5xl font-display font-black text-red-500 animate-pulse" : "text-5xl font-display font-black text-white";
    } else {
        chronoElement.innerText = "---";
        chronoElement.className = "text-5xl font-display font-black text-gray-500";
    }

    // 4. Calcul de la Barre de Progression (TEMPS ÉCOULÉ)
    // Durée totale : Du 1er Septembre au Concours
    const totalDuration = targetDate - academicStart;
    // Durée écoulée : Du 1er Septembre à Aujourd'hui
    const elapsedDuration = today - academicStart;

    let pct = 0;
    if (totalDuration > 0) {
        pct = (elapsedDuration / totalDuration) * 100;
    }

    // Bornes (0% min, 100% max)
    if (pct < 0) pct = 0;
    if (pct > 100) pct = 100;

    // Mise à jour visuelle
    document.getElementById('timeProgressBar').style.width = `${pct}%`;
    document.getElementById('timeElapsedPct').innerText = `${Math.round(pct)}%`;

    // 5. Citation Motivation
    const quotes = [
        "Chaque minute compte.",
        "La douleur est temporaire, la fierté est éternelle.",
        "Ne regarde pas l'horloge, fais comme elle : avance.",
        "Ton futur toi te remerciera.",
        "Discipline = Liberté."
    ];
    document.getElementById('chronoQuote').innerText = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;

    // 6. Affichage Modale
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        content.classList.remove('scale-95');
        content.classList.add('scale-100');
    }, 10);
    playSound('whoosh');
}

function updateExamDateFromModal(newDate) {
    if(newDate) {
        userExamDate = newDate;
        updateCountdownDisplay(userExamDate);
        
        // Mise à jour aussi dans les settings globaux si ouverts
        const settingInput = document.getElementById('settingDate');
        if(settingInput) settingInput.value = newDate;
        
        // Sauvegarde
        saveData();
        
        // Rafraîchir la modale instantanément
        openCountdownModal();
        showToast("Objectif mis à jour !", "success");
    }
}

function closeChronoModal() {
    const modal = document.getElementById('chronoModal');
    const content = document.getElementById('chronoModalContent');
    modal.classList.add('opacity-0');
    content.classList.remove('scale-100');
    content.classList.add('scale-95');
    setTimeout(() => modal.classList.add('hidden'), 300);
}

        // --- FONCTIONS D'AJOUT / SUPPRESSION PLANNING ---

        function addPlanningItem(specificId = null) {
            const input = document.getElementById('calendarSearchInput');
            const list = document.getElementById('calendarAutocompleteList');
            
            // Soit on a un ID précis (clic liste), soit on prend ce qu'il y a dans le champ
            let val = specificId || input.value.trim();
            
            // Petit nettoyage si l'utilisateur a tapé du texte (on cherche un numéro)
            // Si ce n'est pas un ID direct, on essaye de trouver le numéro dans le texte
            if (!specificId && val) {
                const match = val.match(/(\d+)/); // Cherche le premier nombre
                if (match) val = match[1];
            }

            if (!val || !selectedCalendarDate) return;

            // Vérifier si l'item existe
            const item = rawItems.find(i => i.id === val);
            if (!item) {
                showToast("Item introuvable.", "error");
                return;
            }

            if (!userPlanning[selectedCalendarDate]) userPlanning[selectedCalendarDate] = [];
            
            // Éviter les doublons
            if (!userPlanning[selectedCalendarDate].includes(val)) {
                userPlanning[selectedCalendarDate].push(val);
                
                // Synchro avec Objectifs du Jour (si c'est aujourd'hui)
                const todayKey = new Date().toISOString().split('T')[0];
                if (selectedCalendarDate === todayKey) {
                    const alreadyInTodos = userTodos.some(t => t.linkedItemId === val);
                    if (!alreadyInTodos) {
                        userTodos.push({
                            text: `Item ${item.id} - ${item.t}`,
                            done: false,
                            id: Date.now(),
                            linkedItemId: val
                        });
                        renderTodos();
                    }
                }

                saveData();
                
                renderDayDetails(selectedCalendarDate);
                renderCalendar(); 
                
                playSound('success');
                showToast(`Item ${val} planifié !`, "success");
            }
            
            // Nettoyage interface
            input.value = '';
            if(list) list.classList.add('hidden');
            input.focus(); // On remet le focus pour enchaîner
        }

        function removePlanningItem(dateKey, index) {
    if (userPlanning[dateKey]) {
        // 1. On sauvegarde l'ID de l'item AVANT de le supprimer du tableau
        const itemIdToRemove = userPlanning[dateKey][index];

        // 2. Suppression du planning (Logique de base)
        userPlanning[dateKey].splice(index, 1);
        
        // Nettoyage si la journée est vide
        if (userPlanning[dateKey].length === 0) delete userPlanning[dateKey];
        
        // 3. --- SYNCHRO INVERSE (CALENDRIER -> OBJECTIFS) ---
        const todayKey = new Date().toISOString().split('T')[0];

        // Si on supprime un item de la date d'AUJOURD'HUI
        if (dateKey === todayKey && itemIdToRemove) {
            // On vérifie s'il existe dans la liste des To-Dos
            const todoExists = userTodos.some(t => t.linkedItemId === itemIdToRemove);
            
            if (todoExists) {
                // On le retire de la liste des objectifs
                userTodos = userTodos.filter(t => t.linkedItemId !== itemIdToRemove);
                
                // Mise à jour visuelle immédiate de la colonne de droite et de la grille
                renderTodos(); 
                render(); // Le bouton de la carte redevient gris (+)
            }
        }
        // ----------------------------------------------------
        
        saveData(); 
        
        // Mise à jour de l'affichage Calendrier
        renderDayDetails(dateKey);
        renderCalendar();
        
        playSound('click');
        showToast("Item retiré du planning.", "info");
    }
}

function undoHistoryItem(dateKey, itemId) {
    // 1. Retirer de l'historique du jour (Calendrier)
    if (userHistory[dateKey]) {
        userHistory[dateKey] = userHistory[dateKey].filter(id => id !== itemId);
        // Si le jour devient vide, on supprime la clé pour garder le fichier propre
        if (userHistory[dateKey].length === 0) delete userHistory[dateKey];
    }

    // 2. DÉCRÉMENTATION INTELLIGENTE (Retrait du point)
    if (userVues[itemId] && userVues[itemId] > 0) {
        userVues[itemId]--; // On retire 1 vue
        
        // A. Si on tombe à 0 vue -> On enlève le statut "Lu"
        if (userVues[itemId] === 0) {
            userStatus[itemId] = null;
        }
        // B. Si on tombe sous le seuil de maîtrise (6) -> On repasse en "Lu"
        else if (userVues[itemId] < 6 && userStatus[itemId] === 'maitrise') {
            userStatus[itemId] = 'lu';
        }
    }

    // --- CORRECTION : SYNCHRO AVEC LA TODO LIST ---
    const todayKey = new Date().toISOString().split('T')[0];
    
    // Si on annule une action sur la date d'AUJOURD'HUI
    if (dateKey === todayKey) {
        // On cherche l'item dans la liste des todos
        const todo = userTodos.find(t => t.linkedItemId === itemId);
        
        if (todo) {
            // Cas 1 : Il est là mais coché (barré) -> On le décoche
            todo.done = false;
        } else {
            // Cas 2 : Il n'est plus là (supprimé) -> On le recrée
            const itemInfo = rawItems.find(i => i.id === itemId);
            const title = itemInfo ? itemInfo.t : "Item " + itemId;
            
            userTodos.push({
                text: `Item ${itemId} - ${title}`,
                done: false, // On le met "À faire"
                id: Date.now(),
                linkedItemId: itemId
            });
        }
    }
    // ----------------------------------------------

    // 3. Sauvegarde
    saveData();

    // 4. Mises à jour visuelles
    renderDayDetails(dateKey); // Met à jour la liste à droite
    renderCalendar();          // Met à jour les points de couleur
    
    buildCourses();            
    updateStats();
    renderTodos(); // <--- IMPORTANT : Met à jour la liste latérale
    render();                  
    
    playSound('click');
    showToast(`Action annulée (Vue retirée : ${userVues[itemId] || 0})`, "info");
}

// --- LOGIQUE VUE DÉTAILLÉE ---
var currentItemId = null;

function openItemDetail(itemId) {
    currentItemId = itemId;
    const item = rawItems.find(i => i.id === itemId);
    if (!item) return;

    // 1. Ambiance Couleur (Immersion)
    updateGlobalGlow(item.m); 

    // 2. Gestion de l'affichage (Cache le dashboard, montre le détail)
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('calendarView').classList.add('hidden');
    const filterBar = document.getElementById('filterBar');
    if(filterBar) filterBar.classList.add('hidden');
    
    const detailView = document.getElementById('itemDetailView');
    detailView.classList.remove('hidden');
    
    playSound('whoosh');

    // 3. Remplissage des Infos & Design Matière
    
    // A. Le Cercle Numéro
    const numberContainer = document.getElementById('detailNumberContainer');
    const numberBg = document.getElementById('detailNumberBg');
    const numberText = document.getElementById('detailItemIdDisplay');
    
    if(numberText) numberText.innerText = item.id; // Juste le numéro

    // B. Textes
    document.getElementById('detailTitle').innerText = item.t;
    document.getElementById('detailMatiere').innerText = item.m;

    // --- GESTION DES COULEURS DYNAMIQUES ---
    const config = matiereConfig[item.m] || defaultConfig;
    
    // 1. Appliquer la couleur au Cercle
    if (numberContainer && numberBg) {
        numberContainer.style.borderColor = `rgba(${getMatiereColorValue(config.color)}, 0.5)`;
        numberContainer.style.boxShadow = `0 0 30px -5px rgba(${getMatiereColorValue(config.color)}, 0.2)`;
        numberBg.className = `absolute inset-0 opacity-20 bg-${config.color}-600 transition-colors duration-500`;
    }

// --- AJOUT : GESTION DE L'ICÔNE FANTÔME ---
    const ghostIcon = document.getElementById('detailNumberIconGhost');
    if(ghostIcon) {
        ghostIcon.className = `absolute z-10 fa-solid ${config.icon} text-${config.color}-400 text-5xl opacity-30 transform scale-110 rotate-[-10deg] blur-sm transition-all duration-500 ease-out group-hover:scale-125 group-hover:rotate-12 group-hover:opacity-50 group-hover:blur-0`;
    }

    // 2. Appliquer la couleur à la ligne Matière
    const matIcon = document.getElementById('detailMatiereIcon');
    const matText = document.getElementById('detailMatiere');
    
    if (matIcon && matText) {
        matIcon.className = `fa-solid ${config.icon} text-${config.color}-400 text-sm`;
        matText.className = `text-xs font-bold uppercase tracking-[0.15em] text-${config.color}-400`;

const badge = document.getElementById('detailMatiereBadge');
        if(badge) {
            badge.className = "flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity p-1 rounded-lg hover:bg-white/5";
            badge.onclick = () => jumpToMatiere(item.m);
            badge.title = "Voir tous les cours de " + item.m;
        }
    }
    
    // 4. Remplissage des Stats (Vues & Statut)
    const vues = userVues[itemId] || 0;
    document.getElementById('detailVues').innerText = vues;
    updateDetailStatusUI(itemId);

    // 5. Remplissage des Stats Concours & Difficulté R2C
    const freqEl = document.getElementById('detailFrequency');
    if(freqEl) freqEl.innerText = (item.f || 0) + " fois";

    const diffLabel = document.getElementById('detailOfficialDiff');
    const diffBg = document.getElementById('detailDiffIconBg');
    
    if(diffLabel && diffBg) {
        const diff = item.d || "Normale";
        diffLabel.innerText = diff;

        let diffColorClass = "bg-blue-500/20 text-blue-400"; // Défaut (Normale)
        
        if (diff.includes('Facile')) diffColorClass = "bg-green-500/20 text-green-400";
        else if (diff === 'Difficile') diffColorClass = "bg-orange-500/20 text-orange-400";
        else if (diff.includes('Très')) diffColorClass = "bg-red-500/20 text-red-400";
        
        diffBg.className = `w-10 h-10 rounded-full flex items-center justify-center ${diffColorClass}`;
    }

    // 6. Chargement des Données Utilisateur (Notes & Erreurs)
    document.getElementById('detailNotesArea').innerHTML = userItemNotes[itemId] || "";
    
    // Gestion rétroactive des erreurs (Tableau ou Texte)
    let errors = userItemErrors[itemId];
    // Si c'était du texte (ancienne version), on le garde, sinon on ne met rien pour l'instant
    // (L'interface Flashcard gère l'affichage via le bouton en bas)
    if(typeof errors === 'string') {
         // On ne fait rien ici, la modale gérera l'affichage
    }

    // 7. Génération du sélecteur de difficulté perso (Étoiles)
    renderDifficultySelector(itemId);

    // 8. GÉNÉRATION DES RESSOURCES (C'était la ligne manquante !)
    renderDetailResources(itemId);

    // 9. Mise à jour du bouton "Boîte à erreurs" (Compteur)
    updateErrorButtonLabel();

    // 10. GÉNÉRATION DE LA GALERIE (Nouveau)
          renderItemGallery(itemId);
}

function closeItemDetail() {
    document.getElementById('itemDetailView').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('hidden');
    document.getElementById('filterBar').classList.remove('hidden');
    playSound('whoosh');
    currentItemId = null;

// On regarde ce qui est sélectionné dans le filtre en haut
    const currentFilter = document.getElementById('matiereFilter').value;
    
    // Si "Toutes", on met "Général" (neutre), sinon on remet la couleur de la matière filtrée
    updateGlobalGlow(currentFilter === 'all' ? 'Général' : currentFilter);

    render(); // Rafraîchir la grille principale au cas où (statut modifié)
}

// -- Gestion des Notes --
document.getElementById('detailNotesArea').addEventListener('input', (e) => {
    if(!currentItemId) return;
    userItemNotes[currentItemId] = e.target.value;
    saveData(); // Sauvegarde globale (inclut les notes)
    
    // Indicateur visuel
    const ind = document.getElementById('noteSaveIndicator');
    ind.style.opacity = '1';
    setTimeout(() => ind.style.opacity = '0', 1000);
});

// -- Gestion Difficulté --
function setDifficulty(level) {
    if(!currentItemId) return;
    userItemDifficulty[currentItemId] = level;
    saveData();
    renderDifficultySelector(currentItemId);
    playSound('click');
}

// -- Gestion Ressources (Liste) --
function renderDetailResources(itemId) {
    const list = document.getElementById('detailResourcesList');
    
    // Tous les types possibles
    const types = [
        { id: 'video', label: 'Vidéos', icon: 'fa-video', color: 'red' },
        { id: 'audio', label: 'Audios', icon: 'fa-headphones', color: 'yellow' },
        { id: 'flash', label: 'Flashcards', icon: 'fa-bolt', color: 'purple' },
        { id: 'fiche', label: 'Fiches', icon: 'fa-file-pdf', color: 'blue' }
    ];

    list.innerHTML = types.map(t => {
        // On compte combien de ressources de ce type existent pour cet item
        const resourcesOfType = userResources.filter(r => r.itemId === itemId && r.type === t.id);
        const count = resourcesOfType.length;
        
        if (count > 0) {
            // --- RESSOURCES DISPONIBLES : OUVERTURE DE LA LISTE ---
            return `
            <div class="flex items-stretch gap-3 group animate-fade-in-up">
                <button onclick="openResourceListModal('${itemId}', '${t.id}')" 
                        class="flex-grow relative overflow-hidden bg-white/[0.03] backdrop-blur-md border border-white/10 hover:border-${t.color}-500/50 hover:bg-${t.color}-500/10 p-3 rounded-2xl flex items-center justify-between transition-all duration-300 group/btn hover:shadow-lg hover:shadow-${t.color}-900/20 text-left">
                    
                    <div class="absolute inset-0 bg-gradient-to-r from-${t.color}-500/0 via-${t.color}-500/5 to-${t.color}-500/0 opacity-0 group-hover/btn:opacity-100 transition-opacity duration-500 pointer-events-none"></div>

                    <div class="flex items-center gap-4 relative z-10">
                        <div class="w-12 h-12 rounded-xl bg-${t.color}-500/10 flex items-center justify-center text-${t.color}-400 border border-${t.color}-500/20 shadow-inner group-hover/btn:scale-110 transition-transform duration-300">
                            <i class="fa-solid ${t.icon} text-xl drop-shadow-md"></i>
                        </div>
                        
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-200 font-bold group-hover/btn:text-white transition-colors">${t.label}</span>
                            <span class="text-[10px] text-${t.color}-400/70 font-mono uppercase tracking-wider font-bold">
                                ${count} Ressource${count > 1 ? 's' : ''}
                            </span>
                        </div>
                    </div>
                    
                    <div class="w-10 h-10 rounded-full border border-white/10 bg-white/5 flex items-center justify-center text-gray-400 group-hover/btn:bg-${t.color}-500 group-hover/btn:text-black group-hover/btn:border-${t.color}-400 transition-all duration-300 relative z-10 shadow-lg">
                        <i class="fa-solid fa-list-ul text-xs"></i>
                    </div>
                </button>
            </div>`;
        } else {
            // --- AUCUNE RESSOURCE : BOUTON AJOUT ---
            return `
            <button onclick="openModalForItem('${itemId}', '${t.id}')" 
                    class="w-full bg-white/[0.01] border border-white/5 border-dashed p-3 rounded-2xl flex items-center justify-between text-gray-600 hover:text-gray-300 hover:bg-white/[0.03] hover:border-white/20 transition-all duration-300 group animate-fade-in-up">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-white/[0.02] flex items-center justify-center text-gray-700 border border-white/5 group-hover:border-white/10 group-hover:text-gray-500 transition-colors">
                        <i class="fa-solid ${t.icon} text-xl"></i>
                    </div>
                    <div class="flex flex-col items-start">
                        <span class="text-sm font-medium italic opacity-60 group-hover:opacity-100 transition-opacity">Ajouter ${t.label}...</span>
                    </div>
                </div>
                <div class="w-10 h-10 flex items-center justify-center opacity-30 group-hover:opacity-100 transition-opacity">
                    <i class="fa-solid fa-plus"></i>
                </div>
            </button>`;
        }
    }).join('');
}

// -- Gestion Statut depuis la vue détaillée --01:36 26/11/2025
function toggleStatusFromDetail() {
    if(!currentItemId) return;
    
    // On cycle : Rien -> Lu -> Maîtrisé -> Rien
    const current = userStatus[currentItemId];
    let next = 'lu';
    if (current === 'lu') next = 'maitrise';
    else if (current === 'maitrise') next = null;
    
    toggleStatus(currentItemId, next); // Utilise la fonction globale existante
    updateDetailStatusUI(currentItemId);
}

function updateDetailStatusUI(itemId) {
    const status = userStatus[itemId];
    const icon = document.getElementById('detailStatusIcon');
    const bg = document.getElementById('detailStatusIconBg');
    const text = document.getElementById('detailStatusText');
    
    if (status === 'maitrise') {
        bg.className = "w-10 h-10 rounded-full bg-yellow-500 text-black flex items-center justify-center shadow-[0_0_15px_rgba(234,179,8,0.5)]";
        icon.className = "fa-solid fa-trophy";
        text.innerText = "Maîtrisé";
        text.className = "text-sm font-bold text-yellow-400";
    } else if (status === 'lu') {
        bg.className = "w-10 h-10 rounded-full bg-green-500 text-black flex items-center justify-center shadow-[0_0_15px_rgba(34,197,94,0.5)]";
        icon.className = "fa-solid fa-check";
        text.innerText = "Lu";
        text.className = "text-sm font-bold text-green-400";
    } else {
        bg.className = "w-10 h-10 rounded-full bg-gray-800 text-gray-500 flex items-center justify-center";
        icon.className = "fa-solid fa-circle";
        text.innerText = "Non lu";
        text.className = "text-sm font-bold text-gray-500";
    }
}

// --- FONCTION DE NAVIGATION RAPIDE PAR MATIÈRE ---
function jumpToMatiere(matiere) {
    // 1. Fermeture de la vue détaillée et réinitialisation de la recherche
    document.getElementById('itemDetailView').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('hidden');
    document.getElementById('filterBar').classList.remove('hidden');
    
    document.getElementById('searchInput').value = ''; // On vide la recherche

    // 2. Lancer la mise à jour (handleFilterChange n'inclut PAS de scroll)
    const filterSelect = document.getElementById('matiereFilter');
    filterSelect.value = matiere;
    handleFilterChange(filterSelect); 

    // 3. Déclenchement de l'ancrage stable
    // C'est ce qui centre l'affichage sur la barre de recherche
    anchorToFilterBar(); 
    
    playSound('subjectClick');
}

/* --- GESTION GALERIE IMAGES --- */

// 1. Déclenché à l'ouverture de l'Item
function renderItemGallery(itemId) {
    const grid = document.getElementById('itemGalleryGrid');
    const empty = document.getElementById('emptyGalleryState');
    
    if (!grid) return;

    const images = userItemImages[itemId] || [];
    grid.innerHTML = '';

    if (images.length === 0) {
        empty.classList.remove('hidden');
    } else {
        empty.classList.add('hidden');
        
        images.forEach((imgData, index) => {
            // Création de l'élément wrapper
            const div = document.createElement('div');
            
            // Classes clés pour le Masonry : 'break-inside-avoid' empêche l'image d'être coupée entre deux colonnes
            div.className = "break-inside-avoid relative group rounded-xl overflow-hidden border border-white/10 bg-black/40 hover:border-fuchsia-500/50 transition-all duration-300 mb-4 shadow-lg hover:shadow-purple-900/20";
            
            // Le HTML interne
            div.innerHTML = `
                <div class="relative cursor-zoom-in" onclick="openLightbox('${imgData}')">
                    <img src="${imgData}" class="w-full h-auto object-contain opacity-90 group-hover:opacity-100 transition-opacity duration-300" loading="lazy">
                    
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-3">
                    </div>
                </div>
                
                <button onclick="deleteItemImage(${index})" class="absolute top-2 right-2 w-8 h-8 rounded-lg bg-black/60 hover:bg-red-500 text-white/80 hover:text-white backdrop-blur-md flex items-center justify-center shadow-lg transition-all transform scale-0 group-hover:scale-100 z-10 border border-white/10">
                    <i class="fa-solid fa-trash-can text-xs"></i>
                </button>
            `;
            grid.appendChild(div);
        });
    }
}

// 2. Gestion de l'Upload avec Compression (Indispensable pour Firestore/LocalStorage)
async function handleImageUpload(input) {
    if (!currentItemId || !input.files || input.files.length === 0) return;

    const files = Array.from(input.files);
    let processedCount = 0;
    
    // Feedback immédiat
    const btn = input.parentElement.querySelector('div');
    const oldHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i><span>Traitement...</span>`;

    for (const file of files) {
        try {
            const compressedBase64 = await compressImage(file);
            if (!userItemImages[currentItemId]) userItemImages[currentItemId] = [];
            userItemImages[currentItemId].push(compressedBase64);
            processedCount++;
        } catch (e) {
            console.error("Erreur compression:", e);
        }
    }

    if (processedCount > 0) {
        saveData();
        renderItemGallery(currentItemId);
        playSound('success');
        showToast(`${processedCount} image(s) ajoutée(s)`, "success");
    }
    
    // Reset UI
    input.value = ''; 
    btn.innerHTML = oldHtml;
}

// 3. Utilitaire de compression (Redimensionne à max 1000px et convertit en JPEG 0.7)
function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                
                // MODIFICATION 1 : Augmenter la largeur max (de 1200 à 1920px pour du Full HD)
                const MAX_WIDTH = 1920; 
                const scaleSize = MAX_WIDTH / img.width;
                
                // On garde les proportions exactes
                canvas.width = scaleSize < 1 ? MAX_WIDTH : img.width;
                canvas.height = scaleSize < 1 ? img.height * scaleSize : img.height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // MODIFICATION 2 : Qualité JPEG passée de 0.75 à 0.92 (Très haute qualité)
                resolve(canvas.toDataURL('image/jpeg', 0.92)); 
            };
            img.onerror = (err) => reject(err);
        };
        reader.onerror = (err) => reject(err);
    });
}

// 4. Suppression
function deleteItemImage(index) {
    openConfirmModal(() => {
        if (userItemImages[currentItemId]) {
            userItemImages[currentItemId].splice(index, 1);
            saveData();
            
            renderItemGallery(currentItemId); // Rafraîchir la galerie
            
            playSound('error'); // Petit son de suppression (comme pour les ressources)
            showToast("Image supprimée de la galerie", "info");
        }
    });
}

// 5. Lightbox
function openLightbox(src) {
    const modal = document.getElementById('imageLightbox');
    const img = document.getElementById('lightboxImg');
    
    img.src = src;
    modal.classList.remove('hidden');
    
    // Petite animation d'entrée
    requestAnimationFrame(() => {
        modal.classList.remove('opacity-0');
        img.classList.remove('scale-95');
        img.classList.add('scale-100');
    });
}

function closeLightbox() {
    const modal = document.getElementById('imageLightbox');
    const img = document.getElementById('lightboxImg');
    
    modal.classList.add('opacity-0');
    img.classList.remove('scale-100');
    img.classList.add('scale-95');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        img.src = '';
    }, 300);
}

initApp();
    </script>
</body>
</html>
